###############
## Data prep ##
###############
```{r}
##Check if the packages we need are installed, and if not, install them
packages<-c('dplyr', 'tidyr', 'data.table', 'R.matlab', 'ggplot2', 'lme4')
if(length(setdiff(packages, rownames(installed.packages())))>0) {
  install.packages(setdiff(packages, rownames(installed.packages())))
}
lapply(packages, library, character.only=TRUE)

##Set paths (data is located on CAS)
tds_folder<-'/Volumes/psy-ctn/psy-ctn/TDS/behavior/'
ylg_folder<-paste(tds_folder, 'YLG/processed/', sep='')
demo_folder<-paste(tds_folder, 'Redcap/', sep='')
qualtrics_folder<-paste(tds_folder, 'Qualtrics/', sep='')

##Collect data
ylg_data<-read.csv(paste(ylg_folder,'tds_trial_by_trial_20180124.csv',sep=''))
demo_data<-read.csv(paste(demo_folder,'age_gender_iq_2019.csv',sep=''))
qualtrics_data_post<-read.csv(paste(qualtrics_folder, 'scoring_script_output/tds1-wave1-PDS.csv', sep='')) %>% select(scores.SID, scores.female_comparison, scores.female_height_feet, scores.female_height_inches, scores.female_mean_score, scores.female_menses, scores.female_weight, scores.female_weight_text, scores.male_comparison, scores.male_height_feet, scores.male_height_feet_text, scores.male_height_inches, scores.male_height_inches_text, scores.male_mean_score, scores.male_weight, scores.male_weight_text, scores.pds_gender)
```
############################
## Demographics TDS 1 N=69##
############################

```{r}

# add rows for PRE
PDS_pre <- data.frame("scores.SID" = c(301, 302, 303, 304, 305, 306, 307, 308, 309, 310, 311, 312, 314, 315, 316, 317, 318, 319, 320)) 

qualtrics_data<-full_join(PDS_pre, qualtrics_data_post)
#change names to be easier to read later
names(demo_data) <- c("scores.SID", "s2_age", "gender", "s2_iq", "wave2_yn", "s3_age", "s3_iq")
## Merge qualtrics and demo data
demo <- merge(demo_data, qualtrics_data, by.x = 'scores.SID', by.y = 'scores.SID')
## Add variables
demo <- demo %>%
  mutate(age_group = ifelse(s2_age < 14.0, 1, 2)) %>% # age groups based on median split
  mutate(age_c = s2_age-14.1, age_rnd = floor(s2_age), age_sq = age_c^2) %>%   # age variables
  mutate(iq_c = s2_iq-100, iq_z = iq_c/15) %>%                   # iq variables
  mutate(PDS_mean_score=ifelse(                               # pds variables
    is.na(scores.female_mean_score)==TRUE, scores.male_mean_score, scores.female_mean_score)) %>%
  mutate(PDS_stage = ceiling(PDS_mean_score), pds_group = ifelse(PDS_mean_score < 2.9, 1, 2)) %>%
  mutate(gender_flip = ifelse(gender==0, 'Male', 'Female'))   # flip gender for correct colors in graph

## Filter demo_data (N=69, but only 53 with PDS data)
no_session2 = c(311, 338, 358)
behaviorals = c(305, 318, 319)
ylg_failed = c(339, 345)
missing_stops = c(350, 356, 366, 370)

demo_filtered_context <- demo %>% filter(scores.SID > 300) %>% 
  filter(!scores.SID %in% no_session2) %>% 
  filter(!scores.SID %in% behaviorals) %>% 
  filter(!scores.SID %in% ylg_failed)


age<-demo_filtered_context %>% filter(!is.na(s2_age)) %>%
  summarize(mean = mean(s2_age, na.rm=T), sd = sd(s2_age, na.rm=T), 
            min = min(s2_age, na.rm=T), max = max(s2_age, na.rm=T),
            n = n(), se = sd/sqrt(n), ci=qt(0.975, df=n-1)*se) # n=29 females 40 males
t.test(demo_filtered_context$s2_age~demo_filtered_context$gender) 


iq<-demo_filtered_context %>% filter(!is.na(s2_iq)) %>% 
  summarize(mean = mean(s2_iq, na.rm=T), sd = sd(s2_iq, na.rm=T), 
            min = min(s2_iq, na.rm=T), max = max(s2_iq, na.rm=T),
            n = n(), se = sd/sqrt(n), ci=qt(0.975, df=n-1)*se) # n=29 females 38 males
t.test(demo_filtered_context$s2_iq~demo_filtered_context$gender) 


pds<-demo_filtered_context %>% filter(!is.na(PDS_mean_score)) %>%  
  summarize(mean = mean(PDS_mean_score, na.rm=T), sd = sd(PDS_mean_score, na.rm=T),
            min = min(PDS_mean_score, na.rm=T), max = max(PDS_mean_score, na.rm=T),
            n = n(), se = sd/sqrt(n), ci=qt(0.975, df=n-1)*se) # n=21 females 32 males
t.test(demo_filtered_context$PDS_mean_score~demo_filtered_context$gender) 


```

############################
## Demographics TDS 2 N=70##
############################


```{r}
# Load data

qualtrics_data_TDS2<-read.csv(paste(qualtrics_folder, 'scoring_script_output/tds2-wave1-PDS.csv', sep='')) %>%  
  select(scores.SID, scores.female_comparison, scores.female_height, scores.female_mean_score, scores.female_menses, scores.female_weight, scores.male_comparison, scores.male_height, scores.male_mean_score, scores.male_weight, scores.pds_gender)  

#change names to be easier to read later
names(demo_data) <- c("scores.SID", "s2_age", "gender", "s2_iq", "wave2_yn", "s3_age", "s3_iq")

# filter
no_session2 = c(118, 123, 147, 148, 149, 153, 154, 166, 180)
behaviorals = c(103, 107, 112, 138, 143, 176, 191)
pilot_cyberball = c(101, 102, 104, 105, 106, 108, 110, 111)
motion_dropout = c(189, 158, 139)

demo_data_TDS2<-demo_data%>% filter(scores.SID < 300) %>% 
  filter(!scores.SID %in% no_session2) %>% 
  filter(!scores.SID %in% behaviorals) %>%
  filter(!scores.SID %in% pilot_cyberball) %>%
  filter(!scores.SID %in% motion_dropout)

## Merge qualtrics and demo data
demo_TDS2 <- merge(demo_data_TDS2, qualtrics_data_TDS2, by.x = 'scores.SID', by.y = 'scores.SID')

## Add variables

demo_TDS2 <- demo_TDS2 %>%
  mutate(age_group = ifelse(s2_age < 14.0, 1, 2)) %>% # age groups based on median split
  mutate(age_c = s2_age-14.1, age_rnd = floor(s2_age), age_sq = age_c^2) %>%   # age variables
  mutate(iq_c = s2_iq-100, iq_z = iq_c/15) %>%                   # iq variables
  mutate(PDS_mean_score=ifelse(                               # pds variables
    is.na(scores.female_mean_score)==TRUE, scores.male_mean_score, scores.female_mean_score)) %>%
  mutate(PDS_stage = ceiling(PDS_mean_score), pds_group = ifelse(PDS_mean_score < 2.9, 1, 2)) %>%
  mutate(gender_flip = ifelse(gender==0, 'Male', 'Female'))   # flip gender for correct colors in graph

TDS2_age<-demo_TDS2 %>% filter(!is.na(s2_age)) %>% 
  summarize(mean = mean(s2_age, na.rm=T), sd = sd(s2_age, na.rm=T), 
            min = min(s2_age, na.rm=T), max = max(s2_age, na.rm=T),
            n = n(), se = sd/sqrt(n), ci=qt(0.975, df=n-1)*se) 


TDS2_iq<-demo_TDS2 %>% filter(!is.na(s2_iq)) %>% 
  summarize(mean = mean(s2_iq, na.rm=T), sd = sd(s2_iq, na.rm=T), 
            min = min(s2_iq, na.rm=T), max = max(s2_iq, na.rm=T),
            n = n(), se = sd/sqrt(n), ci=qt(0.975, df=n-1)*se)


TDS2<-demo_TDS2 %>% filter(!is.na(PDS_mean_score)) %>% 
  summarize(mean = mean(PDS_mean_score, na.rm=T), sd = sd(PDS_mean_score, na.rm=T),
            min = min(PDS_mean_score, na.rm=T), max = max(PDS_mean_score, na.rm=T),
            n = n(), se = sd/sqrt(n), ci=qt(0.975, df=n-1)*se)


# compare between TDS I and TDS II

t.test(demo_filtered_context$s2_age, demo_TDS2$s2_age) 

# t = -0.12783, df = 135.16, p-value = 0.8985
# alternative hypothesis: true difference in means is not equal to 0
# 95 percent confidence interval:
#   -0.5760935  0.5061432
# sample estimates:
#   mean of x mean of y 
# 14.10174  14.13671 

t.test(demo_filtered_context$s2_iq, demo_TDS2$s2_iq)

# t = -3.6377, df = 131.87, p-value = 0.0003935
# alternative hypothesis: true difference in means is not equal to 0
# 95 percent confidence interval:
#   -11.87694  -3.50984
# sample estimates:
#   mean of x mean of y 
# 99.8209  107.5143

t.test(demo_filtered_context$PDS_mean_score, demo_TDS2$PDS_mean_score) 

# t = -0.90112, df = 110.37, p-value = 0.3695
# alternative hypothesis: true difference in means is not equal to 0
# 95 percent confidence interval:
#   -0.3800670  0.1424606
# sample estimates:
#   mean of x mean of y 
# 2.716981  2.835784 
```
############################
## Chi Square             ##
############################

```{r} 

# add group label

demo_filtered_context$group=0
demo_TDS2$group = 1
# combine groups
chisq.data<- rbind(select(demo_filtered_context, scores.SID, group, gender), select(demo_TDS2, scores.SID, group, gender))
# make table
chisq_table<-table(chisq.data$group, chisq.data$gender)
chisq.test(chisq_table)

# data:  chisq_table
# X-squared = 1.2284, df = 1, p-value = 0.2677

PDS_mean_scores <- demo_filtered_context %>% distinct(scores.SID, gender, scores.pds_gender, PDS_mean_score) %>% filter(!grepl("338|358|339|345", scores.SID)) 
write.csv(PDS_mean_scores, file = 'tds1_PDS_mean_score_n69.csv')

```

############################
## Supplemental Tables   ##
############################

```{r}

TDS1_age_by_sex<-demo_filtered_context %>% filter(!is.na(s2_age)) %>% group_by(gender)%>%
  summarize(mean = mean(s2_age, na.rm=T), sd = sd(s2_age, na.rm=T), 
            min = min(s2_age, na.rm=T), max = max(s2_age, na.rm=T),
            n = n(), se = sd/sqrt(n), ci=qt(0.975, df=n-1)*se) 
t.test(demo_filtered_context$s2_age~demo_filtered_context$gender) 

# t = -1.3229, df = 53.951, p-value = 0.1915
# alternative hypothesis: true difference in means is not equal to 0
# 95 percent confidence interval:
#  -1.4034873  0.2876425
# sample estimates:
# mean in group 0 mean in group 1 
#        13.86725        14.42517 

TDS1_iq_by_sex<-demo_filtered_context %>% filter(!is.na(s2_iq)) %>% group_by(gender) %>%
  summarize(mean = mean(s2_iq, na.rm=T), sd = sd(s2_iq, na.rm=T), 
            min = min(s2_iq, na.rm=T), max = max(s2_iq, na.rm=T),
            n = n(), se = sd/sqrt(n), ci=qt(0.975, df=n-1)*se)
t.test(demo_filtered_context$s2_iq~demo_filtered_context$gender) 

# t = -0.27452, df = 49.725, p-value = 0.7848
# alternative hypothesis: true difference in means is not equal to 0
# 95 percent confidence interval:
#  -7.683712  5.836162
# sample estimates:
# mean in group 0 mean in group 1 
#        99.42105       100.34483 

TDS1_pds_by_sex<-demo_filtered_context %>% filter(!is.na(PDS_mean_score)) %>% group_by(gender) %>%
  summarize(mean = mean(PDS_mean_score, na.rm=T), sd = sd(PDS_mean_score, na.rm=T),
            min = min(PDS_mean_score, na.rm=T), max = max(PDS_mean_score, na.rm=T),
            n = n(), se = sd/sqrt(n), ci=qt(0.975, df=n-1)*se)
t.test(demo_filtered_context$PDS_mean_score~demo_filtered_context$gender) 

# t = -2.5333, df = 40.516, p-value = 0.01527
# alternative hypothesis: true difference in means is not equal to 0
# 95 percent confidence interval:
#  -0.8992840 -0.1013113
# sample estimates:
# mean in group 0 mean in group 1 
#        2.518750        3.019048 

```


#############################
## SUPPLEMENTARY FIGURE S1 ##
#############################

```{r}
# Part A: Gender by age distribution
fig_s1a <- ggplot(demo_filtered_context, aes(x = age_rnd, fill = gender_flip)) +
  geom_bar(position = 'dodge') +
  #facet_grid(.~tds_group, scales='free', labeller=as_labeller(group_labels)) +
  labs(x='Age', y='Number of participants', fill='Sex') +
  coord_cartesian(x=c(10.5,17.5)) + theme(text = element_text(size=16)) +
  scale_y_continuous(breaks = c(0, 2, 4, 6, 8, 10)) + scale_x_continuous(breaks = 11:17) 
ggsave('fig_s1a.png', fig_s1a)

# Part B: Gender by pubertal stage distribution
fig_s1b <- ggplot(demo_filtered_context, aes(x = PDS_stage, fill = gender_flip)) +
  geom_bar(position = 'dodge') +
  #facet_grid(.~tds_group, scales='free', labeller=as_labeller(group_labels)) +
  labs(x='Mean PDS score', y='Number of participants', fill='Sex') +
  theme(text = element_text(size=16)) +
  scale_y_continuous(breaks = c(0, 4, 8, 12, 16, 20, 24, 28)) + scale_x_continuous(breaks = c(1, 2, 3, 4))
ggsave('fig_s1b.png', fig_s1b)
```
##################
## YLG behavior ##
##################
```{r}
# Add variables

ylg = ylg_data %>% 
  mutate(condition = ifelse(grepl('1|2', run_index), 1,
                     ifelse(grepl('3|4', run_index), 2,
                     ifelse(grepl('5|6', run_index), 3, 
                     ifelse(grepl('7|8', run_index), 4, NA))))) %>%
  mutate(time=run_time_ms/60000) %>%
  mutate(go = ifelse(decision=='GO', 1, 0)) %>%
  mutate(crash = ifelse(scenario=='CRASH', 1, 0)) %>%
  mutate(go_cr = ifelse(decision=='GO' & scenario=='CRASH', 1, 0)) %>%
  mutate(stop = ifelse(decision=='STOP', 1, 0)) %>%
  mutate(stop_nocar = ifelse(decision=='STOP' & scenario=='SAFE', 1, 0)) %>%
  mutate(event = ifelse(decision=='GO' & scenario=='SAFE', 1,
                 ifelse(decision=='GO' & scenario=='CRASH', 2,
                 ifelse(decision=='STOP' & scenario=='CROSSCAR', 3,
                 ifelse(decision=='STOP' & scenario=='SAFE', 4, NA))))) %>%
  mutate(count1 = ifelse(event==1, 1, 0)) %>%
  mutate(count2 = ifelse(event==2, 1, 0)) %>%
  mutate(count3 = ifelse(event==3, 1, 0)) %>%
  mutate(count4 = ifelse(event==4, 1, 0))

ylg$SID <- ylg$subject_name

# Check if events are present for all subjects
events_by_sid <- ylg %>% group_by(subject_name, condition) %>%
  summarize(n_good.go = sum(count1, na.rm=TRUE),
            n_bad.go = sum(count2, na.rm=TRUE),
            n_good.stop = sum(count3, na.rm=TRUE),
            n_bad.stop = sum(count4, na.rm=TRUE))

# Convert to factors
ylg$run_index <- as.factor(ylg$run_index)
ylg$condition <- as.factor(ylg$condition)

# Filter out subjects for imaging results (N=66)
# 201-299 = TDS-2
# 401-499 = TDS-3
# >500 = YADS
# no_session2 = c(311, 338, 358)
# behaviorals = c(305, 318, 319)

exclude = c(311, 338, 358, 305, 318, 319,
            401, 402, 403, 404, 405, 406, 407, 408, 409, 410, 411)
ylg_filtered = ylg %>% filter(subject_name > 300) %>% 
  filter(!subject_name %in% exclude)
count_trials_per_sub<-ylg_filtered %>% group_by(subject_name) %>% summarize(n()) 
# 315 only has 120 trials (practice runs missing) 
# 344 only has 120 trials (practice runs missing) 
# 377 only has 120 trials (practice runs missing) 

# Set labels
condition_labels = c(`1`='Mock', `2`='Alone', `3`='Peer Incl', `4`='Peer Excl')

colnames(ylg_filtered)[which(names(ylg_filtered) == "subject_name")] <- "scores.SID"

# Dataset for behavioral analyses (incomplete and complete runs)
df_all <- merge(demo_filtered_context, ylg_filtered, by = 'scores.SID')
df_all <- mutate(df_all, Group = 1)
  

missing_stops = c(350, 356, 366, 370)

# Dataset for behavioral analyses (only complete runs)
df_all_stops<- df_all %>% filter(scores.SID > 300) %>% 
  filter(!scores.SID %in% no_session2) %>% 
  filter(!scores.SID %in% behaviorals)%>%
  filter(!scores.SID %in% ylg_failed) %>% 
  filter(!scores.SID %in% missing_stops) 
# Set as factors for all data (incomplete and complete runs)
df_all$gender <- as.factor(df_all$gender)
df_all$gender_flip <- as.factor(df_all$gender_flip)
# Set as factors for all data (only complete runs)
df_all_stops$gender <- as.factor(df_all_stops$gender)
df_all_stops$gender_flip <- as.factor(df_all_stops$gender_flip)

countTDS1<-df_all %>% group_by(scores.SID, gender) %>% summarize(n()) 


```
#############################################
## Social Context effects on GO DECISIONS ##
#Do CWI teens engage in more Go decisions in social contexts? (no)#
###########################################
```{r}

#to compare within scanner social contexts
df_fMRI_all_stops <- df_all_stops %>% filter(condition != "1")

df_fMRI_all<-df_all %>% filter(condition != "1")

# Remove columns that are not congruent between TDS 1 and TDS 2

df_fMRI_all$scores.female_height_feet = NULL
df_fMRI_all$scores.female_height_inches = NULL
df_fMRI_all$scores.female_height_feet_text = NULL
df_fMRI_all$scores.female_weight_text = NULL
df_fMRI_all$scores.female_weight = NULL
df_fMRI_all$scores.male_height_feet = NULL
df_fMRI_all$scores.male_height_inches = NULL
df_fMRI_all$scores.male_weight_text = NULL
df_fMRI_all$scores.male_weight = NULL
df_fMRI_all$scores.male_height_feet_text = NULL
df_fMRI_all$scores.male_height_inches_text = NULL

# Run effects on the proportion of Go decisions
#changed this to "df_fMRI_all" since not looking at stops here, so can use bigger sample :) 
null.model <- glmer(go ~ (1|scores.SID), data=df_fMRI_all, family='binomial')
run.model <- glmer(go ~ run_index + (1|scores.SID), data=df_fMRI_all, family='binomial')
anova(null.model, run.model)     
#            Df   AIC   BIC  logLik deviance Chisq Chi Df Pr(>Chisq)
# null.model  2 10274 10288 -5134.8    10270                        
# run.model   7 10276 10326 -5131.2    10262 7.162      5     0.2089

#I pick which one to show summary for based on which is sig-- so here I would do summary of null model
summary(null.model) 
#  scores.SID (Intercept) 0.6281   0.7925  
# Number of obs: 8180, groups:  scores.SID, 69
# 
# Fixed effects:
#             Estimate Std. Error z value Pr(>|z|)    
# (Intercept) -0.57876    0.09893   -5.85 4.91e-09 ***  

#CWI teens did not take sig more go risks across social runs.

# Condition effects on the proportion of Go decisions
null.model <- glmer(go ~ (1|scores.SID), data=df_fMRI_all, family='binomial')
condition.model <- glmer(go ~ condition + (1|scores.SID), data=df_fMRI_all, family='binomial')
anova(null.model, condition.model)  
#                 Df   AIC   BIC  logLik deviance  Chisq Chi Df Pr(>Chisq)    
# null.model       2 10274 10288 -5134.8    10270                         
# condition.model  4 10274 10302 -5132.8    10266 4.0031      2     0.1351
summary(condition.model)  
#  Fixed effects:
#             Estimate Std. Error z value Pr(>|z|)    
# (Intercept) -0.60673    0.10446  -5.808 6.32e-09 ***
# condition3   0.09396    0.05788   1.623    0.105    
# condition4  -0.01289    0.05898  -0.219    0.827 

#CWI teens did not take sig more go risks across social conditions.

social_df <- df_fMRI_all %>% filter(condition != "2")
null.model <- glmer(go ~ (1|scores.SID), data=social_df, family='binomial')
condition.model <- glmer(go ~ condition + (1|scores.SID), data=social_df, family='binomial')
anova(null.model, condition.model)  
#                Df    AIC    BIC  logLik deviance Chisq Chi Df Pr(>Chisq)    
# (Intercept) -0.50580    0.10248  -4.935    8e-07 ***
# condition4  -0.10851    0.05904  -1.838   0.0661 .  
summary(condition.model) 
# Fixed effects:
#             Estimate Std. Error z value Pr(>|z|)    
# (Intercept) -0.50580    0.10248  -4.935    8e-07 ***
# condition4  -0.10851    0.05904  -1.838   0.0661 . 

#no sig difference between social runs-- which is expected given we didn't see diff above for social.
```

#################################################
## Social Context effects on CRASHES (BAD GO) ##
#Do CWI teens engage in more maladaptive go decisions in social contexts? (no)#
################################################
```{r}
# Run effects on the proportion of Go decisions that resulted in Crashes
null.model <- glmer(go_cr ~ (1|scores.SID), data=df_fMRI_all, family='binomial')
run.model <- glmer(go_cr ~ run_index + (1|scores.SID), data=df_fMRI_all, family='binomial', control=glmerControl(optimizer="bobyqa"))
anova(null.model, run.model) 
#            Df    AIC    BIC  logLik deviance  Chisq Chi Df Pr(>Chisq)
# null.model  2 7861.5 7875.5 -3928.7   7857.5                         
# run.model   7 7867.8 7916.8 -3926.9   7853.8 3.7447      5     0.5867
summary(run.model) 
# Fixed effects:
#             Estimate Std. Error z value Pr(>|z|)    
# (Intercept) -1.47411    0.09841 -14.979   <2e-16 ***
# run_index4  -0.07646    0.10063  -0.760    0.447    
# run_index5  -0.04036    0.10010  -0.403    0.687    
# run_index6   0.06852    0.09861   0.695    0.487    
# run_index7  -0.06089    0.10040  -0.607    0.544    
# run_index8  -0.10271    0.10103  -1.017    0.309    

#

# Condition effects on the proportion of Go decisions that resulted in Crashes
null.model <- glmer(go_cr ~ (1|scores.SID), data=df_fMRI_all, family='binomial')
condition.model <- glmer(go_cr ~ condition + (1|scores.SID), data=df_fMRI_all, family='binomial')
anova(null.model, condition.model)         
#                 Df    AIC    BIC  logLik deviance  Chisq Chi Df Pr(>Chisq)   
# null.model       2 7861.5 7875.5 -3928.7   7857.5                         
# condition.model  4 7863.5 7891.5 -3927.7   7855.5 2.0141      2     0.3653
summary(condition.model) 
# Fixed effects:
#             Estimate Std. Error z value Pr(>|z|)    
# (Intercept) -1.50732    0.08110 -18.585   <2e-16 ***
# condition3   0.03090    0.06871   0.450    0.653    
# condition4  -0.06709    0.07043  -0.953    0.341     

#


null.model <- glmer(go_cr ~ (1|scores.SID), data=social_df, family='binomial')
condition.model <- glmer(go_cr ~ condition + (1|scores.SID), data=social_df, family='binomial')
anova(null.model, condition.model)         
#                 Df    AIC    BIC  logLik deviance  Chisq Chi Df Pr(>Chisq)  
# null.model       2 5221.2 5234.4 -2608.6   5217.2                         
# condition.model  3 5221.2 5241.0 -2607.6   5215.2 1.9773      1     0.1597
summary(condition.model) 
# Fixed effects:
#             Estimate Std. Error z value Pr(>|z|)    
# (Intercept) -1.46868    0.07809 -18.808   <2e-16 ***
# condition4  -0.09902    0.07016  -1.411    0.158    

#
```
###############################################
## Social Context effects on STOP DECISIONS ##
#Do CWI teens engage in more stop decisions in social contexts? (YES- stop more following SE than alone or PR)#
###############################################
```{r}
# Run effects on the proportion of Stop decisions
null.model <- glmer(stop ~ (1|scores.SID), data=df_fMRI_all, family='binomial')
run.model <- glmer(stop ~ run_index + (1|scores.SID), data=df_fMRI_all, family='binomial')
anova(null.model, run.model)
#            Df   AIC   BIC  logLik deviance  Chisq Chi Df Pr(>Chisq)  
# null.model  2 10630 10644 -5312.9    10626                           
# run.model   7 10628 10677 -5306.9    10614 11.953      5    0.03544 *
summary(run.model)
# Number of obs: 8180, groups:  scores.SID, 69
# 
# Fixed effects:
#             Estimate Std. Error z value Pr(>|z|)   
# (Intercept)  0.23884    0.10122   2.360   0.0183 * 
# run_index4   0.12829    0.08007   1.602   0.1091   
# run_index5   0.14444    0.08010   1.803   0.0714 . 
# run_index6   0.01277    0.07985   0.160   0.8730   
# run_index7   0.18500    0.08139   2.273   0.0230 * 
# run_index8   0.21305    0.08108   2.628   0.0086 **

#However, CWI do appear to engage in sig more stop decisions across runs (in exlusion)

## Condition effects on the proportion of Stop decisions
null.model <- glmer(stop ~ (1|scores.SID), data=df_fMRI_all, family='binomial')
condition.model <- glmer(stop ~ condition + (1|scores.SID), data=df_fMRI_all, family='binomial')
anova(null.model, condition.model)
#                 Df   AIC   BIC  logLik deviance  Chisq Chi Df Pr(>Chisq)    
# null.model       2 10630 10644 -5312.9    10626                           
# condition.model  4 10627 10655 -5309.6    10619 6.5727      2    0.03739 *
summary(condition.model) 
# Fixed effects:
#             Estimate Std. Error z value Pr(>|z|)    
# (Intercept)  0.30274    0.09304   3.254  0.00114 **
# condition3   0.01444    0.05661   0.255  0.79869   
# condition4   0.13517    0.05761   2.346  0.01896 *  

#This is confirmed if we collapse across runs to conditions. (sig increase in stops from alone to SE)


null.model <- glmer(stop ~ (1|scores.SID), data=social_df, family='binomial')
condition.model <- glmer(stop ~ condition + (1|scores.SID), data=social_df, family='binomial')
anova(null.model, condition.model)
#                 Df    AIC    BIC  logLik deviance  Chisq Chi Df Pr(>Chisq)    
# null.model       2 7023.9 7037.1 -3510.0   7019.9                           
# condition.model  3 7021.7 7041.4 -3507.8   7015.7 4.2543      1    0.03915 *

summary(condition.model)
# Fixed effects:
#             Estimate Std. Error z value Pr(>|z|)    
# (Intercept)  0.32145    0.09704   3.312 0.000925 ***
# condition4   0.11976    0.05802   2.064 0.039011 *  

#Confirmed-- sig more stops SE from peer as well for CWI teens
```
#######################################################################################
## Social Context effects on Stop decisions when there was no crossing car (BAD STOP)##
#Do CWI teens engage in more maladatpive stop decisions in social contexts? (no)#
#######################################################################################
```{r}
# Run effects on the proportion of Bad Stop decisions
null.model <- glmer(stop_nocar ~ (1|scores.SID), data=df_fMRI_all, family='binomial')
run.model <- glmer(stop_nocar ~ run_index + (1|scores.SID), data=df_fMRI_all, family='binomial')
anova(null.model, run.model)
#            Df    AIC    BIC  logLik deviance  Chisq Chi Df Pr(>Chisq)
# null.model  2 9632.4 9646.4 -4814.2   9628.4                         
# run.model   7 9641.0 9690.1 -4813.5   9627.0 1.3975      5     0.9246
summary(run.model)
# Number of obs: 8180, groups:  scores.SID, 69
# 
# Fixed effects:
#             Estimate Std. Error z value Pr(>|z|)    
# (Intercept) -0.99838    0.07261 -13.749   <2e-16 ***
# run_index4   0.05516    0.08568   0.644    0.520    
# run_index5   0.04787    0.08575   0.558    0.577    
# run_index6  -0.01494    0.08632  -0.173    0.863    
# run_index7   0.06205    0.08663   0.716    0.474    
# run_index8   0.04922    0.08638   0.570    0.569     

#did this mean they had sig more bad stops? No!

# Condition effects on the proportion of Stop decisions
null.model <- glmer(stop_nocar ~ (1|scores.SID), data=df_fMRI_all, family='binomial')
condition.model <- glmer(stop_nocar ~ condition + (1|scores.SID), data=df_fMRI_all, family='binomial')
anova(null.model, condition.model)
#                 Df    AIC    BIC  logLik deviance Chisq Chi Df Pr(>Chisq)   
# null.model       2 9632.4 9646.4 -4814.2   9628.4                        
# condition.model  4 9636.0 9664.0 -4814.0   9628.0 0.428      2     0.8073

summary(condition.model) 
# Fixed effects:
#             Estimate Std. Error z value Pr(>|z|)    
# (Intercept) -0.97064    0.05825 -16.664   <2e-16 ***
# condition3  -0.01106    0.06065  -0.182    0.855    
# condition4   0.02786    0.06105   0.456    0.648     

#confirmed collapsed across conditions

#within social bad stops 
null.model <- glmer(stop_nocar ~ (1|scores.SID), data=social_df, family='binomial')
condition.model <- glmer(stop_nocar ~ condition + (1|scores.SID), data=social_df, family='binomial')
anova(null.model, condition.model)
#                 Df    AIC    BIC  logLik deviance  Chisq Chi Df Pr(>Chisq)  
# null.model       2 6395.4 6408.6 -3195.7   6391.4                         
# condition.model  3 6397.0 6416.8 -3195.5   6391.0 0.3948      1     0.5298

summary(null.model) 

# Fixed effects:
#             Estimate Std. Error z value Pr(>|z|)    
# (Intercept) -0.96550    0.05187  -18.61   <2e-16 ***

#this is confirmed that doesn't change between social conditions either
```


#####################################################################
## FIGURE 1: Social Context by run effects on Task Behavior ##
#####################################################################
```{r}
# Part A: Run and Condition effects on Go decisions
go_by_sid = df_fMRI_all %>% group_by(SID, run_index, condition) %>% summarize(mean_go = mean(go))
plot_group_go = go_by_sid %>% group_by(run_index, condition) %>% summarize(mean=mean(mean_go), 
                                                                    sd=sd(mean_go), 
                                                                    n=69, 
                                                                    se=sd/sqrt(n), 
                                                                    ci=qt(0.975, df=n-1)*se) 
  
fig_2a <- ggplot(plot_group_go, aes(x = run_index, y = mean, group=1)) +
  geom_point() +
  geom_line() +
  geom_errorbar(aes(ymin = mean-ci, ymax = mean+ci)) +
  facet_grid(.~condition, scales='free', labeller=as_labeller(condition_labels)) +
  labs(x='Run number', y='Propotion of Go decisions') 
  theme(text = element_text(size=18), axis.text.x = element_text(size=14), 
        axis.text.y = element_text(size=14), strip.text.x = element_text(size=18)) 
ggsave('fig_2a.png', fig_2a)

# Part B: Run and Location effects on Crashes
go_cr_by_sid = df_fMRI_all %>% group_by(SID, run_index, condition) %>% summarize(mean_go_cr = mean(go_cr))
plot_group_go_cr = go_cr_by_sid %>% group_by(run_index, condition) %>% summarize(mean = mean(mean_go_cr), 
                                                                    sd = sd(mean_go_cr), 
                                                                    n=69, # entered manually (could not be calculated because 127 has 140 trials, whereas all other subjects have 160 trials)
                                                                    se=sd/sqrt(n), 
                                                                    ci=qt(0.975, df=n-1)*se) 

fig_2b <- ggplot(plot_group_go_cr, aes(x = run_index, y = mean, group=1)) +
  geom_point() +
  geom_line() +
  geom_errorbar(aes(ymin = mean-ci, ymax = mean+ci)) +
  facet_grid(.~condition, scales='free', labeller=as_labeller(condition_labels)) +
  labs(x='Run number', y='Propotion of Go decisions\nthat resulted in Crashes') 
  theme(text = element_text(size=18), axis.text.x = element_text(size=14), 
        axis.text.y = element_text(size=14), strip.text.x = element_text(size=18)) 
ggsave('fig_2b.png', fig_2b)

# Part C: Run and Location effects on Stop decisions
stop_by_sid = df_fMRI_all %>% group_by(SID, run_index, condition) %>% summarize(mean_stop = mean(stop))
plot_group_stop = stop_by_sid %>% group_by(run_index, condition) %>% summarize(mean = mean(mean_stop), 
                                                                    sd = sd(mean_stop), 
                                                                    n=69, # entered manually (could not be calculated because 127 has 140 trials, whereas all other subjects have 160 trials)
                                                                    se=sd/sqrt(n), 
                                                                    ci=qt(0.975, df=n-1)*se) 

fig_2c <- ggplot(plot_group_stop, aes(x = run_index, y = mean, group=1)) +
  geom_point() +
  geom_line() +
  geom_errorbar(aes(ymin = mean-ci, ymax = mean+ci)) +
  facet_grid(.~condition, scales='free', labeller=as_labeller(condition_labels)) +
  labs(x='Run number', y='Propotion of Stop decisions') 
  theme(text = element_text(size=18), axis.text.x = element_text(size=14), 
        axis.text.y = element_text(size=14), strip.text.x = element_text(size=18)) 
ggsave('fig_2c.png', fig_2c)

# Part d: Run and Location effects on Bad Stop decisions
stop_nocar_by_sid = df_fMRI_all %>% group_by(SID, run_index, condition) %>% summarize(mean_stop_nocar = mean(stop_nocar))
plot_group_stop_nocar = stop_nocar_by_sid %>% group_by(run_index, condition) %>% summarize(mean = mean(mean_stop_nocar), 
                                                                    sd = sd(mean_stop_nocar), 
                                                                    n=69, # entered manually (could not be calculated because 127 has 140 trials, whereas all other subjects have 160 trials)
                                                                    se=sd/sqrt(n), 
                                                                    ci=qt(0.975, df=n-1)*se) 

fig_2d <- ggplot(plot_group_stop_nocar, aes(x = run_index, y = mean, group=1)) +
  geom_point() +
  geom_line() +
  geom_errorbar(aes(ymin = mean-ci, ymax = mean+ci)) +
  facet_grid(.~condition, scales='free', labeller=as_labeller(condition_labels)) +
  labs(x='Run number', y='Propotion of Bad Stop decisions') 
  theme(text = element_text(size=18), axis.text.x = element_text(size=14), 
        axis.text.y = element_text(size=14), strip.text.x = element_text(size=18)) 
ggsave('fig_2d.png', fig_2d)
```


###############################################################
## Social Context effects on GO DECISIONS W/ RW RISK BEHAVIOR##
###############################################################
```{r}

# qualtrics data
RPI <- read.csv(paste(qualtrics_folder,'scoring_script_output/tds1-wave1-RPI_part2.csv', sep='') )
NTS <- read.csv(paste(qualtrics_folder,'scoring_script_output/tds1-wave1-NTS.csv' , sep=''))                               
BIS <- read.csv(paste(qualtrics_folder,'scoring_script_output/tds1-wave1-BIS_15.csv' , sep=''))                               
BSSS <- read.csv(paste(qualtrics_folder,'scoring_script_output/tds1-wave1-BSSS.csv' , sep=''))                               
SPSRQ <- read.csv(paste(qualtrics_folder,'scoring_script_output/tds1-wave1-SPSRQ_S.csv' , sep='')) %>% select(scores.SID, scores.sensitivity_punishment, scores.sensitivity_reward)


# merge qualtrics data

qualtrics_merge1<-merge(RPI, NTS, by = 'scores.SID') %>% select(scores.SID, scores.rpi_mean, scores.belongingness, scores.control, scores.meaningful_existence, scores.self_esteem, scores.total_score)

qualtrics_merge2<-merge(BIS, BSSS, by = 'scores.SID') %>% select(scores.SID, scores.bis_attentional_impulsivity, scores.bis_motor_impulsivity, scores.bis_nonplanning_impulsivity, scores.bis_total,
                                                                 scores.sss_boredom_susceptibility, scores.sss_disinhibition, scores.sss_experience_seeking, scores.sss_thrill_adventure_seeking, scores.sss_total)
qualtrics_merge3<-merge(qualtrics_merge1, qualtrics_merge2, by = 'scores.SID')

RWR_qualtrics_data <- merge(qualtrics_merge3, SPSRQ, by = 'scores.SID')

no_session2 = c(311, 338, 358)
behaviorals = c(305, 318, 319)
ylg_failed = c(339, 345)

RWR_filtered <- RWR_qualtrics_data %>% filter(scores.SID > 300) %>% 
  filter(!scores.SID %in% no_session2) %>% 
  filter(!scores.SID %in% behaviorals)%>%
  filter(!scores.SID %in% ylg_failed)

install.packages("summarytools")
library(summarytools)#check ranges of variables first
view(dfSummary(RWR_filtered))

df_RWR_fMRI <- left_join(df_fMRI_all, RWR_filtered, by= "scores.SID")
write.csv(df_RWR_fMRI, file = 'test.csv')


```


##################################
# TASK CORRELATIONS RISK WITH RWB
##################################
```{r}
#are risk decisions in the scanner correlated with impuslivity and sensation seeking out of the scanner?
null.model <- aov(scores.bis_total ~ go + (1|scores.SID), data=df_RWR_fMRI)
main.model <- aov(scores.bis_total ~ go + condition + (1|scores.SID), data=df_RWR_fMRI)
interaction.model <- aov(scores.bis_total ~ go*condition + (1|scores.SID), data=df_RWR_fMRI)
anova(null.model, main.model)
#  Res.Df    RSS Df Sum of Sq      F  Pr(>F)  
# 1   7938 1492.4                              
# 2   7936 1491.0  2    1.3893 3.6973 0.02483 *
#since main was sig, compare main to interaction model
anova(main.model, interaction.model)
#   Res.Df    RSS Df Sum of Sq      F  Pr(>F)  
# 1   7936 1491.0                              
# 2   7934 1489.5  2    1.5721 4.1872 0.01522 *
#therefore was to look at summary of interaction model
summary(interaction.model)

#                Df Sum Sq Mean Sq F value Pr(>F)  
# go              1    0.2  0.2106   1.122 0.2896  
# condition       2    1.4  0.6946   3.700 0.0248 *
# go:condition    2    1.6  0.7861   4.187 0.0152 *
# Residuals    7934 1489.5  0.1877             


#performance on go decisions across conditions has is significantly associated with self reported impulsivity -- need to look at it to disentangle 

null.model <- aov(scores.sss_total ~ go + (1|scores.SID), data=df_RWR_fMRI)
main.model <- aov(scores.sss_total ~ go + condition + (1|scores.SID), data=df_RWR_fMRI)
interaction.model <- aov(scores.sss_total ~ go*condition + (1|scores.SID), data=df_RWR_fMRI)
anova(null.model, main.model)
#   Res.Df    RSS Df Sum of Sq      F Pr(>F)
# 1   7938 485.31                           
# 2   7936 485.29  2  0.022797 0.1864 0.8299
#no need to really look at interaction if main was sig better than null, but for posterity..
anova(main.model, interaction.model)
summary(null.model)
#   Res.Df    RSS Df Sum of Sq     F Pr(>F)
# 1   7936 485.29                          
# 2   7934 485.23  2  0.058961 0.482 0.6175  

#performance on go decisions across conditions has no relationship with sensation seeking


#do individual differences in sensitivity to reward, punishment correlated with changes in risk decisions across contexts?
null.model <- aov(scores.sensitivity_reward ~ go + (1|scores.SID), data=df_RWR_fMRI)
main.model <- aov(scores.sensitivity_reward ~ go + condition + (1|scores.SID), data=df_RWR_fMRI)
interaction.model <- aov(scores.sensitivity_reward ~ go*condition + (1|scores.SID), data=df_RWR_fMRI)
anova(null.model, main.model)
#   Res.Df    RSS Df Sum of Sq     F Pr(>F)
# 1   7938 540.24                          
# 2   7936 540.10  2   0.14796 1.087 0.3373
anova(main.model, interaction.model)
#   Res.Df    RSS Df Sum of Sq      F Pr(>F)
# 1   7936 540.10                           
# 2   7934 540.04  2  0.057101 0.4195 0.6574
#again, no need to do this one if null/main ns
summary(null.model)
#              Df Sum Sq Mean Sq F value Pr(>F)   
# go             1    0.6  0.6444   9.469 0.0021 **
# Residuals   7938  540.2  0.0681 
#nice work-yes, since not sig, look at null summary

null.model <- aov(scores.sensitivity_punishment ~ go + (1|scores.SID), data=df_RWR_fMRI)
main.model <- aov(scores.sensitivity_punishment ~ go + condition + (1|scores.SID), data=df_RWR_fMRI)
interaction.model <- aov(scores.sensitivity_punishment ~ go*condition + (1|scores.SID), data=df_RWR_fMRI)
anova(null.model, main.model)
#   Res.Df    RSS Df Sum of Sq      F Pr(>F)
# 1   8058 536.62                           
# 2   8056 536.47  2   0.14297 1.0735 0.3419
#anova(null.model, interaction.model)
summary(null.model)
#               Df Sum Sq Mean Sq F value Pr(>F)  
# go             1    2.6  2.5834   38.79 4.95e-10 ***
# Residuals   8058  536.6  0.0666            

#go decisons across decision are not related to sensitivity to reward or punishment

null.model <- aov(scores.total_score ~ go + (1|scores.SID), data=df_RWR_fMRI)
main.model <- aov(scores.total_score ~ go + condition + (1|scores.SID), data=df_RWR_fMRI)
interaction.model <- aov(scores.total_score ~ go*condition + (1|scores.SID), data=df_RWR_fMRI)
anova(null.model, main.model)
#   Res.Df    RSS Df Sum of Sq      F Pr(>F)
# 1   8058 3422.1                           
# 2   8056 3422.1  2  0.042147 0.0496 0.9516
#anova(null.model, interaction.model)
summary(null.model)
#               Df Sum Sq Mean Sq F value   Pr(>F)    
# go             1      1  1.0130   2.385  0.123
# Residuals   8058   3422  0.4247                    

#

null.model <- aov(scores.rpi_mean ~ go + (1|scores.SID), data=df_RWR_fMRI)
main.model <- aov(scores.rpi_mean ~ go + condition + (1|scores.SID), data=df_RWR_fMRI)
interaction.model <- aov(scores.rpi_mean ~ go*condition + (1|scores.SID), data=df_RWR_fMRI)
anova(null.model, main.model)
#   Res.Df    RSS Df Sum of Sq      F Pr(>F)
# 1   8058 2644.8                           
# 2   8056 2644.6  2   0.18214 0.2774 0.7577
#anova(null.model, interaction.model)
summary(null.model)

#               Df Sum Sq Mean Sq F value Pr(>F)  
# go             1    0.8  0.8499    2.59  0.108
# Residuals   8058 2644.8  0.3282  

#

```

##################################
# TASK CORRELATIONS RISK WITH RWB
#-- this is post hoc- but given most interesting behaviors are occurring for stops, not gos- let's see how this associates with our RWR behaviors. #
##################################
```{r}
#are stop decisions in the scanner correlated with impuslivity and sensation seeking out of the scanner?
null.model <- aov(scores.bis_total ~ stop + (1|scores.SID), data=df_RWR_fMRI)
main.model <- aov(scores.bis_total ~ stop + condition + (1|scores.SID), data=df_RWR_fMRI)
interaction.model <- aov(scores.bis_total ~ stop*condition + (1|scores.SID), data=df_RWR_fMRI)
anova(null.model, main.model)

#    Res.Df    RSS Df Sum of Sq      F  Pr(>F)  
# 1   7938 1492.5                           
# 2   7936 1491.2  2     1.355 3.6055 0.02722 *=
anova(main.model, interaction.model)
#  Res.Df    RSS Df Sum of Sq      F  Pr(>F)  
# 1   7936 1491.2       
# 2   7934 1489.8  2    1.3286 3.5376 0.02913 *
summary(interaction.model)
#               Df Sum Sq Mean Sq F value Pr(>F)  
# stop              1    0.1  0.0993   0.529 0.4672  
# condition         2    1.4  0.6775   3.608 0.0272 *
# stop:condition    2    1.3  0.6643   3.538 0.0291 *
# Residuals      7934 1489.9  0.1878     
null.model <- aov(scores.sss_total ~ stop + (1|scores.SID), data=df_RWR_fMRI)
main.model <- aov(scores.sss_total ~ stop + condition + (1|scores.SID), data=df_RWR_fMRI)
interaction.model <- aov(scores.sss_total ~ stop*condition + (1|scores.SID), data=df_RWR_fMRI)
anova(null.model, main.model)
#   Res.Df    RSS Df Sum of Sq      F Pr(>F)
# 1   7938 485.31  
# 2   7936 485.29  2   0.02359 0.1929 0.8246
anova(main.model, interaction.model)
#   Res.Df    RSS Df Sum of Sq      F Pr(>F)
# 1   7936 485.29   
# 2   7934 485.27  2  0.014894 0.1218 0.8854
summary(null.model)

# Df Sum Sq Mean Sq F value Pr(>F)
# stop           1    0.0 0.03130   0.512  0.474
# Residuals   7938  485.3 0.06114            

#do individual differences in sensitivity to reward, punishment correlated with changes in stop decisions across contexts?
null.model <- aov(scores.sensitivity_reward ~ stop + (1|scores.SID), data=df_RWR_fMRI)
main.model <- aov(scores.sensitivity_reward ~ stop + condition + (1|scores.SID), data=df_RWR_fMRI)
interaction.model <- aov(scores.sensitivity_reward ~ stop*condition + (1|scores.SID), data=df_RWR_fMRI)
anova(null.model, main.model)
#   Res.Df    RSS Df Sum of Sq      F Pr(>F)
# 1   7938 540.55      
# 2   7936 540.39  2   0.15217 1.1173 0.3272
anova(main.model, interaction.model)
#   Res.Df    RSS Df Sum of Sq      F Pr(>F)
# 1   7936 540.39     
# 2   7934 540.13  2   0.26698 1.9609 0.1408
summary(null.model)
#   Res.Df    RSS Df Sum of Sq      F Pr(>F)
# 1   7936 540.39   
# 2   7934 540.13  2   0.26698 1.9609 0.1408
null.model <- aov(scores.sensitivity_punishment ~ stop + (1|scores.SID), data=df_RWR_fMRI)
main.model <- aov(scores.sensitivity_punishment ~ stop + condition + (1|scores.SID), data=df_RWR_fMRI)
interaction.model <- aov(scores.sensitivity_punishment ~ stop*condition + (1|scores.SID), data=df_RWR_fMRI)
anova(null.model, main.model)
#   Res.Df    RSS Df Sum of Sq     F Pr(>F)
# 1   8058 536.59    
# 2   8056 536.47  2   0.12479 0.937 0.3918
summary(null.model)
#               Df Sum Sq Mean Sq F value   Pr(>F)    
# stop           1    2.6  2.6095   39.19 4.05e-10 ***
# Residuals   8058  536.6  0.0666            
null.model <- aov(scores.total_score ~ stop + (1|scores.SID), data=df_RWR_fMRI)
main.model <- aov(scores.total_score ~ stop + condition + (1|scores.SID), data=df_RWR_fMRI)
interaction.model <- aov(scores.total_score ~ stop*condition + (1|scores.SID), data=df_RWR_fMRI)
anova(null.model, main.model)
#   Res.Df    RSS Df Sum of Sq      F Pr(>F)
# 1   8058 3421.2     
# 2   8056 3421.1  2  0.053176 0.0626 0.9393
summary(null.model)
#              Df Sum Sq Mean Sq F value Pr(>F)  
# stop           1      2  1.9438   4.578 0.0324 *
# Residuals   8058   3421  0.4246          
null.model <- aov(scores.rpi_mean ~ stop + (1|scores.SID), data=df_RWR_fMRI)
main.model <- aov(scores.rpi_mean ~ stop + condition + (1|scores.SID), data=df_RWR_fMRI)
interaction.model <- aov(scores.rpi_mean ~ stop*condition + (1|scores.SID), data=df_RWR_fMRI)
anova(null.model, main.model)
#   Res.Df    RSS Df Sum of Sq      F Pr(>F)
# 1   8058 2644.3             
# 2   8056 2644.2  2   0.16569 0.2524 0.7769

summary(null.model)
#               Df Sum Sq Mean Sq F value Pr(>F)  
# stop           1    1.3  1.2859   3.918 0.0478 *
# Residuals   8058 2644.3  0.3282                 
 
```



###########################################################################################################
SUPPLEMENTAL 
###########################################################################################################


################################################################
## Age effects on GO DECISIONS while controlling for Sex & IQ ##
################################################################
```{r}
# Linear Age effects on the proportion of Go decisions (by run_index)
null.model <- glmer(go ~ run_index + gender + iq_z + (1|scores.SID), data=df_fMRI_all_stops, family='binomial')
main.model <- glmer(go ~ age_c + run_index + gender + iq_z + (1|scores.SID), data=df_fMRI_all_stops, family='binomial')
interaction.model <- glmer(go ~ age_c * run_index + gender + iq_z + (1|scores.SID), data=df_fMRI_all_stops, family='binomial')

anova(null.model, main.model)
#            Df   AIC   BIC  logLik deviance  Chisq Chi Df Pr(>Chisq)
# null.model  9 9745.7 9808.2 -4863.9   9727.7                           
# main.model 10 9741.7 9811.1 -4860.8   9721.7 6.0164      1    0.01417 *
anova(main.model, interaction.model)
#                  Df    AIC    BIC  logLik deviance Chisq Chi Df Pr(>Chisq)   
# main.model        10 9741.7 9811.1 -4860.8   9721.7                           
# interaction.model 15 9734.6 9838.8 -4852.3   9704.6 17.12      5   0.004278 **

summary(main.model)
# Fixed effects:
#             Estimate Std. Error z value Pr(>|z|)    
# (Intercept) -0.40424    0.13397  -3.018  0.00255 **
# run_index4  -0.10496    0.08502  -1.234  0.21702   
# run_index5   0.01074    0.08455   0.127  0.89890   
# run_index6   0.12067    0.08420   1.433  0.15183   
# run_index7  -0.06489    0.08484  -0.765  0.44439   
# run_index8  -0.01076    0.08462  -0.127  0.89883   
# gender1     -0.27619    0.18593  -1.485  0.13743   
# iq_z         0.05922    0.11388   0.520  0.60301

summary(interaction.model)
# Fixed effects:
#                   Estimate Std. Error z value Pr(>|z|)   
# (Intercept)      -0.378174   0.129655  -2.917  0.00354 **
# age_c             0.059983   0.062117   0.966  0.33422   
# run_index4       -0.112238   0.085163  -1.318  0.18753   
# run_index5        0.003444   0.084663   0.041  0.96755   
# run_index6        0.106737   0.084469   1.264  0.20637   
# run_index7       -0.064415   0.084867  -0.759  0.44785   
# run_index8       -0.030203   0.085058  -0.355  0.72252   
# gender1          -0.330383   0.179958  -1.836  0.06637 . 
# iq_z              0.076550   0.109535   0.699  0.48464   
# age_c:run_index4  0.072276   0.050796   1.423  0.15477   
# age_c:run_index5  0.072671   0.050517   1.438  0.15028   
# age_c:run_index6  0.128839   0.050443   2.554  0.01064 * 
# age_c:run_index7 -0.004498   0.050740  -0.089  0.92936   
# age_c:run_index8  0.159948   0.050767   3.151  0.00163 **


# Linear Age effects on the proportion of Go decisions (by location)
null.model <- glmer(go ~ condition + gender + iq_z + (1|scores.SID), data=df_fMRI_all, family='binomial')
main.model <- glmer(go ~ age_c + condition + gender + iq_z + (1|scores.SID), data=df_fMRI_all, family='binomial')
interaction.model <- glmer(go ~ age_c * condition + gender + iq_z + (1|scores.SID), data=df_fMRI_all, family='binomial')

anova(null.model, main.model)
#            Df   AIC   BIC  logLik deviance  Chisq Chi Df Pr(>Chisq)
# null.model  6 10251 10293 -5119.7    10239                           
# main.model  7 10247 10296 -5116.5    10233 6.2659      1    0.01231 *
anova(main.model, interaction.model)
#                   Df   AIC   BIC  logLik deviance  Chisq Chi Df Pr(>Chisq)
# null.model         6 10251 10293 -5119.7    10239                            
# interaction.model  9 10246 10309 -5113.8    10228 11.707      3   0.008458 **
summary(null.model)
# Fixed effects:
#             Estimate Std. Error z value Pr(>|z|)    
# (Intercept) -0.43928    0.11829  -3.714 0.000204 ***
# condition3   0.09386    0.05786   1.622 0.104756    
# condition4  -0.01267    0.05895  -0.215 0.829800    
# gender1     -0.27855    0.17447  -1.597 0.110373    
# iq_z         0.05325    0.10015   0.532 0.594949    

summary(interaction.model)

#Fixed effects:
#                  Estimate Std. Error z value Pr(>|z|)    
# (Intercept)      -0.40810    0.11426  -3.572 0.000355 ***
# age_c             0.08316    0.05366   1.550 0.121215    
# condition3        0.08647    0.05797   1.492 0.135805    
# condition4       -0.01647    0.05898  -0.279 0.780045    
# gender1          -0.34787    0.16975  -2.049 0.040434 *  
# iq_z              0.05086    0.09606   0.529 0.596480    
# age_c:condition3  0.08009    0.03463   2.313 0.020745 *  
# age_c:condition4  0.04968    0.03501   1.419 0.155804    
```
###############
## FIGURE 4A ##
###############
```{r}
#Part A: Go decisions plotted against Age
df_fMRI_all$pred_go <- predict(interaction.model, newdata=df_fMRI_all, re.form=NA, type='response')

fig_4a <- ggplot(data=df_fMRI_all, aes(x=s2_age, y=pred_go, color=condition)) +
  geom_line(aes(group=condition), size=1) +
  labs(x='Age', y='Predicted probability of Go decisions', color='Condition') +
  theme(text = element_text(size=16)) +
  scale_colour_discrete(labels=condition_labels)
ggsave('fig_4a.png', fig_4a)

pGo <- df_fMRI_all %>% group_by(scores.SID, condition) %>% summarize(pGo = mean(go))
pGo_by_age <- merge(pGo, demo, by = 'scores.SID')

ggplot(pGo_by_age, aes(x = s2_age, y = pGo, color=condition), stat_smooth(method = loess)) +
  geom_point() +
  geom_line(aes(group=condition), size=1) +
  #geom_errorbar(aes(ymax=mean + ci, ymin=mean - ci), width=0.5, position=position_dodge(.2)) +
  #facet_grid(.~condition, scales='free', labeller=as_labeller(condition_labels)) +
  labs(x='Age (mean-centered)', y='Proportion of Go decisions', color='Social Context')

```
######################################################################
## Age Group effects on GO DECISIONS while controlling for Sex & IQ ##
######################################################################
```{r}
# Age group effects on the proportion of Go decisions (by run_index)
# null.model <- glmer(go ~ run_index + gender + iq_z + (1|SID), data=df_fMRI, family='binomial')
# main.model <- glmer(go ~ age_group + run_index + gender + iq_z + (1|SID), data=df_fMRI, family='binomial')
# interaction.model <- glmer(go ~ age_group * run_index + gender + iq_z + (1|SID), data=df_fMRI, family='binomial', control=glmerControl(optimizer="bobyqa"))
# 
# anova(null.model, main.model)
# anova(null.model, interaction.model)
# anova(main.model, interaction.model)
# 
# summary(null.model)
# 
# # Age group effects on the proportion of Go decisions (by location)
# null.model <- glmer(go ~ condition + gender + iq_z + (1|SID), data=df_fMRI, family='binomial')
# main.model <- glmer(go ~ age_group + condition + gender + iq_z + (1|SID), data=df_fMRI, family='binomial')
# interaction.model <- glmer(go ~ age_group * condition + gender + iq_z + (1|SID), data=df_fMRI, family='binomial')
# 
# anova(null.model, main.model)
# anova(null.model, interaction.model)
# anova(main.model, interaction.model)
# 
# summary(null.model)
```
###########################################################
## Age effects on CRASHES while controlling for Sex & IQ ##
###########################################################
```{r}
# Age effects on the proportion of Go decisions that resulted in Crashes (by run_index)
null.model <- glmer(go_cr ~ run_index + gender + iq_z + (1|scores.SID), data=df_fMRI_all_stops, family='binomial')
main.model <- glmer(go_cr ~ age_c + run_index + gender + iq_z + (1|scores.SID), data=df_fMRI_all_stops, family='binomial')
interaction.model <- glmer(go_cr ~ age_c * run_index + gender + iq_z + (1|scores.SID), data=df_fMRI_all_stops, family='binomial', control=glmerControl(optimizer="bobyqa"))

anova(null.model, main.model)
#            Df   AIC   BIC  logLik deviance  Chisq Chi Df Pr(>Chisq)
# null.model  9 7512.2 7574.8 -3747.1   7494.2                           
# main.model 10 7509.6 7579.0 -3744.8   7489.6 4.6917      1    0.03031 *
anova(null.model, interaction.model)
#                   Df   AIC   BIC  logLik deviance  Chisq Chi Df Pr(>Chisq)
# null.model         9 7512.2 7574.8 -3747.1   7494.2                           
# interaction.model 15 7513.5 7617.7 -3741.8   7483.5 10.726      6    0.09721 .
anova(main.model, interaction.model)
#                   Df    AIC    BIC  logLik deviance  Chisq Chi Df Pr(>Chisq)
# main.model        10 7509.6 7579.0 -3744.8   7489.6                         
# interaction.model 15 7513.5 7617.7 -3741.8   7483.5 6.0346      5     0.3029

summary(null.model)
# Fixed effects:
#             Estimate Std. Error z value Pr(>|z|)    
# (Intercept) -1.36294    0.10837 -12.577   <2e-16 ***
# run_index4  -0.07641    0.10063  -0.759    0.448    
# run_index5  -0.04032    0.10010  -0.403    0.687    
# run_index6   0.06847    0.09862   0.694    0.487    
# run_index7  -0.06087    0.10040  -0.606    0.544    
# run_index8  -0.10264    0.10103  -1.016    0.310    
# gender1     -0.16883    0.13296  -1.270    0.204    
# iq_z         0.05595    0.08174   0.685    0.494 

# Age effects on the proportion of Go decisions that resulted in Crashes (by location)
null.model <- glmer(go_cr ~ condition + gender + iq_z + (1|scores.SID), data=df_fMRI_all, family='binomial')
main.model <- glmer(go_cr ~ age_c + condition + gender + iq_z + (1|scores.SID), data=df_fMRI_all, family='binomial')
interaction.model <- glmer(go_cr ~ age_c * condition + gender + iq_z + (1|scores.SID), data=df_fMRI_all, family='binomial')

anova(null.model, main.model)
#            Df   AIC   BIC  logLik deviance  Chisq Chi Df Pr(>Chisq)
# null.model  6 7843.7 7885.7 -3915.9   7831.7                           
# main.model  7 7841.4 7890.3 -3913.7   7827.4 4.3431      1    0.03716 *
anova(null.model, interaction.model)
#                   Df   AIC   BIC  logLik deviance  Chisq Chi Df Pr(>Chisq)
# null.model         6 7843.7 7885.7 -3915.9   7831.7                         
# interaction.model  9 7843.7 7906.6 -3912.8   7825.7 6.0286      3     0.1102
anova(main.model, interaction.model)
#                   Df    AIC    BIC  logLik deviance  Chisq Chi Df Pr(>Chisq)
# main.model         7 7841.4 7890.3 -3913.7   7827.4                         
# interaction.model  9 7843.7 7906.6 -3912.8   7825.7 1.6855      2     0.4305

summary(null.model)
#Fixed effects:
#             Estimate Std. Error z value Pr(>|z|)    
# (Intercept) -1.39740    0.09149 -15.274   <2e-16 ***
# condition3   0.03088    0.06871   0.449    0.653    
# condition4  -0.06596    0.07042  -0.937    0.349    
# gender1     -0.17542    0.12710  -1.380    0.168    
# iq_z         0.03877    0.07361   0.527    0.598  
```
###############
## FIGURE 4B ##
###############
```{r}
# Part B: Crashes
crashes <- df_fMRI_all %>% distinct(scores.SID, gender_flip, condition, run_index, crash_count)


plot.crashes <- crashes %>% group_by(gender_flip, condition, run_index) %>%
  summarize(mean = mean(crash_count), sd = sd(crash_count), n = n(), se = sd/sqrt(n), ci=qt(0.975, df=n-1)*se)

ggplot(plot.crashes, aes(x = run_index, y = mean, color=gender_flip)) +
  geom_point(position=position_dodge(.1), size=3) +
  geom_line(aes(group=gender_flip), size=1) +
  # geom_errorbar(aes(ymax=mean + ci, ymin=mean - ci), width=0.5, position=position_dodge(.2)) +
  # facet_grid(.~condition, scales='free', labeller=as_labeller(condition_labels)) +
  labs(x='Run number', y='Crashes', color='Sex') +
  scale_y_continuous(breaks = c(3, 4, 5))
```

####################################################################
## Puberty effects on GO DECISIONS while controlling for Sex & IQ ##
####################################################################
```{r}
df_pds_all_stops <- df_fMRI_all_stops %>% filter(!is.na(PDS_mean_score))
df_pds_all <- df_fMRI_all %>% filter(!is.na(PDS_mean_score))


# Puberty effects on the proportion of Go decisions (by run_index)
null.model <- glmer(go ~ run_index + gender + iq_z + (1|scores.SID), data=df_pds_all_stops, family='binomial')
main.model <- glmer(go ~ PDS_mean_score + run_index + gender + iq_z + (1|scores.SID), data=df_pds_all_stops, family='binomial', control=glmerControl(optimizer="bobyqa"))
interaction.model <- glmer(go ~ PDS_mean_score * run_index + gender + iq_z + (1|scores.SID), data=df_pds_all_stops, family='binomial', control=glmerControl(optimizer="bobyqa"))

anova(null.model, main.model)
#            Df   AIC   BIC  logLik deviance Chisq Chi Df Pr(>Chisq)
# null.model  9 7657.1 7717.2 -3819.5   7639.1                         
# main.model 10 7657.2 7724.0 -3818.6   7637.2 1.8437      1     0.1745
anova(main.model, interaction.model)
#                   Df   AIC   BIC  logLik deviance  Chisq Chi Df Pr(>Chisq)
# null.model         9 7657.1 7717.2 -3819.5   7639.1                         
# interaction.model 15 7659.2 7759.3 -3814.6   7629.2 9.8938      6     0.1292

summary(null.model)
# Fixed effects:
#             Estimate Std. Error z value Pr(>|z|)    
# (Intercept) -0.352238   0.140899  -2.500   0.0124 *
# run_index4  -0.063843   0.095454  -0.669   0.5036  
# run_index5   0.009071   0.095173   0.095   0.9241  
# run_index6   0.121519   0.094851   1.281   0.2001  
# run_index7  -0.040963   0.095361  -0.430   0.6675  
# run_index8   0.036203   0.095081   0.381   0.7034  
# gender1     -0.164995   0.194959  -0.846   0.3974  
# iq_z         0.126348   0.113606   1.112   0.2661 

# Puberty effects on the proportion of Go decisions (by social context)
null.model <- glmer(go ~ condition + gender + iq_z + (1|scores.SID), data=df_pds_all, family='binomial')
main.model <- glmer(go ~ PDS_mean_score + condition + gender + iq_z + (1|scores.SID), data=df_pds_all, family='binomial', control=glmerControl(optimizer="bobyqa"))
interaction.model <- glmer(go ~ PDS_mean_score * condition + gender + iq_z + (1|scores.SID), data=df_pds_all, family='binomial', control=glmerControl(optimizer="bobyqa"))

anova(null.model, main.model)
#            Df   AIC   BIC  logLik deviance Chisq Chi Df Pr(>Chisq)
# null.model  6 8056.8 8097.2 -4022.4   8044.8                         
# main.model  7 8056.8 8103.9 -4021.4   8042.8 2.0619      1      0.151
anova(main.model, interaction.model)
#                   Df    AIC    BIC  logLik deviance  Chisq Chi Df Pr(>Chisq)
# main.model         7 8056.8 8103.9 -4021.4   8042.8                         
# interaction.model  9 8057.2 8117.8 -4019.6   8039.2 3.5662      2     0.1681


summary(null.model)
# Fixed effects:
#             Estimate Std. Error z value Pr(>|z|)    
# (Intercept) -0.35621    0.12262  -2.905  0.00367 **
# condition3   0.05524    0.06515   0.848  0.39655   
# condition4  -0.01144    0.06601  -0.173  0.86238   
# gender1     -0.16248    0.18389  -0.884  0.37693   
# iq_z         0.12709    0.10543   1.206  0.22802  
```
###############################################################
## Puberty effects on CRASHES while controlling for Sex & IQ ##
###############################################################
```{r}
# Puberty effects on the proportion of Go decisions that resulted in Crashes (by run_index)
null.model <- glmer(go_cr ~ run_index + gender + iq_z + (1|scores.SID), data=df_pds_all_stops, family='binomial', control=glmerControl(optimizer="bobyqa"))
main.model <- glmer(go_cr ~ PDS_mean_score + run_index + gender + iq_z + (1|scores.SID), data=df_pds_all_stops, family='binomial', control=glmerControl(optimizer="bobyqa"))
interaction.model <- glmer(go_cr ~ PDS_mean_score * run_index + gender + iq_z + (1|scores.SID), data=df_pds_all_stops, family='binomial', control=glmerControl(optimizer="bobyqa"))

anova(null.model, main.model)
#            Df    AIC    BIC  logLik deviance  Chisq Chi Df Pr(>Chisq)
# null.model  9 5924.0 5984.1 -2953.0   5906.0                         
# main.model 10 5925.3 5992.1 -2952.7   5905.3 0.6343      1     0.4258
anova(main.model, interaction.model)
#                   Df    AIC    BIC  logLik deviance  Chisq Chi Df Pr(>Chisq)
# main.model        10 5925.3 5992.1 -2952.7   5905.3                         
# interaction.model 15 5932.7 6032.9 -2951.3   5902.7 2.6435      5     0.7547


summary(null.model)
# Fixed effects:
#              Estimate Std. Error z value Pr(>|z|)    
# (Intercept) -1.378e+00  1.169e-01 -11.789   <2e-16 ***
# run_index4   5.740e-02  1.127e-01   0.509    0.610    
# run_index5  -1.301e-02  1.138e-01  -0.114    0.909    
# run_index6   1.191e-01  1.118e-01   1.066    0.286    
# run_index7   2.302e-06  1.136e-01   0.000    1.000    
# run_index8  -1.301e-02  1.138e-01  -0.114    0.909    
# gender1     -1.040e-01  1.398e-01  -0.744    0.457    
# iq_z         8.902e-02  8.186e-02   1.087    0.277

# Puberty effects on the proportion of Go decisions that resulted in Crashes (by social context)
null.model <- glmer(go_cr ~ condition + gender + iq_z + (1|scores.SID), data=df_pds_all, family='binomial')
main.model <- glmer(go_cr ~ PDS_mean_score + condition + gender + iq_z + (1|scores.SID), data=df_pds_all, family='binomial')
interaction.model <- glmer(go_cr ~ PDS_mean_score * condition + gender + iq_z + (1|scores.SID), data=df_pds_all, family='binomial', control=glmerControl(optimizer="bobyqa"))

anova(null.model, main.model)
#            Df    AIC    BIC  logLik deviance  Chisq Chi Df Pr(>Chisq)
# null.model  6 6196.1 6236.5 -3092.1   6184.1                         
# main.model  7 6197.2 6244.3 -3091.6   6183.2 0.9113      1     0.3398
anova(main.model, interaction.model)
#                   Df    AIC    BIC  logLik deviance Chisq Chi Df Pr(>Chisq)
# main.model         7 6197.2 6244.3 -3091.6   6183.2                        
# interaction.model  9 6200.4 6261.0 -3091.2   6182.4 0.795      2      0.672

summary(null.model) 
# Fixed effects:
#              Estimate Std. Error z value Pr(>|z|)    
# (Intercept) -1.342636   0.095337 -14.083   <2e-16 ***
# condition3  -0.002993   0.077171  -0.039    0.969    
# condition4  -0.066925   0.078541  -0.852    0.394    
# gender1     -0.087042   0.132924  -0.655    0.513    
# iq_z         0.100483   0.076606   1.312    0.190   
```

#####################################################################
## Social Context on Game Time ##
#####################################################################
```{r}
# Run effects on the proportion of Go decisions
null.model <- lm(time ~ (1|scores.SID), data=df_fMRI_all)
run.model <- lm(time ~ run_index + (1|scores.SID), data=df_fMRI_all)
anova(null.model, run.model)     
#   Res.Df    RSS Df Sum of Sq      F    Pr(>F)    
# 1   7799 211.04                                  
# 2   7794 204.37  5    6.6687 50.864 < 2.2e-16 ***
summary(run.model) 
# Fixed effects:
#              Estimate Std. Error t value Pr(>|t|)    
# (Intercept)         2.382660   0.004491 530.524  < 2e-16 ***
# run_index4         -0.028698   0.006351  -4.518 6.32e-06 ***
# run_index5         -0.066829   0.006351 -10.522  < 2e-16 ***
# run_index6         -0.049695   0.006351  -7.824 5.78e-15 ***
# run_index7         -0.046582   0.006351  -7.334 2.46e-13 ***
# run_index8         -0.093768   0.006351 -14.763  < 2e-16 ***

#
forgraph <- df_fMRI_all %>%
  select(time, run_index) %>%
  group_by(run_index) %>%
  mutate(game_time = mean(time)) 
View(forgraph)

ggplot(forgraph, aes(x=run_index, y= game_time)) +
  geom_point()

# Condition effects on the proportion of Go decisions
null.model <- lm(time ~ (1|scores.SID), data=df_fMRI_all)
condition.model <- lm(time ~ condition + (1|scores.SID), data=df_fMRI_all)
anova(null.model, condition.model)  
#   Res.Df    RSS Df Sum of Sq      F    Pr(>F)    
# 1   8179 233.32                                  
# 2   8177 228.02  2    5.3064 95.147 < 2.2e-16 ***
summary(condition.model)  
#  Fixed effects:
#              Estimate Std. Error t value Pr(>|t|)    
# (Intercept)         2.368729   0.003179  745.22   <2e-16 ***
# condition3         -0.048613   0.004495  -10.81   <2e-16 ***
# condition4         -0.058061   0.004537  -12.80   <2e-16 ***

#

social_df <- df_fMRI_all %>% filter(condition != "2")
null.model <- lm(time ~ (1|scores.SID), data=social_df)
condition.model <- lm(time ~ condition + (1|scores.SID), data=social_df)
anova(null.model, condition.model)  
#   Res.Df    RSS Df Sum of Sq      F  Pr(>F)  
# 1   5419 120.36                              
# 2   5418 120.24  1   0.12089 5.4474 0.01963 *
summary(null.model) 
# Fixed effects:
#            Estimate Std. Error t value Pr(>|t|)    
# (Intercept)        2.315480   0.002024    1144   <2e-16 ***

# 

gametime_by_sid = df_fMRI_all %>% group_by(scores.SID, run_index, condition) %>% summarize(mean_time = mean(time))
plot_group_gametime = gametime_by_sid %>% group_by(run_index, condition) %>% summarize(mean_gametime = mean(mean_time), sd = sd(mean_gametime),   n=59,  se=sd/sqrt(n),  ci=qt(0.975, df=n-1)*se)

 ggplot(plot_group_gametime, aes(x = run_index, y = mean_gametime, group=1)) +
  geom_point() +
  geom_line() +
  geom_errorbar(aes(ymin = sd, ymax =sd)) +
  facet_grid(.~condition, scales='free', labeller=as_labeller(condition_labels)) +
  labs(x='Run number', y='Game Time') #+
  #coord_cartesian(x=c(10.5,17.5)) + 
  theme(text = element_text(size=18), axis.text.x = element_text(size=14), 
        axis.text.y = element_text(size=14), strip.text.x = element_text(size=18)) #+
  #scale_y_continuous(breaks = c(0, 2, 4, 6, 8, 10)) + scale_x_continuous(breaks = 11:17) 


```

##################################
# Group comparisons 
##################################
```{r}
#example for Garrett
##need to change data frame
##need data frame to to include GROUP
## we want these comparisions for our main analyses-- 
###first gender, age, puberty, and iq 
###then go through prior analyses this time testing for group differences. 

#create df for TDS 1 and TDS 2

qualtrics_data_TDS2<-read.csv(paste(qualtrics_folder, 'scoring_script_output/tds2-wave1-PDS.csv', sep='')) %>%  
  select(scores.SID, scores.female_comparison, scores.female_height, scores.female_mean_score, scores.female_menses, scores.female_weight, scores.male_comparison, scores.male_height, scores.male_mean_score, scores.male_weight, scores.pds_gender)  

no_session2 = c(118, 123, 147, 148, 149, 153, 154, 166, 180)
behaviorals = c(103, 107, 112, 138, 143, 176, 191)
pilot_cyberball = c(101, 102, 104, 105, 106, 108, 110, 111)
motion_dropout = c(189, 158, 139)

#change names to be easier to read later
names(demo_data) <- c("scores.SID", "s2_age", "gender", "s2_iq", "wave2_yn", "s3_age", "s3_iq")

demo_data_TDS2<-demo_data%>% filter(scores.SID < 300) %>% 
  filter(!scores.SID %in% no_session2) %>% 
  filter(!scores.SID %in% behaviorals) %>%
  filter(!scores.SID %in% pilot_cyberball) %>%
  filter(!scores.SID %in% motion_dropout)
 

## Merge qualtrics and demo data
demo_TDS2 <- merge(demo_data_TDS2, qualtrics_data_TDS2, by.x = 'scores.SID', by.y = 'scores.SID')


demo_TDS2 <- demo_TDS2 %>%
  mutate(age_group = ifelse(s2_age < 14.0, 1, 2)) %>% # age groups based on median split
  mutate(age_c = s2_age-14.1, age_rnd = floor(s2_age), age_sq = age_c^2) %>%   # age variables
  mutate(iq_c = s2_iq-100, iq_z = iq_c/15) %>%                   # iq variables
  mutate(PDS_mean_score=ifelse(                               # pds variables
    is.na(scores.female_mean_score)==TRUE, scores.male_mean_score, scores.female_mean_score)) %>%
  mutate(PDS_stage = ceiling(PDS_mean_score), pds_group = ifelse(PDS_mean_score < 2.9, 1, 2)) %>%
  mutate(gender_flip = ifelse(gender==0, 'Male', 'Female'))   # flip gender for correct colors in graph


PDS_mean_scores_TDS2 <- demo_TDS2 %>% distinct(scores.SID, gender, scores.pds_gender, PDS_mean_score) %>% filter(!grepl("189|158|160|174", scores.SID)) 
write.csv(PDS_mean_scores_TDS2, file = 'tds2_PDS_mean_score_n70.csv')



TDS2_age_by_sex<-demo_TDS2 %>% filter(!is.na(s2_age)) %>% group_by(gender) %>% 
  summarize(mean = mean(s2_age, na.rm=T), sd = sd(s2_age, na.rm=T), 
            min = min(s2_age, na.rm=T), max = max(s2_age, na.rm=T),
            n = n(), se = sd/sqrt(n), ci=qt(0.975, df=n-1)*se) 
t.test(demo_TDS2$s2_age~demo_TDS2$gender) 

# t = -0.43967, df = 67.653, p-value = 0.6616
# alternative hypothesis: true difference in means is not equal to 0
# 95 percent confidence interval:
#  -0.8864616  0.5663797
# sample estimates:
# mean in group 0 mean in group 1 
#        14.05212        14.21216 

TDS2_iq_by_sex<-demo_TDS2 %>% filter(!is.na(s2_iq)) %>% group_by(gender) %>% 
  summarize(mean = mean(s2_iq, na.rm=T), sd = sd(s2_iq, na.rm=T), 
            min = min(s2_iq, na.rm=T), max = max(s2_iq, na.rm=T),
            n = n(), se = sd/sqrt(n), ci=qt(0.975, df=n-1)*se)

t.test(demo_TDS2$s2_iq~demo_TDS2$gender) 

# t = -0.74177, df = 67.989, p-value = 0.4608
# alternative hypothesis: true difference in means is not equal to 0
# 95 percent confidence interval:
#  -7.609971  3.485483
# sample estimates:
# mean in group 0 mean in group 1 
#        106.4242        108.4865 

pds_by_sex<-demo_TDS2 %>% filter(!is.na(PDS_mean_score)) %>% group_by(gender) %>% 
  summarize(mean = mean(PDS_mean_score, na.rm=T), sd = sd(PDS_mean_score, na.rm=T),
            min = min(PDS_mean_score, na.rm=T), max = max(PDS_mean_score, na.rm=T),
            n = n(), se = sd/sqrt(n), ci=qt(0.975, df=n-1)*se)

t.test(demo_TDS2$PDS_mean_score~demo_TDS2$gender) 

# t = -4.6755, df = 65.396, p-value = 1.514e-05
# alternative hypothesis: true difference in means is not equal to 0
# 95 percent confidence interval:
#  -0.9991348 -0.4010977
# sample estimates:
# mean in group 0 mean in group 1 
#        2.454839        3.154955 


ylg = ylg_data %>% 
  mutate(condition = ifelse(grepl('1|2', run_index), 1,
                     ifelse(grepl('3|4', run_index), 2,
                     ifelse(grepl('5|6', run_index), 3, 
                     ifelse(grepl('7|8', run_index), 4, NA))))) %>%
  mutate(time=run_time_ms/60000) %>%
  mutate(go = ifelse(decision=='GO', 1, 0)) %>%
  mutate(crash = ifelse(scenario=='CRASH', 1, 0)) %>%
  mutate(go_cr = ifelse(decision=='GO' & scenario=='CRASH', 1, 0)) %>%
  mutate(stop = ifelse(decision=='STOP', 1, 0)) %>%
  mutate(stop_nocar = ifelse(decision=='STOP' & scenario=='SAFE', 1, 0)) %>%
  mutate(event = ifelse(decision=='GO' & scenario=='SAFE', 1,
                 ifelse(decision=='GO' & scenario=='CRASH', 2,
                 ifelse(decision=='STOP' & scenario=='CROSSCAR', 3,
                 ifelse(decision=='STOP' & scenario=='SAFE', 4, NA))))) %>%
  mutate(count1 = ifelse(event==1, 1, 0)) %>%
  mutate(count2 = ifelse(event==2, 1, 0)) %>%
  mutate(count3 = ifelse(event==3, 1, 0)) %>%
  mutate(count4 = ifelse(event==4, 1, 0))

ylg$SID <- ylg$subject_name

# Check if events are present for all subjects
events_by_sid <- ylg %>% group_by(subject_name, condition) %>%
  summarize(n_good.go = sum(count1, na.rm=TRUE),
            n_bad.go = sum(count2, na.rm=TRUE),
            n_good.stop = sum(count3, na.rm=TRUE),
            n_bad.stop = sum(count4, na.rm=TRUE))

# Convert to factors
ylg$run_index <- as.factor(ylg$run_index)
ylg$condition <- as.factor(ylg$condition)

exclude = c(401, 402, 403, 404, 405, 406, 407, 408, 409, 410, 411)

no_session2 = c(118, 123, 147, 148, 149, 153, 154, 166, 180)
behaviorals = c(103, 107, 112, 138, 143, 176, 191)
pilot_cyberball = c(101, 102, 104, 105, 106, 108, 110, 111)
motion_dropout = c(189, 158, 139)


ylg_filtered_TDS2 = ylg %>% filter(subject_name < 300) %>% 
  filter(!subject_name %in% exclude) %>%
  filter(!subject_name %in% no_session2) %>%
  filter(!subject_name %in% behaviorals) %>%
  filter(!subject_name %in% pilot_cyberball) %>%
  filter(!subject_name %in% motion_dropout)

count_trials_per_subTDS2<-ylg_filtered_TDS2 %>% group_by(subject_name) %>% summarize(n()) 

# Set labels
condition_labels = c(`1`='Mock', `2`='Alone', `3`='Peer Incl', `4`='Peer Excl')

colnames(ylg_filtered_TDS2)[which(names(ylg_filtered_TDS2) == "subject_name")] <- "scores.SID"

# Dataset for behavioral analyses (incomplete and complete runs)
df_TDS2 <- merge(demo_TDS2, ylg_filtered_TDS2, by = 'scores.SID')

df_TDS2<-mutate(df_TDS2, Group =  2)

df_fMRI_all_TDS2<-df_TDS2 %>% filter(condition != "1")

countTDS2<-df_TDS2 %>% group_by(scores.SID, gender) %>% summarize(n()) 


# Remove columns that are not congruent between TDS 1 and TDS 2
df_fMRI_all_TDS2$scores.female_height = NULL
df_fMRI_all_TDS2$scores.female_weight = NULL
df_fMRI_all_TDS2$scores.male_height = NULL
df_fMRI_all_TDS2$scores.male_weight = NULL
df_fMRI_all$pred_go = NULL
df_fMRI_all$group = NULL

allTDSfMRI <- rbind(df_fMRI_all, df_fMRI_all_TDS2)

```


```{r}

# Run effects on the proportion of Go decisions
null.model <- glmer(go ~ (1|scores.SID), data=allTDSfMRI, family='binomial')
run.model <- glmer(go ~ run_index + (1|scores.SID), data=allTDSfMRI, family='binomial')
interaction.model <- glmer(go ~ Group*run_index + (1|scores.SID), data= allTDSfMRI, family='binomial', control=glmerControl(optimizer="bobyqa"))
anova(run.model, interaction.model)
#                   Df   AIC   BIC logLik deviance  Chisq Chi Df Pr(>Chisq)    
# run.model          7 21109 21163 -10547    21095                             
# interaction.model 13 21094 21194 -10534    21068 27.155      6  0.0001355 ***
anova(null.model, run.model)
#            Df   AIC   BIC logLik deviance  Chisq Chi Df Pr(>Chisq)    
# null.model  2 21122 21138 -10559    21118                             
# run.model   7 21109 21163 -10547    21095 23.357      5  0.0002885 ***

summary(interaction.model) 

# Fixed effects:
#                  Estimate Std. Error z value Pr(>|z|)    
# (Intercept)      -0.49678    0.22789  -2.180 0.029264 *  
# Group            -0.06038    0.14379  -0.420 0.674555    
# run_index4       -0.16541    0.18263  -0.906 0.365091    
# run_index5       -0.19989    0.18168  -1.100 0.271218    
# run_index6        0.06471    0.18111   0.357 0.720871    
# run_index7       -0.44800    0.18426  -2.431 0.015042 *  
# run_index8       -0.49432    0.18330  -2.697 0.007000 ** 
# Group:run_index4  0.08104    0.11534   0.703 0.482310    
# Group:run_index5  0.19319    0.11455   1.687 0.091691 .  
# Group:run_index6  0.04477    0.11439   0.391 0.695545    
# Group:run_index7  0.38254    0.11543   3.314 0.000919 ***
# Group:run_index8  0.44973    0.11497   3.912 9.16e-05 ***

# condition effects on the proportion of Go decisions

null.model <- glmer(go ~ (1|scores.SID), data=allTDSfMRI, family='binomial')
condition.model <- glmer(go ~ condition + (1|scores.SID), data=allTDSfMRI, family='binomial')
interaction.model <- glmer(go ~ Group*condition + (1|scores.SID), data= allTDSfMRI, family='binomial', control=glmerControl(optimizer="bobyqa"))
anova(condition.model, interaction.model)

#                   Df   AIC   BIC logLik deviance  Chisq Chi Df Pr(>Chisq)    
# condition.model    4 21105 21136 -10548    21097                             
# interaction.model  7 21086 21140 -10536    21072 24.602      3   1.87e-05 ***

anova(null.model, condition.model)
#                 Df   AIC   BIC logLik deviance  Chisq Chi Df Pr(>Chisq)    
# null.model       2 21122 21138 -10559    21118                             
# condition.model  4 21105 21136 -10548    21097 21.365      2  2.294e-05 ***

summary(interaction.model)
# Fixed effects:
#                  Estimate Std. Error z value Pr(>|z|)    
# (Intercept)      -0.57910    0.20907  -2.770  0.00561 ** 
# Group            -0.02004    0.13184  -0.152  0.87919    
# condition3        0.01529    0.12890   0.119  0.90560    
# condition4       -0.38863    0.13072  -2.973  0.00295 ** 
# Group:condition3  0.07838    0.08129   0.964  0.33496    
# Group:condition4  0.37574    0.08185   4.591 4.42e-06 ***


social_df_TDSall <- allTDSfMRI %>% filter(condition != "2")

null.model <- glmer(go ~ (1|scores.SID), data=social_df_TDSall, family='binomial')
condition.model <- glmer(go ~ condition + (1|scores.SID), data=social_df_TDSall, family='binomial')
interaction.model <- glmer(go ~ Group*condition + (1|scores.SID), data= social_df_TDSall, family='binomial', control=glmerControl(optimizer="bobyqa"))
anova(condition.model, interaction.model)  
#                   Df   AIC   BIC  logLik deviance  Chisq Chi Df Pr(>Chisq)    
# condition.model    3 14193 14214 -7093.3    14187                             
# interaction.model  5 14181 14217 -7085.3    14171 16.045      2  0.0003279 ***

anova(null.model, condition.model)  
#                 Df   AIC   BIC  logLik deviance  Chisq Chi Df Pr(>Chisq)
# null.model       2 14192 14207 -7094.0    14188                         
# condition.model  3 14193 14214 -7093.3    14187 1.4035      1     0.2361

summary(interaction.model) 
# Fixed effects:
#                  Estimate Std. Error z value Pr(>|z|)    
# (Intercept)      -0.55162    0.20538  -2.686 0.007236 ** 
# Group             0.05357    0.12942   0.414 0.678920    
# condition4       -0.40660    0.13051  -3.116 0.001836 ** 
# Group:condition4  0.29853    0.08147   3.664 0.000248 ***



# Run effects on the proportion of Go decisions that resulted in Crashes
null.model <- glmer(go_cr ~ (1|scores.SID), data=allTDSfMRI, family='binomial')
run.model <- glmer(go_cr ~ run_index + (1|scores.SID), data=allTDSfMRI, family='binomial', control=glmerControl(optimizer="bobyqa"))
interaction.model <- glmer(go_cr ~ Group*run_index + (1|scores.SID), data= allTDSfMRI, family='binomial', control=glmerControl(optimizer="bobyqa"))
anova(run.model, interaction.model) 
#                   Df   AIC   BIC  logLik deviance  Chisq Chi Df Pr(>Chisq)  
# run.model          7 16239 16293 -8112.3    16225                           
# interaction.model 13 16238 16338 -8105.8    16212 12.949      6    0.04385 *
anova(null.model, run.model) 
#            Df   AIC   BIC  logLik deviance  Chisq Chi Df Pr(>Chisq)
# null.model  2 16232 16247 -8114.0    16228                         
# run.model   7 16239 16293 -8112.3    16225 3.3702      5     0.6431

summary(interaction.model) 

# Fixed effects:
#                  Estimate Std. Error z value Pr(>|z|)    
# (Intercept)      -1.39188    0.20365  -6.835 8.22e-12 ***
# Group            -0.08651    0.12904  -0.670  0.50263    
# run_index4       -0.18694    0.21795  -0.858  0.39104    
# run_index5       -0.21926    0.21796  -1.006  0.31444    
# run_index6        0.01569    0.21512   0.073  0.94186    
# run_index7       -0.37825    0.21977  -1.721  0.08523 .  
# run_index8       -0.50380    0.22002  -2.290  0.02203 *  
# Group:run_index4  0.13898    0.13787   1.008  0.31341    
# Group:run_index5  0.17131    0.13768   1.244  0.21340    
# roup:run_index6  0.04463    0.13663   0.327  0.74393    
# Group:run_index7  0.31277    0.13759   2.273  0.02302 *  
# Group:run_index8  0.38831    0.13752   2.824  0.00475 ** 



# Condition effects on the proportion of Go decisions that resulted in Crashes
null.model <- glmer(go_cr ~ (1|scores.SID), data=allTDSfMRI, family='binomial')
condition.model <- glmer(go_cr ~ condition + (1|scores.SID), data=allTDSfMRI, family='binomial')
interaction.model <- glmer(go_cr ~ Group*condition + (1|scores.SID), data= allTDSfMRI, family='binomial', control=glmerControl(optimizer="bobyqa"))
anova(condition.model, interaction.model)         
#                   Df   AIC   BIC  logLik deviance Chisq Chi Df Pr(>Chisq)  
# condition.model    4 16233 16264 -8112.5    16225                          
# interaction.model  7 16228 16282 -8107.2    16214 10.78      3    0.01297 *
anova(null.model, condition.model)         
#                 Df   AIC   BIC  logLik deviance  Chisq Chi Df Pr(>Chisq)
# null.model       2 16232 16247 -8114.0    16228                         
# condition.model  4 16233 16264 -8112.5    16225 2.8337      2     0.2425
summary(interaction.model) 
# Fixed effects:
#                   Estimate Std. Error z value Pr(>|z|)    
# (Intercept)      -1.485622   0.172274  -8.624  < 2e-16 ***
# Group            -0.016561   0.108696  -0.152  0.87890    
# condition3       -0.006357   0.153019  -0.042  0.96686    
# condition4       -0.347322   0.155694  -2.231  0.02569 *  
# Group:condition3  0.037206   0.096632   0.385  0.70022    
# Group:condition4  0.280643   0.097068   2.891  0.00384 ** 

null.model <- glmer(go_cr ~ (1|scores.SID), data=social_df_TDSall, family='binomial')
condition.model <- glmer(go_cr ~ condition + (1|scores.SID), data=social_df_TDSall, family='binomial')
interaction.model <- glmer(go_cr ~ Group*condition + (1|scores.SID), data= social_df_TDSall, family='binomial', control=glmerControl(optimizer="bobyqa"))
anova(condition.model, interaction.model)         
#                   Df   AIC   BIC  logLik deviance Chisq Chi Df Pr(>Chisq)  
# condition.model    3 10942 10964 -5468.3    10936                          
# interaction.model  5 10938 10974 -5463.9    10928 8.696      2    0.01293 *
anova(null.model, condition.model)         
#                 Df   AIC   BIC  logLik deviance  Chisq Chi Df Pr(>Chisq)
# null.model       2 10941 10956 -5468.5    10937                         
# condition.model  3 10942 10964 -5468.3    10936 0.4156      1     0.5191
summary(interaction.model) 
# Fixed effects:
#                  Estimate Std. Error z value Pr(>|z|)    
# (Intercept)      -1.48133    0.16382  -9.043   <2e-16 ***
# Group             0.01979    0.10316   0.192   0.8479    
# condition4       -0.34155    0.15503  -2.203   0.0276 *  
# Group:condition4  0.24350    0.09643   2.525   0.0116 *    


# Run effects on the proportion of Stop decisions
null.model <- glmer(stop ~ (1|scores.SID), data=allTDSfMRI, family='binomial')
run.model <- glmer(stop ~ run_index + (1|scores.SID), data=allTDSfMRI, family='binomial')
interaction.model <- glmer(stop ~ Group*run_index + (1|scores.SID), data= allTDSfMRI, family='binomial', control=glmerControl(optimizer="bobyqa"))

anova(run.model, interaction.model)
#                   Df   AIC   BIC logLik deviance  Chisq Chi Df Pr(>Chisq)    
# run.model          7 21610 21664 -10798    21596                             
# interaction.model 13 21586 21686 -10780    21560 36.719      6  1.997e-06 ***

anova(null.model, run.model)
#            Df   AIC   BIC logLik deviance  Chisq Chi Df Pr(>Chisq)
# null.model  2 21608 21623 -10802    21604                         
# run.model   7 21610 21664 -10798    21596 7.5574      5     0.1824

summary(interaction.model)
# Fixed effects:
#                  Estimate Std. Error z value Pr(>|z|)    
# (Intercept)       0.02895    0.21632   0.134 0.893527    
# Group             0.20793    0.13669   1.521 0.128218    
# run_index4        0.26261    0.17877   1.469 0.141850    
# run_index5        0.43553    0.17866   2.438 0.014777 *  
# run_index6        0.13771    0.17830   0.772 0.439908    
# run_index7        0.64869    0.18093   3.585 0.000337 ***
# run_index8        0.77648    0.18023   4.308 1.64e-05 ***
# Group:run_index4 -0.13454    0.11322  -1.188 0.234723    
# Group:run_index5 -0.29133    0.11296  -2.579 0.009910 ** 
# Group:run_index6 -0.12497    0.11288  -1.107 0.268261    
# Group:run_index7 -0.46398    0.11376  -4.079 4.53e-05 ***
# Group:run_index8 -0.56379    0.11343  -4.970 6.69e-07 ***


## Condition effects on the proportion of Stop decisions
null.model <- glmer(stop ~ (1|scores.SID), data=allTDSfMRI, family='binomial')
condition.model <- glmer(stop ~ condition + (1|scores.SID), data=allTDSfMRI, family='binomial')
interaction.model <- glmer(stop ~ Group*condition + (1|scores.SID), data= allTDSfMRI, family='binomial', control=glmerControl(optimizer="bobyqa"))
anova(condition.model, interaction.model)
#                   Df   AIC   BIC logLik deviance  Chisq Chi Df Pr(>Chisq)    
# condition.model    4 21606 21637 -10799    21598                             
# interaction.model  7 21580 21634 -10783    21566 32.358      3  4.399e-07 ***

anova(null.model, condition.model)
#                 Df   AIC   BIC logLik deviance  Chisq Chi Df Pr(>Chisq)  
# null.model       2 21608 21623 -10802    21604                           
# condition.model  4 21606 21637 -10799    21598 5.5233      2    0.06319 .

summary(interaction.model) 
# Fixed effects:
#                  Estimate Std. Error z value Pr(>|z|)    
# (Intercept)       0.15979    0.19723   0.810    0.418    
# Group             0.14089    0.12451   1.132    0.258    
# condition3        0.15529    0.12639   1.229    0.219    
# condition4        0.58188    0.12809   4.543 5.55e-06 ***
# Group:condition3 -0.14087    0.07994  -1.762    0.078 .  
# Group:condition4 -0.44692    0.08051  -5.551 2.84e-08 ***

null.model <- glmer(stop ~ (1|scores.SID), data=social_df_TDSall, family='binomial')
condition.model <- glmer(stop ~ condition + (1|scores.SID), data=social_df_TDSall, family='binomial')
interaction.model <- glmer(stop ~ Group*condition + (1|scores.SID), data= social_df_TDSall, family='binomial', control=glmerControl(optimizer="bobyqa"))
anova(condition.model, interaction.model)
#                   Df   AIC   BIC  logLik deviance  Chisq Chi Df Pr(>Chisq)    
# condition.model    3 14426 14448 -7210.1    14420                             
# interaction.model  5 14414 14451 -7202.2    14404 15.933      2  0.0003469 ***
anova(null.model, condition.model)
#                 Df   AIC   BIC  logLik deviance  Chisq Chi Df Pr(>Chisq)
# null.model       2 14425 14440 -7210.6    14421                         
# condition.model  3 14426 14448 -7210.1    14420 0.9029      1      0.342
summary(interaction.model)
# Fixed effects:
#                  Estimate Std. Error z value Pr(>|z|)    
# (Intercept)       0.32087    0.20042   1.601 0.109371    
# Group            -0.00370    0.12638  -0.029 0.976644    
# condition4        0.42439    0.12860   3.300 0.000966 ***
# Group:condition4 -0.30493    0.08056  -3.785 0.000154 ***


# Run effects on the proportion of Bad Stop decisions
null.model <- glmer(stop_nocar ~ (1|scores.SID), data=allTDSfMRI, family='binomial')
run.model <- glmer(stop_nocar ~ run_index + (1|scores.SID), data=allTDSfMRI, family='binomial')
interaction.model <- glmer(stop_nocar ~ Group*run_index + (1|scores.SID), data= allTDSfMRI, family='binomial', control=glmerControl(optimizer="bobyqa"))

anova(run.model, interaction.model)
#                   Df   AIC   BIC  logLik deviance  Chisq Chi Df Pr(>Chisq)
# null.model         2 19499 19514 -9747.5    19495                         
# interaction.model 13 19506 19606 -9739.9    19480 15.316     11     0.1685
anova(null.model, run.model)
#            Df   AIC   BIC  logLik deviance  Chisq Chi Df Pr(>Chisq)
# null.model  2 19499 19514 -9747.5    19495                         
# run.model   7 19503 19557 -9744.6    19489 5.8402      5     0.3221
summary(interaction.model)
# Fixed effects:
#                  Estimate Std. Error z value Pr(>|z|)    
# (Intercept)      -1.11413    0.16067  -6.934 4.08e-12 ***
# Group             0.11657    0.10084   1.156   0.2477    
# run_index4        0.08858    0.19097   0.464   0.6428    
# run_index5        0.22079    0.19183   1.151   0.2498    
# run_index6        0.02948    0.19255   0.153   0.8783    
# run_index7        0.28623    0.19336   1.480   0.1388    
# run_index8        0.34023    0.19348   1.758   0.0787 .  
# Group:run_index4 -0.03378    0.11976  -0.282   0.7779    
# Group:run_index5 -0.17301    0.12081  -1.432   0.1521    
# Group:run_index6 -0.04465    0.12077  -0.370   0.7116    
# Group:run_index7 -0.22423    0.12155  -1.845   0.0651 .  
# Group:run_index8 -0.29111    0.12208  -2.385   0.0171 *     


# Condition effects on the proportion of Stop decisions
null.model <- glmer(stop_nocar ~ (1|scores.SID), data=allTDSfMRI, family='binomial')
condition.model <- glmer(stop_nocar ~ condition + (1|scores.SID), data=allTDSfMRI, family='binomial')
interaction.model <- glmer(stop_nocar ~ Group*condition + (1|scores.SID), data= allTDSfMRI, family='binomial', control=glmerControl(optimizer="bobyqa"))

anova(condition.model, interaction.model)
#                   Df   AIC   BIC  logLik deviance Chisq Chi Df Pr(>Chisq)  
# condition.model    4 19498 19529 -9745.1    19490                          
# interaction.model  7 19496 19550 -9741.1    19482 7.963      3    0.04678 *
anova(null.model, condition.model)
#                 Df   AIC   BIC  logLik deviance  Chisq Chi Df Pr(>Chisq)  
# null.model       2 19499 19514 -9747.5    19495                           
# condition.model  4 19498 19529 -9745.1    19490 4.8962      2    0.08646 .
summary(interaction.model) 
# Fixed effects:
#                  Estimate Std. Error z value Pr(>|z|)    
# (Intercept)      -1.06957    0.12797  -8.358  < 2e-16 ***
# Group             0.09954    0.08048   1.237  0.21612    
# condition3        0.08065    0.13497   0.598  0.55014    
# condition4        0.26822    0.13604   1.972  0.04865 *  
# Group:condition3 -0.09173    0.08489  -1.081  0.27989    
# Group:condition4 -0.24023    0.08571  -2.803  0.00507 ** 


#within social bad stops 
null.model <- glmer(stop_nocar ~ (1|scores.SID), data=social_df_TDSall, family='binomial')
condition.model <- glmer(stop_nocar ~ condition + (1|scores.SID), data=social_df_TDSall, family='binomial')
interaction.model <- glmer(stop_nocar ~ Group*condition + (1|scores.SID), data= social_df_TDSall, family='binomial', control=glmerControl(optimizer="bobyqa"))

anova(condition.model, interaction.model)
#                   Df   AIC   BIC  logLik deviance  Chisq Chi Df Pr(>Chisq)
# condition.model    3 12873 12894 -6433.3    12867                         
# interaction.model  5 12873 12909 -6431.4    12863 3.7764      2     0.1513

anova(null.model, condition.model)
#                 Df   AIC   BIC  logLik deviance  Chisq Chi Df Pr(>Chisq)
# null.model       2 12871 12886 -6433.6    12867                         
# condition.model  3 12873 12894 -6433.3    12867 0.6945      1     0.4046

summary(interaction.model) 

# Fixed effects:
#                   Estimate Std. Error z value Pr(>|z|)    
# (Intercept)      -0.991326   0.130025  -7.624 2.46e-14 ***
# Group             0.008618   0.081998   0.105   0.9163    
# condition4        0.187353   0.136582   1.372   0.1701    
# Group:condition4 -0.148427   0.086250  -1.721   0.0853 .  


```


```{r}

# qualtrics data
RPI_TDS2 <- read.csv(paste(qualtrics_folder,'scoring_script_output/tds2-wave1-RPI_part2.csv', sep='') )
NTS_TDS2 <- read.csv(paste(qualtrics_folder,'scoring_script_output/tds2-wave1-NTS.csv' , sep=''))                               
BIS_TDS2 <- read.csv(paste(qualtrics_folder,'scoring_script_output/tds2-wave1-BIS_15.csv' , sep=''))                               
BSSS_TDS2 <- read.csv(paste(qualtrics_folder,'scoring_script_output/tds2-wave1-BSSS.csv' , sep=''))                               
SPSRQ_TDS2 <- read.csv(paste(qualtrics_folder,'scoring_script_output/tds2-wave1-SPSRQ_S.csv' , sep='')) %>% select(scores.SID, scores.sensitivity_punishment_mean, scores.sensitivity_reward_mean)

# merge qualtrics data
qualtrics_merge1_TDS2<-merge(RPI_TDS2, NTS_TDS2, by = 'scores.SID') %>% select(scores.SID, scores.rpi_mean, scores.belongingness, scores.control, scores.meaningful_existence, scores.self_esteem, scores.total_score)

qualtrics_merge2_TDS2<-merge(BIS_TDS2, BSSS_TDS2, by = 'scores.SID') %>% select(scores.SID, scores.bis_attentional_impulsivity, scores.bis_motor_impulsivity, scores.bis_nonplanning_impulsivity, scores.bis_total, scores.sss_boredom_susceptibility, scores.sss_disinhibition, scores.sss_experience_seeking, scores.sss_thrill_adventure_seeking, scores.sss_total)
qualtrics_merge3_TDS2<-merge(qualtrics_merge1_TDS2, qualtrics_merge2_TDS2, by = 'scores.SID')

RWR_qualtrics_data_TDS2 <- merge(qualtrics_merge3_TDS2, SPSRQ_TDS2, by = 'scores.SID')

no_session2 = c(118, 123, 147, 148, 149, 153, 154, 166, 180)
behaviorals = c(103, 107, 112, 138, 143, 176, 191)
pilot_cyberball = c(101, 102, 104, 105, 106, 108, 110, 111)
motion_dropout = c(189, 158, 139)

RWR_filtered_TDS2 <- RWR_qualtrics_data_TDS2 %>% filter(scores.SID < 300) %>% 
  filter(!scores.SID %in% no_session2) %>% 
  filter(!scores.SID %in% behaviorals)%>%
  filter(!scores.SID %in% pilot_cyberball)%>%
  filter(!scores.SID %in% motion_dropout)
  

install.packages("summarytools")
library(summarytools)
#check ranges of variables first
view(dfSummary(RWR_filtered_TDS2))

df_RWR_fMRI_TDS2 <- left_join(df_fMRI_all_TDS2, RWR_filtered_TDS2, by= "scores.SID")

colnames(df_RWR_fMRI_TDS2)[which(names(df_RWR_fMRI_TDS2) == "scores.sensitivity_punishment_mean")] <- "scores.sensitivity_punishment"

colnames(df_RWR_fMRI_TDS2)[which(names(df_RWR_fMRI_TDS2) == "scores.sensitivity_reward_mean")] <- "scores.sensitivity_reward"

# Remove columns that are not congruent between TDS 1 and TDS 2
df_RWR_fMRI$group = NULL

df_RWR_fMRI_TDS_ALL <- rbind(df_RWR_fMRI, df_RWR_fMRI_TDS2)


```


##################################
# TASK CORRELATIONS RISK WITH RWB
##################################
```{r}
#are risk decisions in the scanner correlated with impuslivity and sensation seeking out of the scanner?
null.model <- aov(scores.bis_total ~ go + (1|scores.SID), data=df_RWR_fMRI_TDS_ALL)
main.model <- aov(scores.bis_total ~ go + condition + (1|scores.SID), data=df_RWR_fMRI_TDS_ALL)
interaction.model <- aov(scores.bis_total ~ go*condition + (1|scores.SID), data=df_RWR_fMRI_TDS_ALL)
group.model <- aov(scores.bis_total ~ go*condition*Group + (1|scores.SID), data=df_RWR_fMRI_TDS_ALL) 
anova(null.model, main.model)
#   Res.Df    RSS Df Sum of Sq      F Pr(>F)
# 1  15978 3238.8                           
# 2  15976 3238.1  2   0.70703 1.7442 0.1748
anova(main.model, interaction.model)
#   Res.Df    RSS Df Sum of Sq      F Pr(>F)
# 1  15976 3238.1                           
# 2  15974 3237.9  2   0.23056 0.5687 0.5662
anova(interaction.model, group.model)
#   Res.Df    RSS Df Sum of Sq      F    Pr(>F)    
# 1  15974 3237.9                                  
# 2  15968 3199.3  6    38.595 32.105 < 2.2e-16 ***

summary(group.model)
#                       Df Sum Sq Mean Sq F value   Pr(>F)    
# go                     1      2    2.42  12.101 0.000505 ***
# condition              2      1    0.35   1.764 0.171315    
# Group                  1     35   35.24 175.911  < 2e-16 ***
# go:condition           2      0    0.03   0.174 0.840435    
# go:Group               1      0    0.47   2.346 0.125604    
# condition:Group        2      1    0.42   2.090 0.123778    
# go:condition:Group     2      2    1.10   5.499 0.004099 ** 
# Residuals          15968   3199    0.20 

null.model <- aov(scores.sss_total ~ go + (1|scores.SID), data=df_RWR_fMRI_TDS_ALL)
main.model <- aov(scores.sss_total ~ go + condition + (1|scores.SID), data=df_RWR_fMRI_TDS_ALL)
interaction.model <- aov(scores.sss_total ~ go*condition + (1|scores.SID), data=df_RWR_fMRI_TDS_ALL)
group.model <- aov(scores.sss_total ~ go*condition*Group + (1|scores.SID), data=df_RWR_fMRI_TDS_ALL) 

anova(null.model, main.model)
#   Res.Df    RSS Df Sum of Sq      F Pr(>F)
# 1  15978 1168.6                           
# 2  15976 1168.6  2 0.0088448 0.0605 0.9413
anova(null.model, interaction.model)
#   Res.Df    RSS Df Sum of Sq      F Pr(>F)
# 1  15978 1168.6                           
# 2  15974 1168.6  4  0.020935 0.0715 0.9907
anova(null.model, group.model)
#   Res.Df    RSS Df Sum of Sq      F  Pr(>F)  
# 1  15978 1168.6                              
# 2  15968 1167.1 10    1.5138 2.0711 0.02326 *
summary(group.model)
#                       Df Sum Sq Mean Sq F value   Pr(>F)    
# go                     1    0.0  0.0000   0.000    0.985    
# condition              2    0.0  0.0044   0.061    0.941    
# Group                  1    1.3  1.3209  18.072 2.14e-05 ***
# go:condition           2    0.0  0.0028   0.038    0.963    
# go:Group               1    0.0  0.0444   0.608    0.436    
# condition:Group        2    0.0  0.0049   0.067    0.935    
# go:condition:Group     2    0.1  0.0621   0.850    0.428    
# Residuals          15968 1167.1  0.0731

null.model <- aov(scores.sensitivity_reward ~ go + (1|scores.SID), data=df_RWR_fMRI_TDS_ALL)
main.model <- aov(scores.sensitivity_reward ~ go + condition + (1|scores.SID), data=df_RWR_fMRI_TDS_ALL)
interaction.model <- aov(scores.sensitivity_reward ~ go*condition + (1|scores.SID), data=df_RWR_fMRI_TDS_ALL)
group.model <- aov(scores.sensitivity_reward ~ go*condition*Group + (1|scores.SID), data=df_RWR_fMRI_TDS_ALL) 
anova(null.model, main.model)
#   Res.Df    RSS Df Sum of Sq      F Pr(>F)
# 1  15978 1046.3                           
# 2  15976 1046.3  2  0.072149 0.5508 0.5765
anova(null.model, interaction.model)
#   Res.Df    RSS Df Sum of Sq      F Pr(>F)
# 1  15978 1046.3                           
# 2  15974 1046.1  4   0.21751 0.8303 0.5056
anova(null.model, group.model)
#   Res.Df    RSS Df Sum of Sq      F    Pr(>F)    
# 1  15978 1046.3                                  
# 2  15968 1040.0 10    6.3739 9.7867 < 2.2e-16 ***
summary(group.model)
#                       Df Sum Sq Mean Sq F value  Pr(>F)    
# go                     1    0.5   0.455   6.987 0.00822 ** 
# condition              2    0.1   0.036   0.554 0.57472    
# Group                  1    5.7   5.733  88.022 < 2e-16 ***
# go:condition           2    0.1   0.051   0.788 0.45472    
# go:Group               1    0.3   0.275   4.229 0.03975 *  
# condition:Group        2    0.1   0.042   0.642 0.52625    
# go:condition:Group     2    0.1   0.054   0.824 0.43856    
# Residuals          15968 1040.0   0.065

null.model <- aov(scores.sensitivity_punishment ~ go + (1|scores.SID), data=df_RWR_fMRI_TDS_ALL)
main.model <- aov(scores.sensitivity_punishment ~ go + condition + (1|scores.SID), data=df_RWR_fMRI_TDS_ALL)
interaction.model <- aov(scores.sensitivity_punishment ~ go*condition + (1|scores.SID), data=df_RWR_fMRI_TDS_ALL)
group.model <- aov(scores.sensitivity_punishment ~ go*condition*Group + (1|scores.SID), data=df_RWR_fMRI_TDS_ALL) 

anova(null.model, main.model)
#   Res.Df    RSS Df Sum of Sq      F Pr(>F)
# 1  16098 1017.5                           
# 2  16096 1017.4  2  0.080038 0.6331 0.5309
anova(null.model, interaction.model)
#   Res.Df    RSS Df Sum of Sq      F Pr(>F)
# 1  16098 1017.5                           
# 2  16094 1017.1  4   0.31374 1.2411  0.291
anova(null.model, group.model)
#   Res.Df    RSS Df Sum of Sq      F    Pr(>F)    
# 1  16098 1017.5                                  
# 2  16088 1010.0 10    7.4789 11.913 < 2.2e-16 ***
summary(group.model)
#                       Df Sum Sq Mean Sq F value   Pr(>F)    
# go                     1    0.8   0.796  12.672 0.000372 ***
# condition              2    0.1   0.040   0.637 0.528644    
# Group                  1    4.9   4.854  77.327  < 2e-16 ***
# go:condition           2    0.2   0.084   1.339 0.262210    
# go:Group               1    2.1   2.060  32.813 1.03e-08 ***
# condition:Group        2    0.1   0.036   0.569 0.566080    
# go:condition:Group     2    0.2   0.122   1.950 0.142267    
# Residuals          16088 1010.0   0.063          


null.model <- aov(scores.total_score ~ go + (1|scores.SID), data=df_RWR_fMRI_TDS_ALL)
main.model <- aov(scores.total_score ~ go + condition + (1|scores.SID), data=df_RWR_fMRI_TDS_ALL)
interaction.model <- aov(scores.total_score ~ go*condition + (1|scores.SID), data=df_RWR_fMRI_TDS_ALL)
group.model <- aov(scores.total_score ~ go*condition*Group + (1|scores.SID), data=df_RWR_fMRI_TDS_ALL) 

anova(null.model, main.model)
#   Res.Df    RSS Df Sum of Sq      F Pr(>F)
# 1  16098 7805.6                           
# 2  16096 7805.6  2 0.0025031 0.0026 0.9974
anova(null.model, interaction.model)
#   Res.Df    RSS Df Sum of Sq      F Pr(>F)
# 1  16098 7805.6                           
# 2  16094 7804.1  4    1.4515 0.7484 0.5589
anova(null.model, group.model)
#   Res.Df    RSS Df Sum of Sq      F    Pr(>F)    
# 1  16098 7805.6                                  
# 2  16088 7702.8 10    102.72 21.453 < 2.2e-16 ***
summary(group.model)
#                       Df Sum Sq Mean Sq F value   Pr(>F)    
# go                     1      6    6.03  12.605 0.000386 ***
# condition              2      0    0.00   0.003 0.997389    
# Group                  1     97   96.62 201.801  < 2e-16 ***
# go:condition           2      1    0.37   0.773 0.461747    
# go:Group               1      2    1.66   3.467 0.062623 .  
# condition:Group        2      0    0.03   0.054 0.947839    
# go:condition:Group     2      4    1.82   3.803 0.022325 *

null.model <- aov(scores.rpi_mean ~ go + (1|scores.SID), data=df_RWR_fMRI_TDS_ALL)
main.model <- aov(scores.rpi_mean ~ go + condition + (1|scores.SID), data=df_RWR_fMRI_TDS_ALL)
interaction.model <- aov(scores.rpi_mean ~ go*condition + (1|scores.SID), data=df_RWR_fMRI_TDS_ALL)
group.model <- aov(scores.rpi_mean ~ go*condition*Group + (1|scores.SID), data=df_RWR_fMRI_TDS_ALL) 

anova(null.model, main.model)
#   Res.Df    RSS Df Sum of Sq      F Pr(>F)
# 1  16098 4512.0                           
# 2  16096 4511.9  2   0.14341 0.2558 0.7743
anova(null.model, interaction.model)
#   Res.Df    RSS Df Sum of Sq      F Pr(>F)
# 1  16098 4512.0                           
# 2  16094 4511.7  4   0.33071 0.2949 0.8814
anova(null.model, group.model)
#   Res.Df    RSS Df Sum of Sq     F    Pr(>F)    
# 1  16098 4512.0                                 
# 2  16088 4422.5 10    89.507 32.56 < 2.2e-16 ***
summary(group.model)
#                       Df Sum Sq Mean Sq F value  Pr(>F)    
# go                     1      0    0.26   0.958 0.32774    
# condition              2      0    0.07   0.261 0.77041    
# Group                  1     86   85.55 311.201 < 2e-16 ***
# go:condition           2      0    0.01   0.027 0.97383    
# go:Group               1      2    2.41   8.768 0.00307 ** 
# condition:Group        2      0    0.07   0.238 0.78804    
# go:condition:Group     2      1    0.63   2.290 0.10128    
# Residuals          16088   4423    0.27      


```

###########################################################################################################
SUPPLEMENTAL 
###########################################################################################################


################################################################
## Age effects on GO DECISIONS while controlling for Sex & IQ ##
################################################################
```{r}
# Linear Age effects on the proportion of Go decisions (by run_index)
null.model <- glmer(go ~ run_index + gender + iq_z + (1|scores.SID), data=allTDSfMRI, family='binomial')
main.model <- glmer(go ~ age_c + run_index + gender + iq_z + (1|scores.SID), data=allTDSfMRI, family='binomial')
interaction.model <- glmer(go ~ age_c * run_index + gender + iq_z + (1|scores.SID), data=allTDSfMRI, family='binomial')
group.model <- glmer(go ~ age_c * run_index * Group + gender + iq_z + (1|scores.SID), data=allTDSfMRI, family='binomial')
anova(null.model, group.model)
#             Df   AIC   BIC logLik deviance  Chisq Chi Df Pr(>Chisq)    
# null.model   9 21083 21152 -10532    21065                             
# group.model 27 21056 21264 -10501    21002 63.518     18  5.459e-07 ***
anova(null.model, main.model)
#            Df   AIC   BIC logLik deviance  Chisq Chi Df Pr(>Chisq)  
# null.model  9 21083 21152 -10532    21065                           
# main.model 10 21081 21158 -10530    21061 4.0832      1    0.04331 *

anova(null.model, interaction.model)
#                   Df   AIC   BIC logLik deviance  Chisq Chi Df Pr(>Chisq)  
# null.model         9 21083 21152 -10532    21065                           
# interaction.model 15 21078 21194 -10524    21048 16.539      6    0.01114 *
summary(interaction.model)
# Fixed effects:
#                  Estimate Std. Error z value Pr(>|z|)    
# (Intercept)      -0.46929    0.08793  -5.337 9.45e-08 ***
# age_c             0.05522    0.04256   1.298  0.19440    
# run_index4       -0.04534    0.05790  -0.783  0.43363    
# run_index5        0.08977    0.05750   1.561  0.11849    
# run_index6        0.13086    0.05741   2.280  0.02264 *  
# run_index7        0.13437    0.05779   2.325  0.02006 *  
# run_index8        0.18293    0.05765   3.173  0.00151 ** 
# gender1          -0.22224    0.11467  -1.938  0.05262 .  
# iq_z              0.03765    0.06665   0.565  0.57216    
# age_c:run_index4  0.02599    0.03607   0.721  0.47118    
# age_c:run_index5  0.01834    0.03583   0.512  0.60874    
# age_c:run_index6  0.01474    0.03577   0.412  0.68028    
# age_c:run_index7 -0.03976    0.03593  -1.106  0.26855    
# age_c:run_index8  0.08301    0.03587   2.314  0.02065 * 
summary(main.model)
# Fixed effects:
#             Estimate Std. Error z value Pr(>|z|)    
# (Intercept) -0.47040    0.08788  -5.353 8.67e-08 ***
# age_c        0.07232    0.03561   2.031  0.04226 *  
# run_index4  -0.04357    0.05784  -0.753  0.45121    
# run_index5   0.09094    0.05745   1.583  0.11344    
# run_index6   0.13180    0.05736   2.298  0.02158 *  
# run_index7   0.13303    0.05777   2.303  0.02129 *  
# run_index8   0.18799    0.05752   3.268  0.00108 ** 
# gender1     -0.22206    0.11461  -1.938  0.05268 .  
# iq_z         0.03764    0.06660   0.565  0.57199 

summary(group.model)
# Fixed effects:
#                         Estimate Std. Error z value Pr(>|z|)    
# (Intercept)            -0.318918   0.220931  -1.444 0.148874    
# age_c                   0.048526   0.130725   0.371 0.710483    
# run_index4             -0.171942   0.183659  -0.936 0.349169    
# run_index5             -0.211070   0.182819  -1.155 0.248283    
# run_index6              0.037590   0.182688   0.206 0.836980    
# run_index7             -0.450408   0.185048  -2.434 0.014933 *  
# run_index8             -0.520266   0.184779  -2.816 0.004869 ** 
# Group                  -0.090728   0.140223  -0.647 0.517615    
# gender1                -0.239342   0.114577  -2.089 0.036715 *  
# iq_z                    0.018181   0.069153   0.263 0.792623    
# age_c:run_index4        0.103534   0.111706   0.927 0.354010    
# age_c:run_index5        0.178386   0.111151   1.605 0.108518    
# age_c:run_index6        0.412894   0.111288   3.710 0.000207 ***
# age_c:run_index7        0.052274   0.111934   0.467 0.640495    
# age_c:run_index8        0.320885   0.112083   2.863 0.004197 ** 
# age_c:Group             0.004068   0.084755   0.048 0.961716    
# run_index4:Group        0.084245   0.115943   0.727 0.467464    
# run_index5:Group        0.199494   0.115196   1.732 0.083313 .  
# run_index6:Group        0.059978   0.115247   0.520 0.602764    
# run_index7:Group        0.384990   0.115899   3.322 0.000894 ***
# run_index8:Group        0.462452   0.115729   3.996 6.44e-05 ***
# age_c:run_index4:Group -0.053050   0.072345  -0.733 0.463376    
# age_c:run_index5:Group -0.109003   0.071870  -1.517 0.129352    
# age_c:run_index6:Group -0.272460   0.072152  -3.776 0.000159 ***
# age_c:run_index7:Group -0.062941   0.072079  -0.873 0.382545    
# age_c:run_index8:Group -0.160783   0.072036  -2.232 0.025617 *  


# Linear Age effects on the proportion of Go decisions (by location)
null.model <- glmer(go ~ condition + gender + iq_z + (1|scores.SID), data=allTDSfMRI, family='binomial')
main.model <- glmer(go ~ age_c + condition + gender + iq_z + (1|scores.SID), data=allTDSfMRI, family='binomial')
interaction.model <- glmer(go ~ age_c * condition + gender + iq_z + (1|scores.SID), data=allTDSfMRI, family='binomial')
group.model <- glmer(go ~ age_c * condition * Group + gender + iq_z + (1|scores.SID), data=allTDSfMRI, family='binomial')

anova(null.model, main.model)
#            Df   AIC   BIC logLik deviance Chisq Chi Df Pr(>Chisq)  
# null.model  6 21079 21125 -10534    21067                          
# main.model  7 21077 21131 -10532    21063 4.083      1    0.04332 *
anova(null.model, interaction.model)
#                   Df   AIC   BIC logLik deviance  Chisq Chi Df Pr(>Chisq)
# null.model         6 21079 21125 -10534    21067                         
# interaction.model  9 21081 21150 -10531    21063 4.2078      3     0.2399
anova(null.model, group.model)
#             Df   AIC   BIC logLik deviance Chisq Chi Df Pr(>Chisq)    
# null.model   6 21079 21125 -10534    21067                            
# group.model 15 21056 21172 -10513    21026 40.96      9  5.086e-06 ***
summary(main.model)
# Fixed effects:
#             Estimate Std. Error z value Pr(>|z|)    
# (Intercept) -0.49209    0.08301  -5.928 3.07e-09 ***
# age_c        0.07231    0.03560   2.031  0.04226 *  
# condition3   0.13314    0.04065   3.275  0.00106 ** 
# condition4   0.18243    0.04085   4.466 7.97e-06 ***
# gender1     -0.22210    0.11456  -1.939  0.05253 .  
# iq_z         0.03756    0.06659   0.564  0.57272   
summary(interaction.model)
# Fixed effects:
#                   Estimate Std. Error z value Pr(>|z|)    
# (Intercept)      -0.491832   0.083082  -5.920 3.22e-09 ***
# age_c             0.068111   0.038560   1.766  0.07733 .  
# condition3        0.132886   0.040688   3.266  0.00109 ** 
# condition4        0.181916   0.040883   4.450 8.60e-06 ***
# gender1          -0.222063   0.114677  -1.936  0.05282 .  
# iq_z              0.037664   0.066596   0.566  0.57170    
# age_c:condition3  0.003601   0.025334   0.142  0.88697    
# age_c:condition4  0.008913   0.025388   0.351  0.72554 

```
###############
## FIGURE 4A ##
###############
```{r}
#Part A: Go decisions plotted against Age
allTDSfMRI$pred_go <- predict(interaction.model, newdata=allTDSfMRI, re.form=NA, type='response')

fig_4a <- ggplot(data=allTDSfMRI, aes(x=s2_age, y=pred_go, color=condition)) +
  geom_line(aes(group=condition), size=1) +
  labs(x='Age', y='Predicted probability of Go decisions', color='Condition') +
  theme(text = element_text(size=16)) +
  scale_colour_discrete(labels=condition_labels)
ggsave('fig_4a.png', fig_4a)

pGo <- allTDSfMRI %>% group_by(scores.SID, condition) %>% summarize(pGo = mean(go))
pGo_by_age <- merge(pGo, demo, by = 'scores.SID')

ggplot(pGo_by_age, aes(x = s2_age, y = pGo, color=condition), stat_smooth(method = loess)) +
  geom_point() +
  geom_line(aes(group=condition), size=1) +
  #geom_errorbar(aes(ymax=mean + ci, ymin=mean - ci), width=0.5, position=position_dodge(.2)) +
  #facet_grid(.~condition, scales='free', labeller=as_labeller(condition_labels)) +
  labs(x='Age (mean-centered)', y='Proportion of Go decisions', color='Social Context')
```
######################################################################
## Age Group effects on GO DECISIONS while controlling for Sex & IQ ##
######################################################################
```{r}
# Age group effects on the proportion of Go decisions (by run_index)
# null.model <- glmer(go ~ run_index + gender + iq_z + (1|SID), data=df_fMRI, family='binomial')
# main.model <- glmer(go ~ age_group + run_index + gender + iq_z + (1|SID), data=df_fMRI, family='binomial')
# interaction.model <- glmer(go ~ age_group * run_index + gender + iq_z + (1|SID), data=df_fMRI, family='binomial', control=glmerControl(optimizer="bobyqa"))
# 
# anova(null.model, main.model)
# anova(null.model, interaction.model)
# anova(main.model, interaction.model)
# 
# summary(null.model)
# 
# # Age group effects on the proportion of Go decisions (by location)
# null.model <- glmer(go ~ condition + gender + iq_z + (1|SID), data=df_fMRI, family='binomial')
# main.model <- glmer(go ~ age_group + condition + gender + iq_z + (1|SID), data=df_fMRI, family='binomial')
# interaction.model <- glmer(go ~ age_group * condition + gender + iq_z + (1|SID), data=df_fMRI, family='binomial')
# 
# anova(null.model, main.model)
# anova(null.model, interaction.model)
# anova(main.model, interaction.model)
# 
# summary(null.model)
```
###########################################################
## Age effects on CRASHES while controlling for Sex & IQ ##
###########################################################
```{r}
# Age effects on the proportion of Go decisions that resulted in Crashes (by run_index)
null.model <- glmer(go_cr ~ run_index + gender + iq_z + (1|scores.SID), data=allTDSfMRI, family='binomial')
main.model <- glmer(go_cr ~ age_c + run_index + gender + iq_z + (1|scores.SID), data=allTDSfMRI, family='binomial')
interaction.model <- glmer(go_cr ~ age_c * run_index + gender + iq_z + (1|scores.SID), data=allTDSfMRI, family='binomial', control=glmerControl(optimizer="bobyqa"))
group.model <- glmer(go_cr ~ age_c * run_index * Group + gender + iq_z + (1|scores.SID), data=allTDSfMRI, family='binomial')

anova(null.model, main.model)
#            Df   AIC   BIC  logLik deviance  Chisq Chi Df Pr(>Chisq)
# null.model  9 16217 16286 -8099.6    16199                         
# main.model 10 16216 16294 -8098.2    16196 2.6157      1     0.1058
anova(null.model, interaction.model)
#                   Df   AIC   BIC  logLik deviance Chisq Chi Df Pr(>Chisq)  
# null.model         9 16217 16286 -8099.6    16199                          
# interaction.model 15 16216 16332 -8093.1    16186 12.95      6    0.04384 *
anova(null.model, group.model)
#             Df   AIC   BIC  logLik deviance Chisq Chi Df Pr(>Chisq)  
# null.model   9 16217 16286 -8099.6    16199                          
# group.model 27 16220 16429 -8083.2    16166 32.68     18    0.01824 *

summary(group.model)
# Fixed effects:
#                         Estimate Std. Error z value Pr(>|z|)    
# (Intercept)            -1.271044   0.200799  -6.330 2.45e-10 ***
# age_c                   0.071173   0.120174   0.592  0.55369    
# run_index4             -0.187955   0.218607  -0.860  0.38991    
# run_index5             -0.218323   0.218469  -0.999  0.31764    
# run_index6              0.004698   0.216285   0.022  0.98267    
# run_index7             -0.375319   0.220097  -1.705  0.08815 .  
# run_index8             -0.521639   0.221638  -2.354  0.01859 *  
# Group                  -0.109224   0.127862  -0.854  0.39298    
# gender1                -0.158429   0.087918  -1.802  0.07154 .  
# iq_z                    0.026314   0.053293   0.494  0.62147    
# age_c:run_index4        0.026463   0.133473   0.198  0.84284    
# age_c:run_index5        0.008698   0.133169   0.065  0.94792    
# age_c:run_index6        0.227175   0.132052   1.720  0.08537 .  
# age_c:run_index7        0.041101   0.133730   0.307  0.75858    
# age_c:run_index8        0.133067   0.133977   0.993  0.32061    
# age_c:Group            -0.035972   0.078506  -0.458  0.64680    
# run_index4:Group        0.139238   0.138208   1.007  0.31372    
# run_index5:Group        0.168642   0.137968   1.222  0.22159    
# run_index6:Group        0.048920   0.137249   0.356  0.72152    
# run_index7:Group        0.311226   0.137751   2.259  0.02386 *  
# run_index8:Group        0.392706   0.138333   2.839  0.00453 ** 
# age_c:run_index4:Group -0.008128   0.087071  -0.093  0.92562    
# age_c:run_index5:Group  0.024671   0.086686   0.285  0.77594    
# age_c:run_index6:Group -0.155872   0.086817  -1.795  0.07259 .  
# age_c:run_index7:Group -0.037483   0.086563  -0.433  0.66500    
# age_c:run_index8:Group -0.019006   0.086288  -0.220  0.82567

# Age effects on the proportion of Go decisions that resulted in Crashes (by location)
null.model <- glmer(go_cr ~ condition + gender + iq_z + (1|scores.SID), data=allTDSfMRI, family='binomial')
main.model <- glmer(go_cr ~ age_c + condition + gender + iq_z + (1|scores.SID), data=allTDSfMRI, family='binomial')
interaction.model <- glmer(go_cr ~ age_c * condition + gender + iq_z + (1|scores.SID), data=allTDSfMRI, family='binomial')
group.model <- glmer(go_cr ~ age_c * condition * Group + gender + iq_z + (1|scores.SID), data=allTDSfMRI, family='binomial')

anova(null.model, main.model)
#            Df   AIC   BIC  logLik deviance  Chisq Chi Df Pr(>Chisq)
# null.model  6 16212 16258 -8099.8    16200                         
# main.model  7 16211 16265 -8098.5    16197 2.6157      1     0.1058

anova(null.model, interaction.model)
#                   Df   AIC   BIC  logLik deviance Chisq Chi Df Pr(>Chisq)
# null.model         6 16212 16258 -8099.8    16200                        
# interaction.model  9 16214 16283 -8097.8    16196  4.14      3     0.2467
anova(null.model, group.model)
#             Df   AIC   BIC  logLik deviance  Chisq Chi Df Pr(>Chisq)  
# null.model   6 16212 16258 -8099.8    16200                           
# group.model 15 16213 16328 -8091.3    16183 17.043      9    0.04805 *

summary(group.model)
# Fixed effects:
#                        Estimate Std. Error z value Pr(>|z|)    
# (Intercept)            -1.36385    0.16846  -8.096 5.68e-16 ***
# age_c                   0.08326    0.09994   0.833  0.40479    
# condition3             -0.01482    0.15371  -0.096  0.92319    
# condition4             -0.35173    0.15624  -2.251  0.02437 *  
# Group                  -0.04012    0.10705  -0.375  0.70781    
# gender1                -0.15823    0.08783  -1.802  0.07162 .  
# iq_z                    0.02696    0.05324   0.506  0.61256    
# age_c:condition3        0.10499    0.09365   1.121  0.26222    
# age_c:condition4        0.07200    0.09454   0.762  0.44633    
# age_c:Group            -0.03925    0.06494  -0.604  0.54554    
# condition3:Group        0.04154    0.09698   0.428  0.66843    
# condition4:Group        0.28188    0.09734   2.896  0.00378 ** 
# age_c:condition3:Group -0.06111    0.06102  -1.001  0.31662    
# age_c:condition4:Group -0.02288    0.06081  -0.376  0.70674   
```
###############
## FIGURE 4B ##
###############
```{r}
# Part B: Crashes
crashes <- allTDSfMRI %>% distinct(scores.SID, gender_flip, condition, run_index, crash_count)


plot.crashes <- crashes %>% group_by(gender_flip, condition, run_index) %>%
  summarize(mean = mean(crash_count), sd = sd(crash_count), n = n(), se = sd/sqrt(n), ci=qt(0.975, df=n-1)*se)

ggplot(plot.crashes, aes(x = run_index, y = mean, color=gender_flip)) +
  geom_point(position=position_dodge(.1), size=3) +
  geom_line(aes(group=gender_flip), size=1) +
  # geom_errorbar(aes(ymax=mean + ci, ymin=mean - ci), width=0.5, position=position_dodge(.2)) +
  # facet_grid(.~condition, scales='free', labeller=as_labeller(condition_labels)) +
  labs(x='Run number', y='Crashes', color='Sex') +
  scale_y_continuous(breaks = c(3, 4, 5))
```

####################################################################
## Puberty effects on GO DECISIONS while controlling for Sex & IQ ##
####################################################################
```{r}
df_pds_allTDS <- allTDSfMRI %>% filter(!is.na(PDS_mean_score))


# Puberty effects on the proportion of Go decisions (by run_index)
null.model <- glmer(go ~ run_index + gender + iq_z + (1|scores.SID), data=df_pds_allTDS, family='binomial')
main.model <- glmer(go ~ PDS_mean_score + run_index + gender + iq_z + (1|scores.SID), data=df_pds_allTDS, family='binomial', control=glmerControl(optimizer="bobyqa"))
interaction.model <- glmer(go ~ PDS_mean_score * run_index + gender + iq_z + (1|scores.SID), data=df_pds_allTDS, family='binomial', control=glmerControl(optimizer="bobyqa"))
group.model <- glmer(go ~ PDS_mean_score * run_index * Group + gender + iq_z + (1|scores.SID), data=df_pds_allTDS, family='binomial')

anova(null.model, main.model)
#            Df   AIC   BIC  logLik deviance  Chisq Chi Df Pr(>Chisq)
# null.model  9 18553 18621 -9267.5    18535                         
# main.model 10 18555 18630 -9267.4    18535 0.2955      1     0.5867
anova(null.model, interaction.model)
#                  Df   AIC   BIC  logLik deviance  Chisq Chi Df Pr(>Chisq)
# null.model         9 18553 18621 -9267.5    18535                         
# interaction.model 15 18559 18672 -9264.3    18529 6.3491      6     0.3852
anova(null.model, group.model)
#             Df   AIC   BIC  logLik deviance Chisq Chi Df Pr(>Chisq)   
# null.model   9 18553 18621 -9267.5    18535                           
# group.model 27 18550 18755 -9248.3    18496  38.5     18   0.003324 **
summary(group.model)
# Fixed effects:
#                                 Estimate Std. Error z value Pr(>|z|)   
# (Intercept)                     -0.41939    0.91767  -0.457  0.64766   
# PDS_mean_score                   0.11102    0.32365   0.343  0.73157   
# run_index4                      -0.27265    0.78952  -0.345  0.72984   
# run_index5                      -1.03504    0.78159  -1.324  0.18541   
# run_index6                      -1.67019    0.78082  -2.139  0.03244 * 
# run_index7                      -0.51029    0.80072  -0.637  0.52393   
# run_index8                      -2.19708    0.79714  -2.756  0.00585 **
# Group                           -0.15931    0.57074  -0.279  0.78015   
# gender1                         -0.14200    0.13219  -1.074  0.28271   
# iq_z                             0.03749    0.07268   0.516  0.60599   
# PDS_mean_score:run_index4        0.06988    0.27816   0.251  0.80163   
# PDS_mean_score:run_index5        0.29465    0.27526   1.070  0.28442   
# PDS_mean_score:run_index6        0.60711    0.27493   2.208  0.02723 * 
# PDS_mean_score:run_index7        0.03252    0.28106   0.116  0.90788   
# PDS_mean_score:run_index8        0.63977    0.27928   2.291  0.02198 * 
# PDS_mean_score:Group            -0.02697    0.19927  -0.135  0.89233   
# run_index4:Group                 0.31639    0.49238   0.643  0.52050   
# run_index5:Group                 0.80720    0.48605   1.661  0.09677 . 
# run_index6:Group                 1.27561    0.48535   2.628  0.00858 **
# run_index7:Group                 0.49952    0.49534   1.008  0.31324   
# run_index8:Group                 1.39430    0.49220   2.833  0.00461 **
# PDS_mean_score:run_index4:Group -0.10158    0.17178  -0.591  0.55430   
# PDS_mean_score:run_index5:Group -0.21750    0.16953  -1.283  0.19949   
# PDS_mean_score:run_index6:Group -0.43192    0.16937  -2.550  0.01077 * 
# PDS_mean_score:run_index7:Group -0.04670    0.17230  -0.271  0.78637   
# PDS_mean_score:run_index8:Group -0.35366    0.17102  -2.068  0.03864 * 

# Puberty effects on the proportion of Go decisions (by social context)
null.model <- glmer(go ~ condition + gender + iq_z + (1|scores.SID), data=df_pds_allTDS, family='binomial')
main.model <- glmer(go ~ PDS_mean_score + condition + gender + iq_z + (1|scores.SID), data=df_pds_allTDS, family='binomial', control=glmerControl(optimizer="bobyqa"))
interaction.model <- glmer(go ~ PDS_mean_score * condition + gender + iq_z + (1|scores.SID), data=df_pds_allTDS, family='binomial', control=glmerControl(optimizer="bobyqa"))
group.model <- glmer(go ~ PDS_mean_score * condition * Group + gender + iq_z + (1|scores.SID), data=df_pds_allTDS, family='binomial')

anova(null.model, main.model)
#            Df   AIC   BIC  logLik deviance  Chisq Chi Df Pr(>Chisq)
# null.model  6 18548 18594 -9268.2    18536                         
# main.model  7 18550 18603 -9268.1    18536 0.2961      1     0.5863
anova(null.model, interaction.model)
#                   Df   AIC   BIC  logLik deviance  Chisq Chi Df Pr(>Chisq)
# null.model         6 18548 18594 -9268.2    18536                         
# interaction.model  9 18552 18620 -9266.7    18534 3.0079      3     0.3904
anova(null.model, group.model)
#             Df   AIC   BIC  logLik deviance  Chisq Chi Df Pr(>Chisq)    
# null.model   6 18548 18594 -9268.2    18536                             
# group.model 15 18538 18651 -9253.9    18508 28.746      9  0.0007151 ***

summary(group.model)
# Fixed effects:
#                                  Estimate Std. Error z value Pr(>|z|)  
# (Intercept)                     -0.563099   0.838365  -0.672   0.5018  
# PDS_mean_score                   0.148403   0.295744   0.502   0.6158  
# condition3                      -1.216465   0.562851  -2.161   0.0307 *
# condition4                      -1.212841   0.575565  -2.107   0.0351 *
# Group                            0.002847   0.520521   0.006   0.9956  
# gender1                         -0.141676   0.132116  -1.072   0.2836  
# iq_z                             0.037372   0.072631   0.514   0.6069  
# PDS_mean_score:condition3        0.416260   0.198060   2.102   0.0356 *
# PDS_mean_score:condition4        0.300511   0.201658   1.490   0.1362  
# PDS_mean_score:Group            -0.079026   0.181816  -0.435   0.6638  
# condition3:Group                 0.883833   0.349187   2.531   0.0114 *
# condition4:Group                 0.787219   0.355045   2.217   0.0266 *
# PDS_mean_score:condition3:Group -0.274289   0.121812  -2.252   0.0243 *
# PDS_mean_score:condition4:Group -0.149360   0.123411  -1.210   0.2262  
```
###############################################################
## Puberty effects on CRASHES while controlling for Sex & IQ ##
###############################################################
```{r}
# Puberty effects on the proportion of Go decisions that resulted in Crashes (by run_index)
null.model <- glmer(go_cr ~ run_index + gender + iq_z + (1|scores.SID), data=df_pds_allTDS, family='binomial', control=glmerControl(optimizer="bobyqa"))
main.model <- glmer(go_cr ~ PDS_mean_score + run_index + gender + iq_z + (1|scores.SID), data=df_pds_allTDS, family='binomial', control=glmerControl(optimizer="bobyqa"))
interaction.model <- glmer(go_cr ~ PDS_mean_score * run_index + gender + iq_z + (1|scores.SID), data=df_pds_allTDS, family='binomial', control=glmerControl(optimizer="bobyqa"))
group.model <- glmer(go_cr ~ PDS_mean_score * run_index * Group + gender + iq_z + (1|scores.SID), data=df_pds_allTDS, family='binomial')

anova(null.model, main.model)
#            Df   AIC   BIC  logLik deviance  Chisq Chi Df Pr(>Chisq)
# null.model  9 14267 14335 -7124.5    14249                         
# main.model 10 14269 14344 -7124.4    14249 0.1368      1     0.7115

anova(null.model, interaction.model)
#                   Df   AIC   BIC  logLik deviance  Chisq Chi Df Pr(>Chisq)
# null.model         9 14267 14335 -7124.5    14249                         
# interaction.model 15 14275 14389 -7122.6    14245 3.7421      6     0.7115

anova(null.model, group.model)
#             Df   AIC   BIC  logLik deviance  Chisq Chi Df Pr(>Chisq)
# null.model   9 14267 14335 -7124.5    14249                         
# group.model 27 14286 14490 -7115.9    14232 17.165     18     0.5118

# Puberty effects on the proportion of Go decisions that resulted in Crashes (by social context)
null.model <- glmer(go_cr ~ condition + gender + iq_z + (1|scores.SID), data=df_pds_allTDS, family='binomial')
main.model <- glmer(go_cr ~ PDS_mean_score + condition + gender + iq_z + (1|scores.SID), data=df_pds_allTDS, family='binomial')
interaction.model <- glmer(go_cr ~ PDS_mean_score * condition + gender + iq_z + (1|scores.SID), data=df_pds_allTDS, family='binomial', control=glmerControl(optimizer="bobyqa"))
group.model <- glmer(go_cr ~ PDS_mean_score * condition * Group + gender + iq_z + (1|scores.SID), data=df_pds_allTDS, family='binomial')

anova(null.model, main.model)
#            Df   AIC   BIC  logLik deviance  Chisq Chi Df Pr(>Chisq)
# null.model  6 14263 14308 -7125.4    14251                         
# main.model  7 14265 14318 -7125.4    14251 0.1368      1     0.7115
anova(null.model, interaction.model)
#                   Df   AIC   BIC  logLik deviance  Chisq Chi Df Pr(>Chisq)
# null.model         6 14263 14308 -7125.4    14251                         
# interaction.model  9 14267 14335 -7124.6    14249 1.7105      3     0.6346
anova(null.model, group.model)
#             Df   AIC   BIC  logLik deviance  Chisq Chi Df Pr(>Chisq)
# null.model   6 14263 14308 -7125.4    14251                         
# group.model 15 14270 14384 -7120.0    14240 10.841      9     0.2868

```

#####################################################################
## Social Context on Game Time ##
#####################################################################
```{r}
# Run effects on the proportion of Go decisions
null.model <- lm(time ~ (1|scores.SID), data=allTDSfMRI)
run.model <- lm(time ~ run_index + (1|scores.SID), data=allTDSfMRI)
interaction.model <- lm(time ~ run_index * Group + (1|scores.SID), data=allTDSfMRI)

anova(null.model, run.model)     
#   Res.Df    RSS Df Sum of Sq      F    Pr(>F)    
# 1  16579 387.85                                  
# 2  16574 378.84  5    9.0069 78.809 < 2.2e-16 ***
anova(null.model, interaction.model)     
#   Res.Df    RSS Df Sum of Sq      F    Pr(>F)    
# 1  16579 387.85                                  
# 2  16568 374.70 11    13.149 52.854 < 2.2e-16 ***

summary(run.model) 
#                     Estimate Std. Error t value Pr(>|t|)    
# (Intercept)         2.344456   0.002867 817.617  < 2e-16 ***
# run_index4          0.009175   0.004055   2.263   0.0237 *  
# run_index5         -0.039242   0.004055  -9.677  < 2e-16 ***
# run_index6         -0.032465   0.004055  -8.006 1.26e-15 ***
# run_index7         -0.027646   0.004077  -6.780 1.24e-11 ***
# run_index8         -0.059625   0.004070 -14.650  < 2e-16 ***
summary(interaction.model) 

#                     Estimate Std. Error t value Pr(>|t|)    
# (Intercept)         2.435891   0.009039 269.481  < 2e-16 ***
# run_index4         -0.056143   0.012783  -4.392 1.13e-05 ***
# run_index5         -0.101751   0.012783  -7.960 1.84e-15 ***
# run_index6         -0.084073   0.012783  -6.577 4.95e-11 ***
# run_index7         -0.076490   0.012899  -5.930 3.09e-09 ***
# run_index8         -0.134704   0.012860 -10.475  < 2e-16 ***
# Group              -0.060811   0.005705 -10.660  < 2e-16 ***
# run_index4:Group    0.043442   0.008068   5.385 7.35e-08 ***
# run_index5:Group    0.041573   0.008068   5.153 2.59e-07 ***
# run_index6:Group    0.034323   0.008068   4.254 2.11e-05 ***
# run_index7:Group    0.032693   0.008114   4.029 5.62e-05 ***
# run_index8:Group    0.049986   0.008098   6.173 6.86e-10 ***

# Condition effects on the proportion of Go decisions
null.model <- lm(time ~ (1|scores.SID), data=allTDSfMRI)
condition.model <- lm(time ~ condition + (1|scores.SID), data=allTDSfMRI)
interaction.model <- lm(time ~ condition * Group + (1|scores.SID), data=allTDSfMRI)

anova(null.model, condition.model)  
#   Res.Df    RSS Df Sum of Sq      F    Pr(>F)    
# 1  16579 387.85                                  
# 2  16577 380.42  2    7.4302 161.89 < 2.2e-16 ***
summary(condition.model)  
#                     Estimate Std. Error t value Pr(>|t|)    
# (Intercept)         2.349044   0.002032 1156.25   <2e-16 ***
# condition3         -0.040441   0.002873  -14.08   <2e-16 ***
# condition4         -0.048281   0.002886  -16.73   <2e-16 ***

anova(null.model, interaction.model)  
#   Res.Df    RSS Df Sum of Sq      F    Pr(>F)    
# 1  16579 387.85                                  
# 2  16574 377.06  5     10.79 94.854 < 2.2e-16 ***

null.model <- lm(time ~ (1|scores.SID), data=social_df_TDSall)
condition.model <- lm(time ~ condition + (1|scores.SID), data=social_df_TDSall)
interaction.model <- lm(time ~ condition * Group + (1|scores.SID), data=social_df_TDSall)

anova(null.model, condition.model)  
#   Res.Df    RSS Df Sum of Sq      F    Pr(>F)    
# 1  16579 387.85                                  
# 2  16574 377.06  5     10.79 94.854 < 2.2e-16 ***
anova(null.model, interaction.model)  
#   Res.Df    RSS Df Sum of Sq      F    Pr(>F)    
# 1  11019 222.00                                  
# 2  11016 220.59  3    1.4049 23.386 4.398e-15 ***
summary(condition.model) 
#                     Estimate Std. Error t value Pr(>|t|)    
# (Intercept)         2.308602   0.001903  1213.2  < 2e-16 ***
# condition4         -0.007840   0.002703    -2.9  0.00374 ** 

summary(interaction.model) 
#                     Estimate Std. Error t value Pr(>|t|)    
# (Intercept)         2.342979   0.006014 389.559  < 2e-16 ***
# condition4         -0.012993   0.008570  -1.516    0.130    
# Group              -0.022863   0.003796  -6.023 1.76e-09 ***
# condition4:Group    0.003545   0.005393   0.657    0.511    
```






















#########################################################################################################
##If requested Compared to MOCK trials
#########################################################################################################
###############################################
## Run and Location effects on GO DECISIONS ##
###############################################
```{r}
# Run effects on the proportion of Go decisions
null.model <- glmer(go ~ (1|scores.SID), data=df_all_stops, family='binomial')
run.model <- glmer(go ~ run_index + (1|scores.SID), data=df_all_stops, family='binomial')
anova(null.model, run.model)         
summary(run.model) 

# Fixed effects:
#            Estimate Std. Error z value Pr(>|z|)    

# (Intercept) -0.41217    0.11343  -3.634  0.00028 ***
# run_index2  -0.13063    0.08517  -1.534  0.12509    
# run_index3  -0.15226    0.08460  -1.800  0.07191 .  
# run_index4  -0.25618    0.08505  -3.012  0.00259 ** 
# run_index5  -0.14163    0.08456  -1.675  0.09397 .  
# run_index6  -0.03287    0.08421  -0.390  0.69632    
# run_index7  -0.21650    0.08486  -2.551  0.01073 *  
# run_index8  -0.16291    0.08465  -1.925  0.05428 . 

#

# Condition effects on the proportion of Go decisions
null.model <- glmer(go ~ (1|scores.SID), data=df_all, family='binomial')
condition.model <- glmer(go ~ condition + (1|scores.SID), data=df_all, family='binomial')
anova(null.model, condition.model)        
summary(condition.model) 

# Fixed effects:
#            Estimate Std. Error z value Pr(>|z|)    
# (Intercept) -0.48567    0.09966  -4.873  1.1e-06 ***
# condition2  -0.11030    0.05839  -1.889   0.0589 .  
# condition3  -0.01718    0.05815  -0.295   0.7677    
# condition4  -0.12643    0.05912  -2.138   0.0325 * 

#

```
#########################################
## Social Context effects on CRASHES ##
#########################################
```{r}
# Run effects on the proportion of Go decisions that resulted in Crashes
null.model <- glmer(go_cr ~ (1|scores.SID), data=df_all_stops, family='binomial')
run.model <- glmer(go_cr ~ run_index + (1|scores.SID), data=df_all_stops, family='binomial', control=glmerControl(optimizer="bobyqa"))
anova(null.model, run.model) 
summary(run.model) 

# Fixed effects:
#              Estimate Std. Error z value Pr(>|z|)    
# (Intercept) -1.4653402  0.0969203 -15.119   <2e-16 ***
# run_index2   0.0606754  0.1002940   0.605    0.545    
# run_index3  -0.0005661  0.1003993  -0.006    0.996    
# run_index4  -0.0767261  0.1014819  -0.756    0.450    
# run_index5  -0.0407681  0.1009544  -0.404    0.686    
# run_index6   0.0676768  0.0994757   0.680    0.496    
# run_index7  -0.0612230  0.1012456  -0.605    0.545    
# run_index8  -0.1028824  0.1018746  -1.010    0.313   

#

# Condition effects on the proportion of Go decisions that resulted in Crashes
null.model <- glmer(go_cr ~ (1|scores.SID), data=df_all, family='binomial')
condition.model <- glmer(go_cr ~ condition + (1|scores.SID), data=df_all, family='binomial')
anova(null.model, condition.model)        
summary(condition.model) 

# Fixed effects:
#            Estimate Std. Error z value Pr(>|z|)    
# (Intercept) -1.43798    0.07888 -18.229   <2e-16 ***
# condition2  -0.06217    0.06922  -0.898   0.3691    
# condition3  -0.03138    0.06892  -0.455   0.6489    
# condition4  -0.12761    0.07055  -1.809   0.0705 .

```
################################################
## Run and Location effects on STOP DECISIONS ##
################################################
```{r}
# Run effects on the proportion of Stop decisions
null.model <- glmer(stop ~ (1|scores.SID), data=df_all_stops, family='binomial')
run.model <- glmer(stop ~ run_index + (1|scores.SID), data=df_all_stops, family='binomial')
anova(null.model, run.model)
#            Df   AIC   BIC  logLik deviance Chisq Chi Df Pr(>Chisq)    
# null.model  2 13494 13509 -6745.2    13490                            
# run.model   9 13424 13489 -6703.0    13406 84.44      7  1.707e-15 ***
summary(run.model)
# Fixed effects:
#             Estimate Std. Error z value Pr(>|z|)    
# (Intercept) -0.20410    0.09958  -2.050   0.0404 *  
# run_index2   0.42431    0.08401   5.051 4.41e-07 ***
# run_index3   0.43216    0.08329   5.189 2.12e-07 ***
# run_index4   0.60846    0.08368   7.271 3.56e-13 ***
# run_index5   0.57088    0.08358   6.831 8.45e-12 ***
# run_index6   0.43552    0.08329   5.229 1.71e-07 ***
# run_index7   0.61532    0.08370   7.352 1.96e-13 ***
# run_index8   0.61189    0.08369   7.311 2.65e-13 ***

# Condition effects on the proportion of Stop decisions
null.model <- glmer(stop ~ (1|scores.SID), data=df_all, family='binomial')
condition.model <- glmer(stop ~ condition + (1|scores.SID), data=df_all, family='binomial')
anova(null.model, condition.model)
#                 Df   AIC   BIC  logLik deviance  Chisq Chi Df Pr(>Chisq)    
# null.model       2 14211 14225 -7103.4    14207                             
# condition.model  5 14162 14199 -7076.2    14152 54.483      3   8.85e-12 ***
summary(condition.model) 
# Fixed effects:
#             Estimate Std. Error z value Pr(>|z|)    
# (Intercept)  0.01340    0.08535   0.157    0.875    
# condition2   0.27586    0.05704   4.836 1.32e-06 ***
# condition3   0.29015    0.05706   5.085 3.68e-07 ***
# condition4   0.41202    0.05796   7.108 1.18e-12 *** 
```
###############################################################################
## Run and Location effects on Stop decisions when there was no crossing car ##
###############################################################################
```{r}
# Run effects on the proportion of Bad Stop decisions
null.model <- glmer(stop_nocar ~ (1|scores.SID), data=df_all_stops, family='binomial')
run.model <- glmer(stop_nocar ~ run_index + (1|scores.SID), data=df_all_stops, family='binomial')
anova(null.model, run.model)
#            Df   AIC   BIC  logLik deviance  Chisq Chi Df Pr(>Chisq)   
# null.model  2 11944 11959 -5970.2    11940                            
# run.model   9 11934 12000 -5958.2    11916 23.951      7   0.001162 **
summary(run.model)
# Fixed effects:
#             Estimate Std. Error z value Pr(>|z|)    
# (Intercept) -1.29533    0.08069 -16.054  < 2e-16 ***
# run_index2   0.28642    0.09478   3.022 0.002512 ** 
# run_index3   0.31583    0.09351   3.377 0.000732 ***
# run_index4   0.38151    0.09296   4.104 4.06e-05 ***
# run_index5   0.35853    0.09315   3.849 0.000119 ***
# run_index6   0.28825    0.09376   3.074 0.002111 ** 
# run_index7   0.37387    0.09301   4.020 5.83e-05 ***
# run_index8   0.33145    0.09338   3.549 0.000386 ***

# Condition effects on the proportion of Stop decisions
null.model <- glmer(stop_nocar ~ (1|scores.SID), data=df_all, family='binomial')
condition.model <- glmer(stop_nocar ~ condition + (1|scores.SID), data=df_all, family='binomial')
anova(null.model, condition.model)
#                 Df   AIC   BIC  logLik deviance  Chisq Chi Df Pr(>Chisq)   
# null.model       2 12527 12541 -6261.3    12523                            
# condition.model  5 12520 12557 -6255.1    12510 12.387      3    0.00617 **
summary(condition.model) 
# Fixed effects:
#             Estimate Std. Error z value Pr(>|z|)    
# (Intercept) -1.14380    0.06033 -18.960  < 2e-16 ***
# condition2   0.17365    0.06292   2.760  0.00578 ** 
# condition3   0.16260    0.06299   2.581  0.00984 ** 
# condition4   0.20336    0.06334   3.210  0.00133 ** 
```
#########################################################
## FIGURE 2: Run and Location effects on Task Behavior ##
#########################################################
```{r}
# # Part A: Run and Location effects on Go decisions
# plot_go = df %>% group_by(SID, run_index, condition) %>% summarize(mean_go = mean(go), sd_go = sd(go))
#   
# fig_2a <- ggplot(plot_go, aes(x = run_index, y = mean_go)) +
#   geom_boxplot() +
#   facet_grid(.~condition, scales='free', labeller=as_labeller(condition_labels)) +
#   labs(x='Run number', y='Propotion of Go decisions') +
#   #coord_cartesian(x=c(10.5,17.5)) + 
#   theme(text = element_text(size=18), axis.text.x = element_text(size=14), 
#         axis.text.y = element_text(size=14), strip.text.x = element_text(size=18)) #+
#   #scale_y_continuous(breaks = c(0, 2, 4, 6, 8, 10)) + scale_x_continuous(breaks = 11:17) 
# ggsave('fig_2a.png', fig_2a)
# 
# # Part B: Run and Location effects on Crashes
# plot_go_cr = df %>% group_by(SID, run_index, condition) %>% summarize(mean_go_cr = mean(go_cr), sd_go_cr = sd(go_cr))
#   
# fig_2b <- ggplot(plot_go_cr, aes(x = run_index, y = mean_go_cr)) +
#   geom_boxplot() +
#   facet_grid(.~condition, scales='free', labeller=as_labeller(condition_labels)) +
#   labs(x='Run number', y='Propotion of Go decisions\nthat resulted in Crashes') +
#   #coord_cartesian(x=c(10.5,17.5)) + 
#   theme(text = element_text(size=18), axis.text.x = element_text(size=14), 
#         axis.text.y = element_text(size=14), strip.text.x = element_text(size=18)) #+
#   #scale_y_continuous(breaks = c(0, 2, 4, 6, 8, 10)) + scale_x_continuous(breaks = 11:17) 
# ggsave('fig_2b.png', fig_2b)
```
#####################################################################
## FIGURE 2 ALTERNATIVE: Run and Location effects on Task Behavior ##
#####################################################################
```{r}
# Part A: Run and Condition effects on Go decisions
go_by_sid = df_all %>% group_by(scores.SID, run_index, condition) %>% summarize(mean_go = mean(go))
plot_group_go = go_by_sid %>% group_by(run_index, condition) %>% summarize(mean=mean(mean_go), 
                                                                    sd=sd(mean_go), 
                                                                    n=70, # entered manually (could not be calculated because 127 has 140 trials, whereas all other subjects have 160 trials)
                                                                    se=sd/sqrt(n), 
                                                                    ci=qt(0.975, df=n-1)*se) 
  
fig_2a <- ggplot(plot_group_go, aes(x = run_index, y = mean, group=1)) +
  geom_point() +
  geom_line() +
  geom_errorbar(aes(ymin = mean-ci, ymax = mean+ci)) +
  facet_grid(.~condition, scales='free', labeller=as_labeller(condition_labels)) +
  labs(x='Run number', y='Propotion of Go decisions') #+
  #coord_cartesian(x=c(10.5,17.5)) + 
  theme(text = element_text(size=18), axis.text.x = element_text(size=14), 
        axis.text.y = element_text(size=14), strip.text.x = element_text(size=18)) #+
  #scale_y_continuous(breaks = c(0, 2, 4, 6, 8, 10)) + scale_x_continuous(breaks = 11:17) 
ggsave('fig_2a.png', fig_2a)

# Part B: Run and Location effects on Crashes
go_cr_by_sid = df_all %>% group_by(scores.SID, run_index, condition) %>% summarize(mean_go_cr = mean(go_cr))
plot_group_go_cr = go_cr_by_sid %>% group_by(run_index, condition) %>% summarize(mean = mean(mean_go_cr), 
                                                                    sd = sd(mean_go_cr), 
                                                                    n=70, # entered manually (could not be calculated because 127 has 140 trials, whereas all other subjects have 160 trials)
                                                                    se=sd/sqrt(n), 
                                                                    ci=qt(0.975, df=n-1)*se) 

fig_2b <- ggplot(plot_group_go_cr, aes(x = run_index, y = mean, group=1)) +
  geom_point() +
  geom_line() +
  geom_errorbar(aes(ymin = mean-ci, ymax = mean+ci)) +
  facet_grid(.~condition, scales='free', labeller=as_labeller(condition_labels)) +
  labs(x='Run number', y='Propotion of Go decisions\nthat resulted in Crashes') #+
  #coord_cartesian(x=c(10.5,17.5)) + 
  theme(text = element_text(size=18), axis.text.x = element_text(size=14), 
        axis.text.y = element_text(size=14), strip.text.x = element_text(size=18)) #+
  #scale_y_continuous(breaks = c(0, 2, 4, 6, 8, 10)) + scale_x_continuous(breaks = 11:17) 
ggsave('fig_2b.png', fig_2b)

# Part C: Run and Location effects on Stop decisions
stop_by_sid = df_all %>% group_by(scores.SID, run_index, condition) %>% summarize(mean_stop = mean(stop))
plot_group_stop = stop_by_sid %>% group_by(run_index, condition) %>% summarize(mean = mean(mean_stop), 
                                                                    sd = sd(mean_stop), 
                                                                    n=70, # entered manually (could not be calculated because 127 has 140 trials, whereas all other subjects have 160 trials)
                                                                    se=sd/sqrt(n), 
                                                                    ci=qt(0.975, df=n-1)*se) 

fig_2c <- ggplot(plot_group_stop, aes(x = run_index, y = mean, group=1)) +
  geom_point() +
  geom_line() +
  geom_errorbar(aes(ymin = mean-ci, ymax = mean+ci)) +
  facet_grid(.~condition, scales='free', labeller=as_labeller(condition_labels)) +
  labs(x='Run number', y='Propotion of Stop decisions') #+
  #coord_cartesian(x=c(10.5,17.5)) + 
  theme(text = element_text(size=18), axis.text.x = element_text(size=14), 
        axis.text.y = element_text(size=14), strip.text.x = element_text(size=18)) #+
  #scale_y_continuous(breaks = c(0, 2, 4, 6, 8, 10)) + scale_x_continuous(breaks = 11:17) 
ggsave('fig_2c.png', fig_2c)

# Part d: Run and Location effects on Bad Stop decisions
stop_nocar_by_sid = df_all %>% group_by(scores.SID, run_index, condition) %>% summarize(mean_stop_nocar = mean(stop_nocar))
plot_group_stop_nocar = stop_nocar_by_sid %>% group_by(run_index, condition) %>% summarize(mean = mean(mean_stop_nocar), 
                                                                    sd = sd(mean_stop_nocar), 
                                                                    n=70, # entered manually (could not be calculated because 127 has 140 trials, whereas all other subjects have 160 trials)
                                                                    se=sd/sqrt(n), 
                                                                    ci=qt(0.975, df=n-1)*se) 

fig_2d <- ggplot(plot_group_stop_nocar, aes(x = run_index, y = mean, group=1)) +
  geom_point() +
  geom_line() +
  geom_errorbar(aes(ymin = mean-ci, ymax = mean+ci)) +
  facet_grid(.~condition, scales='free', labeller=as_labeller(condition_labels)) +
  labs(x='Run number', y='Propotion of Bad Stop decisions') #+
  #coord_cartesian(x=c(10.5,17.5)) + 
  theme(text = element_text(size=18), axis.text.x = element_text(size=14), 
        axis.text.y = element_text(size=14), strip.text.x = element_text(size=18)) #+
  #scale_y_continuous(breaks = c(0, 2, 4, 6, 8, 10)) + scale_x_continuous(breaks = 11:17) 
ggsave('fig_2d.png', fig_2d)
```
##############################################
## Run and Location effects on GO DECISIONS ##
##############################################
```{r}
# Run effects on the proportion of Go decisions
null.model <- glmer(go ~ (1|scores.SID), data=df_all_stops, family='binomial')
run.model <- glmer(go ~ run_index + (1|scores.SID), data=df_all_stops, family='binomial')
anova(null.model, run.model)
#            Df   AIC   BIC  logLik deviance  Chisq Chi Df Pr(>Chisq)    
# null.model  2 13008 13022 -6501.9    13004                           
# run.model   9 13008 13073 -6494.8    12990 14.251      7    0.04689 *
summary(run.model)
# Fixed effects:
#              Estimate Std. Error z value Pr(>|z|)    
# (Intercept) -0.41217    0.11343  -3.634  0.00028 ***
# run_index2  -0.13063    0.08517  -1.534  0.12509    
# run_index3  -0.15226    0.08460  -1.800  0.07191 .  
# run_index4  -0.25618    0.08505  -3.012  0.00259 ** 
# run_index5  -0.14163    0.08456  -1.675  0.09397 .  
# run_index6  -0.03287    0.08421  -0.390  0.69632    
# run_index7  -0.21650    0.08486  -2.551  0.01073 *  
# run_index8  -0.16291    0.08465  -1.925  0.05428 . 

# Location effects on the proportion of Go decisions
null.model <- glmer(go ~ (1|scores.SID), data=df_all, family='binomial')
location.model <- glmer(go ~ condition + (1|scores.SID), data=df_all, family='binomial')
anova(null.model, location.model)
#                Df   AIC   BIC  logLik deviance  Chisq Chi Df Pr(>Chisq)    
# null.model      2 13683 13698 -6839.5    13679                           
# location.model  5 13682 13718 -6836.0    13672 7.1755      3    0.06651 .
summary(location.model)
# Fixed effects:
#             Estimate Std. Error z value Pr(>|z|)    
# (Intercept) -0.48567    0.09966  -4.873  1.1e-06 ***
# condition2  -0.11030    0.05839  -1.889   0.0589 .  
# condition3  -0.01718    0.05815  -0.295   0.7677    
# condition4  -0.12643    0.05912  -2.138   0.0325 *  
```
#########################################
## Run and Location effects on CRASHES ##
#########################################
```{r}
# Run effects on the proportion of Go decisions that resulted in Crashes
null.model <- glmer(go_cr ~ (1|scores.SID), data=df_all_stops, family='binomial')
run.model <- glmer(go_cr ~ run_index + (1|scores.SID), data=df_all_stops, family='binomial')
anova(null.model, run.model)
#            Df   AIC   BIC  logLik deviance  Chisq Chi Df Pr(>Chisq)  
# null.model  2 10020 10034 -5007.8    10016                         
# run.model   9 10028 10093 -5005.1    10010 5.3826      7     0.6134
summary(null.model)
# Fixed effects:
#             Estimate Std. Error z value Pr(>|z|)    
# (Intercept) -1.48432    0.06984  -21.25   <2e-16 ***

# Location effects on the proportion of Go decisions that resulted in Crashes
null.model <- glmer(go_cr ~ (1|scores.SID), data=df_all, family='binomial')
location.model <- glmer(go_cr ~ condition + (1|scores.SID), data=df_all, family='binomial')
anova(null.model, location.model)
#                Df   AIC   BIC  logLik deviance  Chisq Chi Df Pr(>Chisq)   
# null.model      2 10485 10500 -5240.5    10481                         
# location.model  5 10487 10524 -5238.7    10477 3.5656      3     0.3124
summary(location.model)
# Fixed effects:
#             Estimate Std. Error z value Pr(>|z|)    
# (Intercept) -1.43798    0.07888 -18.229   <2e-16 ***
# condition2  -0.06217    0.06922  -0.898   0.3691    
# condition3  -0.03138    0.06892  -0.455   0.6489    
# condition4  -0.12761    0.07055  -1.809   0.0705 .  
```
################################################################
## Age effects on GO DECISIONS while controlling for Sex & IQ ##
################################################################
```{r}
# Linear Age effects on the proportion of Go decisions (by run_index)
null.model <- glmer(go ~ run_index + gender + iq_z + (1|scores.SID), data=df_all_stops, family='binomial')
main.model <- glmer(go ~ age_c + run_index + gender + iq_z + (1|scores.SID), data=df_all_stops, family='binomial')
interaction.model <- glmer(go ~ age_c * run_index + gender + iq_z + (1|scores.SID), data=df_all_stops, family='binomial')

anova(null.model, main.model)
#            Df   AIC   BIC  logLik deviance  Chisq Chi Df Pr(>Chisq)
# null.model 11 12975 13054 -6476.4    12953                           
# main.model 12 12972 13059 -6474.0    12948 4.7881      1    0.02866 *
anova(null.model, interaction.model)
#                   Df   AIC   BIC  logLik deviance  Chisq Chi Df Pr(>Chisq)
# null.model        11 12975 13054 -6476.4    12953                             
# interaction.model 19 12964 13101 -6462.8    12926 27.329      8  0.0006202 ***
anova(main.model, interaction.model)
#                   Df   AIC   BIC  logLik deviance  Chisq Chi Df Pr(>Chisq)   
# main.model        12 12972 13059 -6474.0    12948                            
# interaction.model 19 12964 13101 -6462.8    12926 22.541      7   0.002048 **
summary(null.model)
# Fixed effects:
#              Estimate Std. Error z value Pr(>|z|)    
# (Intercept) -0.26194    0.12564  -2.085  0.03708 * 
# run_index2  -0.12701    0.08518  -1.491  0.13592   
# run_index3  -0.14908    0.08459  -1.762  0.07802 . 
# run_index4  -0.25293    0.08504  -2.974  0.00294 **
# run_index5  -0.13846    0.08456  -1.637  0.10155   
# run_index6  -0.02976    0.08421  -0.353  0.72379   
# run_index7  -0.21328    0.08485  -2.514  0.01195 * 
# run_index8  -0.15973    0.08464  -1.887  0.05913 . 
# gender1     -0.23520    0.17103  -1.375  0.16907   
# iq_z         0.06539    0.10481   0.624  0.53272  

# Linear Age effects on the proportion of Go decisions (by location)
null.model <- glmer(go ~ condition + gender + iq_z + (1|scores.SID), data=df_all, family='binomial')
main.model <- glmer(go ~ age_c + condition + gender + iq_z + (1|scores.SID), data=df_all, family='binomial')
interaction.model <- glmer(go ~ age_c * condition + gender + iq_z + (1|scores.SID), data=df_all, family='binomial')

anova(null.model, main.model)
#            Df   AIC   BIC logLik deviance  Chisq Chi Df Pr(>Chisq)
# null.model  7 13648 13699 -6817.1    13634                           
# main.model  8 13645 13704 -6814.6    13629 4.8882      1    0.02704 *
anova(null.model, interaction.model)
#                   Df   AIC   BIC  logLik deviance  Chisq Chi Df Pr(>Chisq)
# null.model         7 13648 13699 -6817.1    13634                            
# interaction.model 11 13641 13721 -6809.4    13619 15.389      4   0.003959 **
anova(main.model, interaction.model)

#                  Df   AIC   BIC  logLik deviance  Chisq Chi Df Pr(>Chisq)  
# main.model         8 13645 13704 -6814.6    13629                           
# interaction.model 11 13641 13721 -6809.4    13619 10.501      3    0.01476 *

summary(null.model)
# Fixed effects:
#             Estimate Std. Error z value Pr(>|z|)    
# (Intercept) -0.33301    0.11128  -2.992  0.00277 **
# condition2  -0.10890    0.05839  -1.865  0.06217 . 
# condition3  -0.01583    0.05815  -0.272  0.78540   
# condition4  -0.12477    0.05912  -2.111  0.03481 * 
# gender1     -0.24969    0.16212  -1.540  0.12352   
# iq_z         0.04382    0.09308   0.471  0.63782  
```
###############
## FIGURE 4A ##
###############
```{r}
# Part A: Go decisions plotted against Age
# df$pred_go <- predict(interaction.model, newdata=df, re.form=NA, type='response')
# 
# fig_4a <- ggplot(data=df, aes(x=age, y=pred_go, color=condition)) +
#   geom_line(aes(group=condition), size=1) +
#   #facet_grid(.~tds_group, scales='free', labeller=as_labeller(group_labels)) +
#   labs(x='Age', y='Predicted probability of Go decisions', color='Location') +
#   theme(text = element_text(size=16)) +
#   #coord_cartesian(x=c(-3, 4)) +
#   scale_colour_discrete(labels=condition_labels)
# ggsave('fig_4a.png', fig_4a)

# pGo <- df %>% group_by(SID, condition) %>% summarize(pGo = mean(go))
# pGo_by_age <- merge(pGo, demo, by = 'SID')

# ggplot(pGo_by_age, aes(x = age, y = pGo, color=condition), stat_smooth(method = loess)) +
#   geom_point() +
#   geom_line(aes(group=condition), size=1) +
#   #geom_errorbar(aes(ymax=mean + ci, ymin=mean - ci), width=0.5, position=position_dodge(.2)) +
#   #facet_grid(.~condition, scales='free', labeller=as_labeller(condition_labels)) +
#   labs(x='Age (mean-centered)', y='Proportion of Go decisions', color='Location')
```
######################################################################
## Age Group effects on GO DECISIONS while controlling for Sex & IQ ##
######################################################################
```{r}
# Age group effects on the proportion of Go decisions (by run_index)
# null.model <- glmer(go ~ run_index + gender + iq_z + (1|SID), data=df, family='binomial')
# main.model <- glmer(go ~ age_group + run_index + gender + iq_z + (1|SID), data=df, family='binomial')
# interaction.model <- glmer(go ~ age_group * run_index + gender + iq_z + (1|SID), data=df, family='binomial', control=glmerControl(optimizer="bobyqa"))
# 
# anova(null.model, main.model)
# anova(null.model, interaction.model)
# anova(main.model, interaction.model)
# 
# summary(null.model)
# 
# # Age group effects on the proportion of Go decisions (by location)
# null.model <- glmer(go ~ condition + gender + iq_z + (1|SID), data=df, family='binomial')
# main.model <- glmer(go ~ age_group + condition + gender + iq_z + (1|SID), data=df, family='binomial')
# interaction.model <- glmer(go ~ age_group * condition + gender + iq_z + (1|SID), data=df, family='binomial')
# 
# anova(null.model, main.model)
# anova(null.model, interaction.model)
# anova(main.model, interaction.model)
# 
# summary(null.model)
```
###########################################################
## Age effects on CRASHES while controlling for Sex & IQ ##
###########################################################
```{r}
# Age effects on the proportion of Go decisions that resulted in Crashes (by run_index)
null.model <- glmer(go_cr ~ run_index + gender + iq_z + (1|SID), data=df_all, family='binomial')
main.model <- glmer(go_cr ~ age_c + run_index + gender + iq_z + (1|SID), data=df_all, family='binomial')
interaction.model <- glmer(go_cr ~ age_c * run_index + gender + iq_z + (1|SID), data=df_all, family='binomial', control=glmerControl(optimizer="bobyqa"))

anova(null.model, main.model)
#            Df   AIC   BIC  logLik deviance  Chisq Chi Df Pr(>Chisq)
# null.model 11 11111 11191 -5544.3    11089                         
# main.model 12 11113 11200 -5544.3    11089 0.0121      1     0.9124
anova(null.model, interaction.model)
#                   Df   AIC   BIC  logLik deviance  Chisq Chi Df Pr(>Chisq)
# null.model        11 11111 11191 -5544.3    11089                         
# interaction.model 19 11114 11253 -5538.0    11076 12.617      8     0.1257
#anova(main.model, interaction.model)

summary(null.model)
# Fixed effects:
#             Estimate Std. Error z value Pr(>|z|)    
# (Intercept) -1.43537    0.10940 -13.121   <2e-16 ***
# run_index2   0.02410    0.09631   0.250   0.8024    
# run_index3  -0.07655    0.09762  -0.784   0.4329    
# run_index4   0.01396    0.09631   0.145   0.8847    
# run_index5   0.04615    0.09588   0.481   0.6303    
# run_index6   0.02783    0.09612   0.290   0.7721    
# run_index7   0.16941    0.09433   1.796   0.0725 .  
# run_index8   0.19479    0.09404   2.071   0.0383 *  
# gender1     -0.09179    0.11380  -0.807   0.4199    
# iq_z         0.01449    0.07332   0.198   0.8433  

# Age effects on the proportion of Go decisions that resulted in Crashes (by location)
null.model <- glmer(go_cr ~ condition + gender + iq_z + (1|scores.SID), data=df_all, family='binomial')
main.model <- glmer(go_cr ~ age_c + condition + gender + iq_z + (1|scores.SID), data=df_all, family='binomial')
interaction.model <- glmer(go_cr ~ age_c * condition + gender + iq_z + (1|scores.SID), data=df_all, family='binomial')

anova(null.model, main.model)
#            Df   AIC   BIC  logLik deviance  Chisq Chi Df Pr(>Chisq)
# null.model  7 10457 10508 -5221.3    10443                           
# main.model  8 10455 10513 -5219.3    10439 4.1071      1     0.0427 *
anova(null.model, interaction.model)
#                   Df   AIC   BIC  logLik deviance  Chisq Chi Df Pr(>Chisq)
# null.model         7 10457 10508 -5221.3    10443                         
# interaction.model 11 10459 10539 -5218.3    10437 6.1145      4     0.1908
anova(main.model, interaction.model)
#                   Df   AIC   BIC  logLik deviance  Chisq Chi Df Pr(>Chisq)
# main.model         8 10455 10513 -5219.3    10439                         
# interaction.model 11 10459 10539 -5218.3    10437 2.0074      3     0.5709


summary(null.model)
#Fixed effects:
#             Estimate Std. Error z value Pr(>|z|)    
# (Intercept) -1.34344    0.08766 -15.326   <2e-16 ***
# condition2  -0.06020    0.06925  -0.869   0.3847    
# condition3  -0.02943    0.06895  -0.427   0.6695    
# condition4  -0.12479    0.07059  -1.768   0.0771 .  
# gender1     -0.14601    0.11857  -1.231   0.2182    
# iq_z         0.04487    0.06855   0.655   0.5128 
```
###############
## FIGURE 4B ##
###############
```{r}
# Part B: Crashes
# crashes <- df %>% distinct(SID, gender_flip, condition, run_index, crash.count)
# # new.row = c(127, 'Male', 1, 2, NA)
# # crashes <- rbind(crashes, new.row)
# 
# plot.crashes <- crashes %>% group_by(gender_flip, condition, run_index) %>%
#   summarize(mean = mean(crash.count), sd = sd(crash.count), n = n(), se = sd/sqrt(n), ci=qt(0.975, df=n-1)*se)
# 
# ggplot(plot.crashes, aes(x = run_index, y = mean, color=gender_flip)) +
#   geom_point(position=position_dodge(.1), size=3) +
#   geom_line(aes(group=gender_flip), size=1) +
#   geom_errorbar(aes(ymax=mean + ci, ymin=mean - ci), width=0.5, position=position_dodge(.2)) +
#   facet_grid(.~condition, scales='free', labeller=as_labeller(condition_labels)) +
#   labs(x='Run number', y='Crashes', color='Sex') +
#   scale_y_continuous(breaks = c(3, 4, 5))
```
#################################################################
## Age Group effects on CRASHES while controlling for Sex & IQ ##
#################################################################
```{r}
# # Age group effects on the proportion of Go decisions that resulted in Crashes (by run_index)
# null.model <- glmer(go_cr ~ run_index + gender + iq_z + (1|SID), data=df, family='binomial')
# main.model <- glmer(go_cr ~ age_group + run_index + gender + iq_z + (1|SID), data=df, family='binomial')
# interaction.model <- glmer(go_cr ~ age_group * run_index + gender + iq_z + (1|SID), data=df, family='binomial', control=glmerControl(optimizer="bobyqa"))
# 
# anova(null.model, main.model)
# anova(null.model, interaction.model)
# anova(main.model, interaction.model)
# 
# summary(null.model)
# 
# # Age group effects on the proportion of Go decisions that resulted in Crashes (by location)
# null.model <- glmer(go_cr ~ condition + gender + iq_z + (1|SID), data=df, family='binomial')
# main.model <- glmer(go_cr ~ age_group + condition + gender + iq_z + (1|SID), data=df, family='binomial')
# interaction.model <- glmer(go_cr ~ age_group * condition + gender + iq_z + (1|SID), data=df, family='binomial')
# 
# anova(null.model, main.model)
# anova(null.model, interaction.model)
# anova(main.model, interaction.model)
# 
# summary(null.model)
```
####################################################################
## Puberty effects on GO DECISIONS while controlling for Sex & IQ ##
####################################################################
```{r}
# Puberty effects on the proportion of Go decisions (by run_index)
null.model <- glmer(go ~ run_index + gender + iq_z + (1|scores.SID), data=df_pds_all_stops, family='binomial')
main.model <- glmer(go ~ PDS_mean_score + run_index + gender + iq_z + (1|scores.SID), data=df_pds_all_stops, family='binomial', control=glmerControl(optimizer="bobyqa"))
interaction.model <- glmer(go ~ PDS_mean_score * run_index + gender + iq_z + (1|scores.SID), data=df_pds_all_stops, family='binomial', control=glmerControl(optimizer="bobyqa"))

anova(null.model, main.model)
#            Df   AIC   BIC  logLik deviance  Chisq Chi Df Pr(>Chisq)
# null.model  9 7657.1 7717.2 -3819.5   7639.1                         
# main.model 10 7657.2 7724.0 -3818.6   7637.2 1.8437      1     0.1745
anova(null.model, interaction.model)
#                   Df   AIC   BIC  logLik deviance Chisq Chi Df Pr(>Chisq)
# null.model         9 7657.1 7717.2 -3819.5   7639.1                         
# interaction.model 15 7659.2 7759.3 -3814.6   7629.2 9.8938      6     0.1292
anova(main.model, interaction.model)
#                   Df    AIC    BIC  logLik deviance  Chisq Chi Df Pr(>Chisq)
# main.model        10 7657.2 7724.0 -3818.6   7637.2                         
# interaction.model 15 7659.2 7759.3 -3814.6   7629.2 8.0501      5     0.1535
summary(null.model)
# Fixed effects:
#             Estimate Std. Error z value Pr(>|z|)    
# (Intercept) -0.352238   0.140899  -2.500   0.0124 *
# run_index4  -0.063843   0.095454  -0.669   0.5036  
# run_index5   0.009071   0.095173   0.095   0.9241  
# run_index6   0.121519   0.094851   1.281   0.2001  
# run_index7  -0.040963   0.095361  -0.430   0.6675  
# run_index8   0.036203   0.095081   0.381   0.7034  
# gender1     -0.164995   0.194959  -0.846   0.3974  
# iq_z         0.126348   0.113606   1.112   0.2661

# Puberty effects on the proportion of Go decisions (by location)
null.model <- glmer(go ~ condition + gender + iq_z + (1|scores.SID), data=df_pds_all, family='binomial')
main.model <- glmer(go ~ PDS_mean_score + condition + gender + iq_z + (1|scores.SID), data=df_pds_all, family='binomial', control=glmerControl(optimizer="bobyqa"))
interaction.model <- glmer(go ~ PDS_mean_score * condition + gender + iq_z + (1|scores.SID), data=df_pds_all, family='binomial', control=glmerControl(optimizer="bobyqa"))

anova(null.model, main.model)
#            Df   AIC   BIC  logLik deviance  Chisq Chi Df Pr(>Chisq)
# null.model  6 8056.8 8097.2 -4022.4   8044.8                         
# main.model  7 8056.8 8103.9 -4021.4   8042.8 2.0619      1      0.151
anova(null.model, interaction.model)
#                   Df   AIC   BIC logLik deviance  Chisq Chi Df Pr(>Chisq)
# null.model         6 8056.8 8097.2 -4022.4   8044.8                        
# interaction.model  9 8057.2 8117.8 -4019.6   8039.2 5.628      3     0.1312
anova(main.model, interaction.model)
#                   Df    AIC    BIC  logLik deviance  Chisq Chi Df Pr(>Chisq)
# main.model         7 8056.8 8103.9 -4021.4   8042.8                         
# interaction.model  9 8057.2 8117.8 -4019.6   8039.2 3.5662      2     0.1681
summary(null.model)
# Fixed effects:
#             Estimate Std. Error z value Pr(>|z|)    
# (Intercept) -0.35621    0.12262  -2.905  0.00367 **
# condition3   0.05524    0.06515   0.848  0.39655   
# condition4  -0.01144    0.06601  -0.173  0.86238   
# gender1     -0.16248    0.18389  -0.884  0.37693   
# iq_z         0.12709    0.10543   1.206  0.22802  
```
###############################################################
## Puberty effects on CRASHES while controlling for Sex & IQ ##
###############################################################
```{r}
# Puberty effects on the proportion of Go decisions that resulted in Crashes (by run_index)
null.model <- glmer(go_cr ~ run_index + gender + iq_z + (1|scores.SID), data=df_pds_all_stops, family='binomial', control=glmerControl(optimizer="bobyqa"))
main.model <- glmer(go_cr ~ PDS_mean_score + run_index + gender + iq_z + (1|scores.SID), data=df_pds_all_stops, family='binomial', control=glmerControl(optimizer="bobyqa"))
interaction.model <- glmer(go_cr ~ PDS_mean_score * run_index + gender + iq_z + (1|scores.SID), data=df_pds_all_stops, family='binomial', control=glmerControl(optimizer="bobyqa"))

anova(null.model, main.model)
#            Df   AIC   BIC  logLik deviance  Chisq Chi Df Pr(>Chisq)
# null.model  9 5924.0 5984.1 -2953.0   5906.0                         
# main.model 10 5925.3 5992.1 -2952.7   5905.3 0.6343      1     0.4258
anova(null.model, interaction.model)
#                   Df   AIC   BIC  logLik deviance  Chisq Chi Df Pr(>Chisq)
# null.model         9 5924.0 5984.1 -2953.0   5906.0                         
# interaction.model 15 5932.7 6032.9 -2951.3   5902.7 3.2779      6     0.7733
anova(main.model, interaction.model)
#                   Df    AIC    BIC  logLik deviance  Chisq Chi Df Pr(>Chisq)
# main.model        10 5925.3 5992.1 -2952.7   5905.3                         
# interaction.model 15 5932.7 6032.9 -2951.3   5902.7 2.6435      5     0.7547
summary(null.model)
# Fixed effects:
#               Estimate Std. Error z value Pr(>|z|)    
# (Intercept) -1.378e+00  1.169e-01 -11.789   <2e-16 ***
# run_index4   5.740e-02  1.127e-01   0.509    0.610    
# run_index5  -1.301e-02  1.138e-01  -0.114    0.909    
# run_index6   1.191e-01  1.118e-01   1.066    0.286    
# run_index7   2.302e-06  1.136e-01   0.000    1.000    
# run_index8  -1.301e-02  1.138e-01  -0.114    0.909    
# gender1     -1.040e-01  1.398e-01  -0.744    0.457    
# iq_z         8.902e-02  8.186e-02   1.087    0.277 

# Puberty effects on the proportion of Go decisions that resulted in Crashes (by location)
null.model <- glmer(go_cr ~ condition + gender + iq_z + (1|scores.SID), data=df_pds_all, family='binomial')
main.model <- glmer(go_cr ~ PDS_mean_score + condition + gender + iq_z + (1|scores.SID), data=df_pds_all, family='binomial')
interaction.model <- glmer(go_cr ~ PDS_mean_score * condition + gender + iq_z + (1|scores.SID), data=df_pds_all, family='binomial', control=glmerControl(optimizer="bobyqa"))

anova(null.model, main.model)
#            Df   AIC   BIC  logLik deviance  Chisq Chi Df Pr(>Chisq)
# null.model  6 6196.1 6236.5 -3092.1   6184.1                         
# main.model  7 6197.2 6244.3 -3091.6   6183.2 0.9113      1     0.3398
anova(null.model, interaction.model)
#                   Df   AIC   BIC  logLik deviance  Chisq Chi Df Pr(>Chisq)
# null.model         6 6196.1 6236.5 -3092.1   6184.1                         
# interaction.model  9 6200.4 6261.0 -3091.2   6182.4 1.7063      3     0.6355
anova(main.model, interaction.model)
#                   Df    AIC    BIC  logLik deviance Chisq Chi Df Pr(>Chisq)
# main.model         7 6197.2 6244.3 -3091.6   6183.2                        
# interaction.model  9 6200.4 6261.0 -3091.2   6182.4 0.795      2      0.672
summary(null.model) 
# Fixed effects:
#              Estimate Std. Error z value Pr(>|z|)    
# (Intercept) -1.342636   0.095337 -14.083   <2e-16 ***
# condition3  -0.002993   0.077171  -0.039    0.969    
# condition4  -0.066925   0.078541  -0.852    0.394    
# gender1     -0.087042   0.132924  -0.655    0.513    
# iq_z         0.100483   0.076606   1.312    0.190 
```
######################################################################
## PDS Group effects on GO DECISIONS while controlling for Sex & IQ ##
######################################################################
```{r}
# # PDS group effects on the proportion of Go decisions (by run_index)
# null.model <- glmer(go ~ run_index + gender + iq_z + (1|SID), data=df_pds, family='binomial')
# main.model <- glmer(go ~ pds_group + run_index + gender + iq_z + (1|SID), data=df_pds, family='binomial')
# interaction.model <- glmer(go ~ pds_group * run_index + gender + iq_z + (1|SID), data=df_pds, family='binomial', control=glmerControl(optimizer="bobyqa"))
# 
# anova(null.model, main.model)
# anova(null.model, interaction.model)
# anova(main.model, interaction.model)
# 
# summary(null.model)
# 
# # Age group effects on the proportion of Go decisions (by location)
# null.model <- glmer(go ~ condition + gender + iq_z + (1|SID), data=df_pds, family='binomial')
# main.model <- glmer(go ~ pds_group + condition + gender + iq_z + (1|SID), data=df_pds, family='binomial')
# interaction.model <- glmer(go ~ pds_group * condition + gender + iq_z + (1|SID), data=df_pds, family='binomial')
# 
# anova(null.model, main.model)
# anova(null.model, interaction.model)
# anova(main.model, interaction.model)
# 
# summary(null.model)
```
#################################################################
## PDS Group effects on CRASHES while controlling for Sex & IQ ##
#################################################################
```{r}
# PDS group effects on the proportion of Go decisions that resulted in Crashes (by run_index)
# null.model <- glmer(go_cr ~ run_index + gender + iq_z + (1|SID), data=df_pds, family='binomial')
# main.model <- glmer(go_cr ~ pds_group + run_index + gender + iq_z + (1|SID), data=df_pds, family='binomial')
# interaction.model <- glmer(go_cr ~ pds_group * run_index + gender + iq_z + (1|SID), data=df_pds, family='binomial', control=glmerControl(optimizer="bobyqa"))
# 
# anova(null.model, main.model)
# anova(null.model, interaction.model)
# anova(main.model, interaction.model)
# 
# summary(null.model)
# 
# # PDS group effects on the proportion of Go decisions that resulted in Crashes (by location)
# null.model <- glmer(go_cr ~ condition + gender + iq_z + (1|SID), data=df_pds, family='binomial')
# main.model <- glmer(go_cr ~ pds_group + condition + gender + iq_z + (1|SID), data=df_pds, family='binomial')
# interaction.model <- glmer(go_cr ~ pds_group * condition + gender + iq_z + (1|SID), data=df_pds, family='binomial')
# 
# anova(null.model, main.model)
# anova(null.model, interaction.model)
# anova(main.model, interaction.model)
# 
# summary(null.model)
```