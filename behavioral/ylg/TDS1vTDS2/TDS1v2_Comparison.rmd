###############
## Data prep ##
###############
```{r}
##Check if the packages we need are installed, and if not, install them
packages<-c('dplyr', 'tidyr', 'data.table', 'R.matlab', 'ggplot2', 'lme4', 'summarytools', 'psych', 'mosaic', 'lmerTest', 'plotrix', 'tidyselect', 'tidyverse')
if(length(setdiff(packages, rownames(installed.packages())))>0) {
  install.packages(setdiff(packages, rownames(installed.packages())))
}
lapply(packages, library, character.only=TRUE)

##Set paths (data is located on CAS)
tds_folder<-'/Volumes/psy-ctn/psy-ctn/TDS/behavior/'
ylg_folder<-paste(tds_folder, 'YLG/processed/', sep='')
demo_folder<-paste(tds_folder, 'Redcap/', sep='')
qualtrics_folder<-paste(tds_folder, 'Qualtrics/', sep='')

##Collect data
ylg_data<-read.csv(paste(ylg_folder,'tds_trial_by_trial_20180124.csv',sep=''))
demo_data<-read.csv(paste(demo_folder,'age_gender_iq_2019.csv',sep=''))
qualtrics_data_post<-read.csv(paste(qualtrics_folder, 'scoring_script_output/tds1-wave1-PDS.csv', sep='')) %>% select(scores.SID, scores.female_comparison, scores.female_height_feet, scores.female_height_inches, scores.female_mean_score, scores.female_menses, scores.female_weight, scores.female_weight_text, scores.male_comparison, scores.male_height_feet, scores.male_height_feet_text, scores.male_height_inches, scores.male_height_inches_text, scores.male_mean_score, scores.male_weight, scores.male_weight_text, scores.pds_gender)
```


############################
## Demographics TDS 1 N=69##
############################
```{r}

# add rows for PRE
PDS_pre <- data.frame("scores.SID" = c(301, 302, 303, 304, 305, 306, 307, 308, 309, 310, 311, 312, 314, 315, 316, 317, 318, 319, 320)) 

qualtrics_data<-full_join(PDS_pre, qualtrics_data_post)
#change names to be easier to read later
names(demo_data) <- c("scores.SID", "s2_age", "gender", "s2_iq", "wave2_yn", "s3_age", "s3_iq")
## Merge qualtrics and demo data
demo <- merge(demo_data, qualtrics_data, by.x = 'scores.SID', by.y = 'scores.SID')
## Add variables
demo <- demo %>%
  mutate(age_group = ifelse(s2_age < 14.0, 1, 2)) %>% # age groups based on median split
  mutate(age_c = s2_age-14.1, age_rnd = floor(s2_age), age_sq = age_c^2) %>%   # age variables
  mutate(iq_c = s2_iq-100, iq_z = iq_c/15) %>%                   # iq variables
  mutate(PDS_mean_score=ifelse(                               # pds variables
    is.na(scores.female_mean_score)==TRUE, scores.male_mean_score, scores.female_mean_score)) %>%
  mutate(PDS_stage = ceiling(PDS_mean_score), pds_group = ifelse(PDS_mean_score < 2.9, 1, 2)) %>%
  mutate(gender_flip = ifelse(gender==0, 'Male', 'Female'))   # flip gender for correct colors in graph

## Filter demo_data (N=69, but only 53 with PDS data)
no_session2 = c(311, 338, 358)
behaviorals = c(305, 318, 319)
ylg_failed = c(339, 345)
missing_stops = c(350, 356, 366, 370)

demo_filtered_context <- demo %>% filter(scores.SID > 300) %>% 
  filter(!scores.SID %in% no_session2) %>% 
  filter(!scores.SID %in% behaviorals) %>% 
  filter(!scores.SID %in% ylg_failed)


age<-demo_filtered_context %>% filter(!is.na(s2_age)) %>%
  summarize(mean = mean(s2_age, na.rm=T), sd = sd(s2_age, na.rm=T), 
            min = min(s2_age, na.rm=T), max = max(s2_age, na.rm=T),
            n = n(), se = sd/sqrt(n), ci=qt(0.975, df=n-1)*se) # n=29 females 40 males
t.test(demo_filtered_context$s2_age~demo_filtered_context$gender) 


iq<-demo_filtered_context %>% filter(!is.na(s2_iq)) %>% 
  summarize(mean = mean(s2_iq, na.rm=T), sd = sd(s2_iq, na.rm=T), 
            min = min(s2_iq, na.rm=T), max = max(s2_iq, na.rm=T),
            n = n(), se = sd/sqrt(n), ci=qt(0.975, df=n-1)*se) # n=29 females 38 males
t.test(demo_filtered_context$s2_iq~demo_filtered_context$gender) 


pds<-demo_filtered_context %>% filter(!is.na(PDS_mean_score)) %>%  
  summarize(mean = mean(PDS_mean_score, na.rm=T), sd = sd(PDS_mean_score, na.rm=T),
            min = min(PDS_mean_score, na.rm=T), max = max(PDS_mean_score, na.rm=T),
            n = n(), se = sd/sqrt(n), ci=qt(0.975, df=n-1)*se) # n=21 females 32 males
t.test(demo_filtered_context$PDS_mean_score~demo_filtered_context$gender) 


```


############################
## Demographics TDS 2 N=70##
############################
```{r}
# Load data

qualtrics_data_TDS2<-read.csv(paste(qualtrics_folder, 'scoring_script_output/tds2-wave1-PDS.csv', sep='')) %>%  
  select(scores.SID, scores.female_comparison, scores.female_height, scores.female_mean_score, scores.female_menses, scores.female_weight, scores.male_comparison, scores.male_height, scores.male_mean_score, scores.male_weight, scores.pds_gender)  

#change names to be easier to read later
names(demo_data) <- c("scores.SID", "s2_age", "gender", "s2_iq", "wave2_yn", "s3_age", "s3_iq")

# filter
no_session2 = c(118, 123, 147, 148, 149, 153, 154, 166, 180)
behaviorals = c(103, 107, 112, 138, 143, 176, 191)
pilot_cyberball = c(101, 102, 104, 105, 106, 108, 110, 111)
motion_dropout = c(189, 158, 139)

demo_data_TDS2<-demo_data%>% filter(scores.SID < 300) %>% 
  filter(!scores.SID %in% no_session2) %>% 
  filter(!scores.SID %in% behaviorals) %>%
  filter(!scores.SID %in% pilot_cyberball) %>%
  filter(!scores.SID %in% motion_dropout)

## Merge qualtrics and demo data
demo_TDS2 <- merge(demo_data_TDS2, qualtrics_data_TDS2, by.x = 'scores.SID', by.y = 'scores.SID')

## Add variables

demo_TDS2 <- demo_TDS2 %>%
  mutate(age_group = ifelse(s2_age < 14.0, 1, 2)) %>% # age groups based on median split
  mutate(age_c = s2_age-14.1, age_rnd = floor(s2_age), age_sq = age_c^2) %>%   # age variables
  mutate(iq_c = s2_iq-100, iq_z = iq_c/15) %>%                   # iq variables
  mutate(PDS_mean_score=ifelse(                               # pds variables
    is.na(scores.female_mean_score)==TRUE, scores.male_mean_score, scores.female_mean_score)) %>%
  mutate(PDS_stage = ceiling(PDS_mean_score), pds_group = ifelse(PDS_mean_score < 2.9, 1, 2)) %>%
  mutate(gender_flip = ifelse(gender==0, 'Male', 'Female'))   # flip gender for correct colors in graph

TDS2_age<-demo_TDS2 %>% filter(!is.na(s2_age)) %>% 
  summarize(mean = mean(s2_age, na.rm=T), sd = sd(s2_age, na.rm=T), 
            min = min(s2_age, na.rm=T), max = max(s2_age, na.rm=T),
            n = n(), se = sd/sqrt(n), ci=qt(0.975, df=n-1)*se) 


TDS2_iq<-demo_TDS2 %>% filter(!is.na(s2_iq)) %>% 
  summarize(mean = mean(s2_iq, na.rm=T), sd = sd(s2_iq, na.rm=T), 
            min = min(s2_iq, na.rm=T), max = max(s2_iq, na.rm=T),
            n = n(), se = sd/sqrt(n), ci=qt(0.975, df=n-1)*se)


TDS2<-demo_TDS2 %>% filter(!is.na(PDS_mean_score)) %>% 
  summarize(mean = mean(PDS_mean_score, na.rm=T), sd = sd(PDS_mean_score, na.rm=T),
            min = min(PDS_mean_score, na.rm=T), max = max(PDS_mean_score, na.rm=T),
            n = n(), se = sd/sqrt(n), ci=qt(0.975, df=n-1)*se)


# compare between TDS I and TDS II

t.test(demo_filtered_context$s2_age, demo_TDS2$s2_age) 

# t = -0.12783, df = 135.16, p-value = 0.8985
# alternative hypothesis: true difference in means is not equal to 0
# 95 percent confidence interval:
#   -0.5760935  0.5061432
# sample estimates:
#   mean of x mean of y 
# 14.10174  14.13671 

t.test(demo_filtered_context$s2_iq, demo_TDS2$s2_iq)

# t = -3.6377, df = 131.87, p-value = 0.0003935
# alternative hypothesis: true difference in means is not equal to 0
# 95 percent confidence interval:
#   -11.87694  -3.50984
# sample estimates:
#   mean of x mean of y 
# 99.8209  107.5143

t.test(demo_filtered_context$PDS_mean_score, demo_TDS2$PDS_mean_score) 

# t = -0.90112, df = 110.37, p-value = 0.3695
# alternative hypothesis: true difference in means is not equal to 0
# 95 percent confidence interval:
#   -0.3800670  0.1424606
# sample estimates:
#   mean of x mean of y 
# 2.716981  2.835784 
```

##################
## YLG behavior ##
##################
```{r}
# Add variables

ylg = ylg_data %>% 
  mutate(condition = ifelse(grepl('1|2', run_index), 1,
                     ifelse(grepl('3|4', run_index), 2,
                     ifelse(grepl('5|6', run_index), 3, 
                     ifelse(grepl('7|8', run_index), 4, NA))))) %>%
  mutate(time=run_time_ms/60000) %>%
  mutate(go = ifelse(decision=='GO', 1, 0)) %>%
  mutate(crash = ifelse(scenario=='CRASH', 1, 0)) %>%
  mutate(go_cr = ifelse(decision=='GO' & scenario=='CRASH', 1, 0)) %>%
  mutate(stop = ifelse(decision=='STOP', 1, 0)) %>%
  mutate(stop_nocar = ifelse(decision=='STOP' & scenario=='SAFE', 1, 0)) %>%
  mutate(event = ifelse(decision=='GO' & scenario=='SAFE', 1,
                 ifelse(decision=='GO' & scenario=='CRASH', 2,
                 ifelse(decision=='STOP' & scenario=='CROSSCAR', 3,
                 ifelse(decision=='STOP' & scenario=='SAFE', 4, NA))))) %>%
  mutate(penalty = ifelse(decision=='NONE', 1, 0)) %>%
  mutate(count1 = ifelse(event==1, 1, 0)) %>%
  mutate(count2 = ifelse(event==2, 1, 0)) %>%
  mutate(count3 = ifelse(event==3, 1, 0)) %>%
  mutate(count4 = ifelse(event==4, 1, 0))

ylg$SID <- ylg$subject_name

# Check if events are present for all subjects
events_by_sid <- ylg %>% group_by(subject_name, condition) %>%
  summarize(n_good.go = sum(count1, na.rm=TRUE),
            n_bad.go = sum(count2, na.rm=TRUE),
            n_good.stop = sum(count3, na.rm=TRUE),
            n_bad.stop = sum(count4, na.rm=TRUE))

# Convert to factors
ylg$run_index <- as.factor(ylg$run_index)
ylg$condition <- as.factor(ylg$condition)

# Filter out subjects for imaging results (N=66)
# 201-299 = TDS-2
# 401-499 = TDS-3
# >500 = YADS
# no_session2 = c(311, 338, 358)
# behaviorals = c(305, 318, 319)

exclude = c(311, 338, 358, 305, 318, 319,
            401, 402, 403, 404, 405, 406, 407, 408, 409, 410, 411)
ylg_filtered = ylg %>% filter(subject_name > 300) %>% 
  filter(!subject_name %in% exclude)
count_trials_per_sub<-ylg_filtered %>% group_by(subject_name) %>% summarize(n()) 
# 315 only has 120 trials (practice runs missing) 
# 344 only has 120 trials (practice runs missing) 
# 377 only has 120 trials (practice runs missing) 

# Set labels
condition_labels = c(`1`='Mock', `2`='Alone', `3`='Peer Incl', `4`='Peer Excl')

colnames(ylg_filtered)[which(names(ylg_filtered) == "subject_name")] <- "scores.SID"

# Dataset for behavioral analyses (incomplete and complete runs)
df_all <- merge(demo_filtered_context, ylg_filtered, by = 'scores.SID')
df_all <- mutate(df_all, Group = 'TDS1')
  

missing_stops = c(350, 356, 366, 370)

# Dataset for behavioral analyses (only complete runs)
df_all_stops<- df_all %>% filter(scores.SID > 300) %>% 
  filter(!scores.SID %in% no_session2) %>% 
  filter(!scores.SID %in% behaviorals)%>%
  filter(!scores.SID %in% ylg_failed) %>% 
  filter(!scores.SID %in% missing_stops) 
# Set as factors for all data (incomplete and complete runs)
df_all$gender <- as.factor(df_all$gender)
df_all$gender_flip <- as.factor(df_all$gender_flip)
# Set as factors for all data (only complete runs)
df_all_stops$gender <- as.factor(df_all_stops$gender)
df_all_stops$gender_flip <- as.factor(df_all_stops$gender_flip)

countTDS1<-df_all %>% group_by(scores.SID, gender) %>% summarize(n()) 


#to compare within scanner social contexts
df_fMRI_all<-df_all %>% filter(condition != "1")

# Remove columns that are not congruent between TDS 1 and TDS 2

df_fMRI_all$scores.female_height_feet = NULL
df_fMRI_all$scores.female_height_inches = NULL
df_fMRI_all$scores.female_height_feet_text = NULL
df_fMRI_all$scores.female_weight_text = NULL
df_fMRI_all$scores.female_weight = NULL
df_fMRI_all$scores.male_height_feet = NULL
df_fMRI_all$scores.male_height_inches = NULL
df_fMRI_all$scores.male_weight_text = NULL
df_fMRI_all$scores.male_weight = NULL
df_fMRI_all$scores.male_height_feet_text = NULL
df_fMRI_all$scores.male_height_inches_text = NULL

```



#######################################
# Group comparisons -SETUP DESCRIPTIVES
#######################################
```{r}

#create df for TDS 1 and TDS 2

qualtrics_data_TDS2<-read.csv(paste(qualtrics_folder, 'scoring_script_output/tds2-wave1-PDS.csv', sep='')) %>%  
  select(scores.SID, scores.female_comparison, scores.female_height, scores.female_mean_score, scores.female_menses, scores.female_weight, scores.male_comparison, scores.male_height, scores.male_mean_score, scores.male_weight, scores.pds_gender)  

no_session2 = c(118, 123, 147, 148, 149, 153, 154, 166, 180)
behaviorals = c(103, 107, 112, 138, 143, 176, 191)
pilot_cyberball = c(101, 102, 104, 105, 106, 108, 110, 111)
motion_dropout = c(189, 158, 139)

#change names to be easier to read later
names(demo_data) <- c("scores.SID", "s2_age", "gender", "s2_iq", "wave2_yn", "s3_age", "s3_iq")

demo_data_TDS2<-demo_data%>% filter(scores.SID < 300) %>% 
  filter(!scores.SID %in% no_session2) %>% 
  filter(!scores.SID %in% behaviorals) %>%
  filter(!scores.SID %in% pilot_cyberball) %>%
  filter(!scores.SID %in% motion_dropout)
 

## Merge qualtrics and demo data
demo_TDS2 <- merge(demo_data_TDS2, qualtrics_data_TDS2, by.x = 'scores.SID', by.y = 'scores.SID')


demo_TDS2 <- demo_TDS2 %>%
  mutate(age_group = ifelse(s2_age < 14.0, 1, 2)) %>% # age groups based on median split
  mutate(age_c = s2_age-14.1, age_rnd = floor(s2_age), age_sq = age_c^2) %>%   # age variables
  mutate(iq_c = s2_iq-100, iq_z = iq_c/15) %>%                   # iq variables
  mutate(PDS_mean_score=ifelse(                               # pds variables
    is.na(scores.female_mean_score)==TRUE, scores.male_mean_score, scores.female_mean_score)) %>%
  mutate(PDS_stage = ceiling(PDS_mean_score), pds_group = ifelse(PDS_mean_score < 2.9, 1, 2)) %>%
  mutate(gender_flip = ifelse(gender==0, 'Male', 'Female'))   # flip gender for correct colors in graph


PDS_mean_scores_TDS2 <- demo_TDS2 %>% distinct(scores.SID, gender, scores.pds_gender, PDS_mean_score) %>% filter(!grepl("189|158|160|174", scores.SID)) 
write.csv(PDS_mean_scores_TDS2, file = 'tds2_PDS_mean_score_n70.csv')



TDS2_age_by_sex<-demo_TDS2 %>% filter(!is.na(s2_age)) %>% group_by(gender) %>% 
  summarize(mean = mean(s2_age, na.rm=T), sd = sd(s2_age, na.rm=T), 
            min = min(s2_age, na.rm=T), max = max(s2_age, na.rm=T),
            n = n(), se = sd/sqrt(n), ci=qt(0.975, df=n-1)*se) 
t.test(demo_TDS2$s2_age~demo_TDS2$gender) 

# t = -0.43967, df = 67.653, p-value = 0.6616
# alternative hypothesis: true difference in means is not equal to 0
# 95 percent confidence interval:
#  -0.8864616  0.5663797
# sample estimates:
# mean in group 0 mean in group 1 
#        14.05212        14.21216 

TDS2_iq_by_sex<-demo_TDS2 %>% filter(!is.na(s2_iq)) %>% group_by(gender) %>% 
  summarize(mean = mean(s2_iq, na.rm=T), sd = sd(s2_iq, na.rm=T), 
            min = min(s2_iq, na.rm=T), max = max(s2_iq, na.rm=T),
            n = n(), se = sd/sqrt(n), ci=qt(0.975, df=n-1)*se)

t.test(demo_TDS2$s2_iq~demo_TDS2$gender) 

# t = -0.74177, df = 67.989, p-value = 0.4608
# alternative hypothesis: true difference in means is not equal to 0
# 95 percent confidence interval:
#  -7.609971  3.485483
# sample estimates:
# mean in group 0 mean in group 1 
#        106.4242        108.4865 

pds_by_sex<-demo_TDS2 %>% filter(!is.na(PDS_mean_score)) %>% group_by(gender) %>% 
  summarize(mean = mean(PDS_mean_score, na.rm=T), sd = sd(PDS_mean_score, na.rm=T),
            min = min(PDS_mean_score, na.rm=T), max = max(PDS_mean_score, na.rm=T),
            n = n(), se = sd/sqrt(n), ci=qt(0.975, df=n-1)*se)

t.test(demo_TDS2$PDS_mean_score~demo_TDS2$gender) 

# t = -4.6755, df = 65.396, p-value = 1.514e-05
# alternative hypothesis: true difference in means is not equal to 0
# 95 percent confidence interval:
#  -0.9991348 -0.4010977
# sample estimates:
# mean in group 0 mean in group 1 
#        2.454839        3.154955 


ylg = ylg_data %>% 
  mutate(condition = ifelse(grepl('1|2', run_index), 1,
                     ifelse(grepl('3|4', run_index), 2,
                     ifelse(grepl('5|6', run_index), 3, 
                     ifelse(grepl('7|8', run_index), 4, NA))))) %>%
  mutate(time=run_time_ms/60000) %>%
  mutate(go = ifelse(decision=='GO', 1, 0)) %>%
  mutate(crash = ifelse(scenario=='CRASH', 1, 0)) %>%
  mutate(go_cr = ifelse(decision=='GO' & scenario=='CRASH', 1, 0)) %>%
  mutate(stop = ifelse(decision=='STOP', 1, 0)) %>%
  mutate(stop_nocar = ifelse(decision=='STOP' & scenario=='SAFE', 1, 0)) %>%
  mutate(event = ifelse(decision=='GO' & scenario=='SAFE', 1,
                 ifelse(decision=='GO' & scenario=='CRASH', 2,
                 ifelse(decision=='STOP' & scenario=='CROSSCAR', 3,
                 ifelse(decision=='STOP' & scenario=='SAFE', 4, NA))))) %>%
  mutate(penalty = ifelse(decision=='NONE', 1, 0)) %>%
  mutate(count1 = ifelse(event==1, 1, 0)) %>%
  mutate(count2 = ifelse(event==2, 1, 0)) %>%
  mutate(count3 = ifelse(event==3, 1, 0)) %>%
  mutate(count4 = ifelse(event==4, 1, 0))

ylg$SID <- ylg$subject_name

# Check if events are present for all subjects
events_by_sid <- ylg %>% group_by(subject_name, condition) %>%
  summarize(n_good.go = sum(count1, na.rm=TRUE),
            n_bad.go = sum(count2, na.rm=TRUE),
            n_good.stop = sum(count3, na.rm=TRUE),
            n_bad.stop = sum(count4, na.rm=TRUE))

# Convert to factors
ylg$run_index <- as.factor(ylg$run_index)
ylg$condition <- as.factor(ylg$condition)

exclude = c(401, 402, 403, 404, 405, 406, 407, 408, 409, 410, 411)

no_session2 = c(118, 123, 147, 148, 149, 153, 154, 166, 180)
behaviorals = c(103, 107, 112, 138, 143, 176, 191)
pilot_cyberball = c(101, 102, 104, 105, 106, 108, 110, 111)
motion_dropout = c(189, 158, 139)


ylg_filtered_TDS2 = ylg %>% filter(subject_name < 300) %>% 
  filter(!subject_name %in% exclude) %>%
  filter(!subject_name %in% no_session2) %>%
  filter(!subject_name %in% behaviorals) %>%
  filter(!subject_name %in% pilot_cyberball) %>%
  filter(!subject_name %in% motion_dropout)

count_trials_per_subTDS2<-ylg_filtered_TDS2 %>% group_by(subject_name) %>% summarize(n()) 

# Set labels
condition_labels = c(`1`='Mock', `2`='Alone', `3`='Peer Incl', `4`='Peer Excl')

colnames(ylg_filtered_TDS2)[which(names(ylg_filtered_TDS2) == "subject_name")] <- "scores.SID"

# Dataset for behavioral analyses (incomplete and complete runs)
df_TDS2 <- merge(demo_TDS2, ylg_filtered_TDS2, by = 'scores.SID')

df_TDS2<-mutate(df_TDS2, Group =  'TDS2')

df_fMRI_all_TDS2<-df_TDS2 %>% filter(condition != "1")

countTDS2<-df_TDS2 %>% group_by(scores.SID, gender) %>% summarize(n()) 


# Remove columns that are not congruent between TDS 1 and TDS 2
df_fMRI_all_TDS2$scores.female_height = NULL
df_fMRI_all_TDS2$scores.female_weight = NULL
df_fMRI_all_TDS2$scores.male_height = NULL
df_fMRI_all_TDS2$scores.male_weight = NULL
df_fMRI_all$pred_go = NULL
df_fMRI_all$group = NULL

allTDSfMRI <- rbind(df_fMRI_all, df_fMRI_all_TDS2)
#need group to binary, not character
allTDSfMRI_bi <- allTDSfMRI %>% mutate(Group = ifelse(Group == "TDS1", 1, 0))
str(allTDSfMRI_bi$Group)
allTDSfMRI_bi$Group <- as.factor(allTDSfMRI_bi$Group)
allTDSfMRI <- allTDSfMRI_bi
```

####################################################
## GROUP DIFFERENCES Chi Square             ##
####################################################
```{r} 

# add group label

demo_filtered_context$group=0
demo_TDS2$group = 1
# combine groups
chisq.data<- rbind(select(demo_filtered_context, scores.SID, group, gender), select(demo_TDS2, scores.SID, group, gender))
# make table
chisq_table<-table(chisq.data$group, chisq.data$gender)
chisq.test(chisq_table)

# data:  chisq_table
# X-squared = 1.2284, df = 1, p-value = 0.2677

PDS_mean_scores <- demo_filtered_context %>% distinct(scores.SID, gender, scores.pds_gender, PDS_mean_score) %>% filter(!grepl("338|358|339|345", scores.SID)) 
write.csv(PDS_mean_scores, file = 'tds1_PDS_mean_score_n69.csv')

```






##############################################
## COMM Social Context effects on GO DECISIONS ##
#Do COMM teens engage in more Go decisions in social contexts? 
(yes)#
##############################################
```{r}
# Condition effects on the proportion of Go decisions
null.model <- glmer(go ~ (1|scores.SID), data=df_fMRI_all_TDS2, family='binomial')
condition.model <- glmer(go ~ condition + (1|scores.SID), data=df_fMRI_all_TDS2, family='binomial')
anova(null.model, condition.model)   
# null.model: go ~ (1 | scores.SID)
# condition.model: go ~ condition + (1 | scores.SID)
#                 Df   AIC   BIC  logLik deviance  Chisq Chi Df Pr(>Chisq)    
# null.model       2 10848 10862 -5422.0    10844                             
# condition.model  4 10811 10839 -5401.6    10803 40.686      2  1.462e-09 ***
  

summary(condition.model)  
# Fixed effects:
#             Estimate Std. Error z value Pr(>|z|)    
# (Intercept) -0.61621    0.08402  -7.334 2.24e-13 ***
# condition3   0.17151    0.05715   3.001  0.00269 ** 
# condition4   0.36169    0.05684   6.364 1.97e-10 ***

social_df <- df_fMRI_all_TDS2 %>% filter(condition != "2")
null.model <- glmer(go ~ (1|scores.SID), data=social_df, family='binomial')
condition.model <- glmer(go ~ condition + (1|scores.SID), data=social_df, family='binomial')
anova(null.model, condition.model)  
# null.model: go ~ (1 | scores.SID)
# condition.model: go ~ condition + (1 | scores.SID)
#                 Df    AIC    BIC  logLik deviance Chisq Chi Df Pr(>Chisq)    
# null.model       2 7349.4 7362.6 -3672.7   7345.4                            
# condition.model  3 7340.0 7359.9 -3667.0   7334.0 11.37      1  0.0007464 ***
summary(condition.model) 
# Random effects:
#  Groups     Name        Variance Std.Dev.
#  scores.SID (Intercept) 0.3583   0.5986  
# Number of obs: 5600, groups:  scores.SID, 70
# 
# Fixed effects:
#             Estimate Std. Error z value Pr(>|z|)    
# (Intercept) -0.44144    0.08211  -5.376  7.6e-08 ***
# condition4   0.18959    0.05622   3.372 0.000745 ***

#significant increase in go decisions across contexts


go <- df_fMRI_all_TDS2 %>% select(scores.SID, condition, go)


plot.go <- go %>% group_by(condition) %>%
  summarize(mean = mean(go), sd = sd(go), n = n(), se = sd/sqrt(n), ci=qt(0.975, df=n-1)*se)


ggplot(plot.go, aes(x = condition, y = mean)) +
  geom_point() +
  geom_errorbar(aes(ymax=mean+se, ymin=mean-se), width=0.5, position=position_dodge(.2)) +
  facet_grid(.~condition, scales='free', labeller=as_labeller(condition_labels)) +
  labs(x='Social Context', y='Go') 
```


#########################################
## COMM Social Context effects on CRASHES ##
#Do COMM teens engage in more crashs decisions in social contexts? 
(yes)#
#########################################
```{r}

# Condition effects on the proportion of Go Crash decisions
null.model <- glmer(go_cr ~ (1|scores.SID), data=df_fMRI_all_TDS2, family='binomial')
condition.model <- glmer(go_cr ~ condition + (1|scores.SID), data=df_fMRI_all_TDS2, family='binomial')
anova(null.model, condition.model)   
# null.model: go_cr ~ (1 | scores.SID)
# condition.model: go_cr ~ condition + (1 | scores.SID)
#                 Df    AIC    BIC  logLik deviance  Chisq Chi Df Pr(>Chisq)   
# null.model       2 8372.8 8386.8 -4184.4   8368.8                            
# condition.model  4 8366.1 8394.2 -4179.0   8358.1 10.657      2    0.00485 **
  

summary(condition.model)  
# Random effects:
#  Groups     Name        Variance Std.Dev.
#  scores.SID (Intercept) 0.2109   0.4592  
# Number of obs: 8400, groups:  scores.SID, 70
# 
# Fixed effects:
#             Estimate Std. Error z value Pr(>|z|)    
# (Intercept) -1.51506    0.07395 -20.486  < 2e-16 ***
# condition3   0.06796    0.06827   0.996  0.31947    
# condition4   0.21366    0.06699   3.189  0.00143 **

social_df <- df_fMRI_all_TDS2 %>% filter(condition != "2")
null.model <- glmer(go_cr ~ (1|scores.SID), data=social_df, family='binomial')
condition.model <- glmer(go_cr ~ condition + (1|scores.SID), data=social_df, family='binomial')
anova(null.model, condition.model)  
# null.model: go_cr ~ (1 | scores.SID)
# condition.model: go_cr ~ condition + (1 | scores.SID)
#                 Df    AIC    BIC  logLik deviance  Chisq Chi Df Pr(>Chisq)  
# null.model       2 5720.5 5733.7 -2858.2   5716.5                           
# condition.model  3 5717.7 5737.6 -2855.8   5711.7 4.7872      1    0.02867 *
summary(condition.model) 
# Random effects:
#  Groups     Name        Variance Std.Dev.
#  scores.SID (Intercept) 0.1728   0.4157  
# Number of obs: 5600, groups:  scores.SID, 70
# 
# Fixed effects:
#             Estimate Std. Error z value Pr(>|z|)    
# (Intercept) -1.43677    0.06956 -20.656   <2e-16 ***
# condition4   0.14512    0.06618   2.193   0.0283 * 

#significant increase in crashes decisions across contexts


go_cr <- df_fMRI_all_TDS2 %>% select(scores.SID, condition, go_cr)


plot.go_cr <- go_cr %>% group_by(condition) %>%
  summarize(mean = mean(go_cr), sd = sd(go_cr), n = n(), se = sd/sqrt(n), ci=qt(0.975, df=n-1)*se)


ggplot(plot.go_cr, aes(x = condition, y = mean)) +
  geom_point() +
  geom_errorbar(aes(ymax=mean+se, ymin=mean-se), width=0.5, position=position_dodge(.2)) +
  facet_grid(.~condition, scales='free', labeller=as_labeller(condition_labels)) +
  labs(x='Social Context', y='Go Crash') 
```


################################################
## COMM Social Context effects on STOP DECISIONS ##
#Do COMM teens engage in less stop decisions in social contexts? 
(yes)#
################################################
```{r}

# Condition effects on the proportion of Stop decisions
null.model <- glmer(stop ~ (1|scores.SID), data=df_fMRI_all_TDS2, family='binomial')
condition.model <- glmer(stop ~ condition + (1|scores.SID), data=df_fMRI_all_TDS2, family='binomial')
anova(null.model, condition.model)   
# null.model: stop ~ (1 | scores.SID)
# condition.model: stop ~ condition + (1 | scores.SID)
#                 Df   AIC   BIC  logLik deviance  Chisq Chi Df Pr(>Chisq)    
# null.model       2 10981 10995 -5488.5    10977                             
# condition.model  4 10954 10982 -5472.9    10946 31.045      2  1.814e-07 ***
  

summary(condition.model)  
# Random effects:
#  Groups     Name        Variance Std.Dev.
#  scores.SID (Intercept) 0.3783   0.6151  
# Number of obs: 8400, groups:  scores.SID, 70
# 
# Fixed effects:
#             Estimate Std. Error z value Pr(>|z|)    
# (Intercept)  0.44074    0.08385   5.256 1.47e-07 ***
# condition3  -0.12626    0.05652  -2.234   0.0255 *  
# condition4  -0.31146    0.05632  -5.530 3.21e-08 ***

social_df <- df_fMRI_all_TDS2 %>% filter(condition != "2")
null.model <- glmer(stop ~ (1|scores.SID), data=social_df, family='binomial')
condition.model <- glmer(stop ~ condition + (1|scores.SID), data=social_df, family='binomial')
anova(null.model, condition.model)  
# null.model: stop ~ (1 | scores.SID)
# condition.model: stop ~ condition + (1 | scores.SID)
#                 Df    AIC    BIC  logLik deviance  Chisq Chi Df Pr(>Chisq)    
# null.model       2 7402.0 7415.2 -3699.0   7398.0                             
# condition.model  3 7393.1 7413.0 -3693.5   7387.1 10.901      1   0.000961 ***
summary(condition.model) 
# Random effects:
#  Groups     Name        Variance Std.Dev.
#  scores.SID (Intercept) 0.3702   0.6084  
# Number of obs: 5600, groups:  scores.SID, 70
# 
# Fixed effects:
#             Estimate Std. Error z value Pr(>|z|)    
# (Intercept)  0.31236    0.08295   3.766 0.000166 ***
# condition4  -0.18484    0.05598  -3.302 0.000960 ***

#significant increase instop decisions across contexts


stop <- df_fMRI_all_TDS2 %>% select(scores.SID, condition, stop)


plot.stop <- stop %>% group_by(condition) %>%
  summarize(mean = mean(stop), sd = sd(stop), n = n(), se = sd/sqrt(n), ci=qt(0.975, df=n-1)*se)


ggplot(plot.stop, aes(x = condition, y = mean)) +
  geom_point() +
  geom_errorbar(aes(ymax=mean+se, ymin=mean-se), width=0.5, position=position_dodge(.2)) +
  facet_grid(.~condition, scales='free', labeller=as_labeller(condition_labels)) +
  labs(x='Social Context', y='Stop') 
```


###############################################################################
## COMM Social Context effects on Stop decisions when there was no crossing car ##
#Do COMM teens engage in more bad stop decisions in social contexts? 
(no, less from alone to peer exclusion)#
###############################################################################
```{r}

# Condition effects on the proportion of Bad Stop decisions
null.model <- glmer(stop_nocar ~ (1|scores.SID), data=df_fMRI_all_TDS2, family='binomial')
condition.model <- glmer(stop_nocar ~ condition + (1|scores.SID), data=df_fMRI_all_TDS2, family='binomial')
anova(null.model, condition.model)   
# null.model: stop_nocar ~ (1 | scores.SID)
# condition.model: stop_nocar ~ condition + (1 | scores.SID)
#                 Df    AIC    BIC  logLik deviance Chisq Chi Df Pr(>Chisq)   
# null.model       2 9870.5 9884.6 -4933.3   9866.5                           
# condition.model  4 9862.1 9890.3 -4927.1   9854.1  12.4      2   0.002029 **


summary(condition.model)  
# Random effects:
#  Groups     Name        Variance Std.Dev.
#  scores.SID (Intercept) 0.09542  0.3089  
# Number of obs: 8400, groups:  scores.SID, 70
# 
# Fixed effects:
#             Estimate Std. Error z value Pr(>|z|)    
# (Intercept) -0.86988    0.05576 -15.602  < 2e-16 ***
# condition3  -0.10275    0.05949  -1.727  0.08413 .  
# condition4  -0.21212    0.06025  -3.521  0.00043 ***

social_df <- df_fMRI_all_TDS2 %>% filter(condition != "2")
null.model <- glmer(stop_nocar ~ (1|scores.SID), data=social_df, family='binomial')
condition.model <- glmer(stop_nocar ~ condition + (1|scores.SID), data=social_df, family='binomial')
anova(null.model, condition.model)  
# null.model: stop_nocar ~ (1 | scores.SID)
# condition.model: stop_nocar ~ condition + (1 | scores.SID)
#                 Df    AIC    BIC  logLik deviance  Chisq Chi Df Pr(>Chisq)  
# null.model       2 6478.7 6491.9 -3237.3   6474.7                           
# condition.model  3 6477.4 6497.3 -3235.7   6471.4 3.2252      1    0.07251 .
summary(null.model) 
# Random effects:
#  Groups     Name        Variance Std.Dev.
#  scores.SID (Intercept) 0.09398  0.3066  
# Number of obs: 5600, groups:  scores.SID, 70
# 
# Fixed effects:
#             Estimate Std. Error z value Pr(>|z|)    
# (Intercept)  -1.0263     0.0479  -21.43   <2e-16 ***

#significant decrease in bad stop decisions from alone to peer exclusion


stop_nocar <- df_fMRI_all_TDS2 %>% select(scores.SID, condition, stop_nocar)


plot.stop_nocar <- stop_nocar %>% group_by(condition) %>%
  summarize(mean = mean(stop_nocar), sd = sd(stop_nocar), n = n(), se = sd/sqrt(n), ci=qt(0.975, df=n-1)*se)


ggplot(plot.stop_nocar, aes(x = condition, y = mean)) +
  geom_point() +
  geom_errorbar(aes(ymax=mean+se, ymin=mean-se), width=0.5, position=position_dodge(.2)) +
  facet_grid(.~condition, scales='free', labeller=as_labeller(condition_labels)) +
  labs(x='Social Context', y='Bad Stop') 
```



###############################################################################
## COMM Social Context effects on Game Time ##
#Do COMM teens have faster time in social contexts? 
(yes from alone to peer context, but not between peer context)#
###############################################################################
```{r}
# Condition effects on the game time
null.model <- lmer(time ~ (1|scores.SID), data=df_fMRI_all_TDS2)
condition.model <- lmer(time ~ condition + (1|scores.SID), data=df_fMRI_all_TDS2)
anova(null.model, condition.model)   
# null.model: time ~ (1 | scores.SID)
# condition.model: time ~ condition + (1 | scores.SID)
#                 Df    AIC    BIC logLik deviance  Chisq Chi Df Pr(>Chisq)    
# null.model       3 -11547 -11526 5776.7   -11553                             
# condition.model  5 -11710 -11675 5860.3   -11720 167.17      2  < 2.2e-16 ***


summary(condition.model)  
# Random effects:
#  Groups     Name        Variance Std.Dev.
#  scores.SID (Intercept) 0.003704 0.06086 
#  Residual               0.014096 0.11873 
# Number of obs: 8400, groups:  scores.SID, 70
# 
# Fixed effects:
#               Estimate Std. Error         df t value Pr(>|t|)    
# (Intercept)  2.330e+00  7.613e-03  7.774e+01  306.01   <2e-16 ***
# condition3  -3.239e-02  3.173e-03  8.328e+03  -10.21   <2e-16 ***
# condition4  -3.829e-02  3.173e-03  8.328e+03  -12.07   <2e-16 ***

social_df <- df_fMRI_all_TDS2 %>% filter(condition != "2")
null.model <- lmer(time ~ (1|scores.SID), data=social_df)
condition.model <- lmer(time ~ condition + (1|scores.SID), data=social_df)
anova(null.model, condition.model)  
# null.model: time ~ (1 | scores.SID)
# condition.model: time ~ condition + (1 | scores.SID)
#                 Df     AIC     BIC logLik deviance  Chisq Chi Df Pr(>Chisq)  
# null.model       3 -8126.7 -8106.8 4066.3  -8132.7                           
# condition.model  4 -8128.4 -8101.9 4068.2  -8136.4 3.7148      1    0.05393 .

summary(null.model) 
# Random effects:
#  Groups     Name        Variance Std.Dev.
#  scores.SID (Intercept) 0.00487  0.06978 
#  Residual               0.01313  0.11459 
# Number of obs: 5600, groups:  scores.SID, 70
# 
# Fixed effects:
#             Estimate Std. Error       df t value Pr(>|t|)    
# (Intercept)  2.29430    0.00848 69.00000   270.6   <2e-16 ***

#significant decrease in bad stop decisions from alone to peer inclusion and exclusion, not between peer contexts.


time <- df_fMRI_all_TDS2 %>% select(scores.SID, condition, time)


plot.time <- time %>% group_by(condition) %>%
  summarize(mean = mean(time), sd = sd(time), n = n(), se = sd/sqrt(n), ci=qt(0.975, df=n-1)*se)


ggplot(plot.time, aes(x = condition, y = mean)) +
  geom_point() +
  geom_errorbar(aes(ymax=mean+se, ymin=mean-se), width=0.5, position=position_dodge(.2)) +
  facet_grid(.~condition, scales='free', labeller=as_labeller(condition_labels)) +
  labs(x='Social Context', y='Time') 
```



########################################################################
## CWI Social Context effects on GO DECISIONS ##
#Do CWI teens engage in more Go decisions in social contexts? 
(no)#
########################################################################
```{r}
# Condition effects on the proportion of Go decisions
null.model <- glmer(go ~ (1|scores.SID), data=df_fMRI_all, family='binomial')
condition.model <- glmer(go ~ condition + (1|scores.SID), data=df_fMRI_all, family='binomial')
anova(null.model, condition.model)  
#                 Df   AIC   BIC  logLik deviance  Chisq Chi Df Pr(>Chisq)    
# null.model       2 10274 10288 -5134.8    10270                         
# condition.model  4 10274 10302 -5132.8    10266 4.0031      2     0.1351
summary(condition.model)  
#  Fixed effects:
#             Estimate Std. Error z value Pr(>|z|)    
# (Intercept) -0.60673    0.10446  -5.808 6.32e-09 ***
# condition3   0.09396    0.05788   1.623    0.105    
# condition4  -0.01289    0.05898  -0.219    0.827 

#CWI teens did not take sig more go risks across social conditions.

social_df <- df_fMRI_all %>% filter(condition != "2")
null.model <- glmer(go ~ (1|scores.SID), data=social_df, family='binomial')
condition.model <- glmer(go ~ condition + (1|scores.SID), data=social_df, family='binomial')
anova(null.model, condition.model)  
#                Df    AIC    BIC  logLik deviance Chisq Chi Df Pr(>Chisq)    
# (Intercept) -0.50580    0.10248  -4.935    8e-07 ***
# condition4  -0.10851    0.05904  -1.838   0.0661 .  
summary(condition.model) 
# Fixed effects:
#             Estimate Std. Error z value Pr(>|z|)    
# (Intercept) -0.50580    0.10248  -4.935    8e-07 ***
# condition4  -0.10851    0.05904  -1.838   0.0661 . 

#no sig difference between social runs-- which is expected given we didn't see diff above for social.


go <- df_fMRI_all %>% select(scores.SID, condition, go)


plot.go <- go %>% group_by(condition) %>%
  summarize(mean = mean(go), sd = sd(go), n = n(), se = sd/sqrt(n), ci=qt(0.975, df=n-1)*se)


ggplot(plot.go, aes(x = condition, y = mean)) +
  geom_point() +
  geom_errorbar(aes(ymax=mean+se, ymin=mean-se), width=0.5, position=position_dodge(.2)) +
  facet_grid(.~condition, scales='free', labeller=as_labeller(condition_labels)) +
  labs(x='Social Context', y='Go') 
```


##################################################################################
## CWI Social Context effects on CRASHES (BAD GO) ##
#Do CWI teens engage in more maladaptive go decisions in social contexts? 
(no)#
##################################################################################
```{r}

# Condition effects on the proportion of Go decisions that resulted in Crashes
null.model <- glmer(go_cr ~ (1|scores.SID), data=df_fMRI_all, family='binomial')
condition.model <- glmer(go_cr ~ condition + (1|scores.SID), data=df_fMRI_all, family='binomial')
anova(null.model, condition.model)         
#                 Df    AIC    BIC  logLik deviance  Chisq Chi Df Pr(>Chisq)   
# null.model       2 7861.5 7875.5 -3928.7   7857.5                         
# condition.model  4 7863.5 7891.5 -3927.7   7855.5 2.0141      2     0.3653
summary(condition.model) 
# Fixed effects:
#             Estimate Std. Error z value Pr(>|z|)    
# (Intercept) -1.50732    0.08110 -18.585   <2e-16 ***
# condition3   0.03090    0.06871   0.450    0.653    
# condition4  -0.06709    0.07043  -0.953    0.341     

#


null.model <- glmer(go_cr ~ (1|scores.SID), data=social_df, family='binomial')
condition.model <- glmer(go_cr ~ condition + (1|scores.SID), data=social_df, family='binomial')
anova(null.model, condition.model)         
#                 Df    AIC    BIC  logLik deviance  Chisq Chi Df Pr(>Chisq)  
# null.model       2 5221.2 5234.4 -2608.6   5217.2                         
# condition.model  3 5221.2 5241.0 -2607.6   5215.2 1.9773      1     0.1597
summary(condition.model) 
# Fixed effects:
#             Estimate Std. Error z value Pr(>|z|)    
# (Intercept) -1.46868    0.07809 -18.808   <2e-16 ***
# condition4  -0.09902    0.07016  -1.411    0.158    

#

go_cr <- df_fMRI_all %>% select(scores.SID, condition, go_cr)


plot.go_cr <- go_cr %>% group_by(condition) %>%
  summarize(mean = mean(go_cr), sd = sd(go_cr), n = n(), se = sd/sqrt(n), ci=qt(0.975, df=n-1)*se)

ggplot(plot.go_cr, aes(x = condition, y = mean)) +
  geom_point() +
  geom_errorbar(aes(ymax=mean+se, ymin=mean-se), width=0.5, position=position_dodge(.2)) +
  facet_grid(.~condition, scales='free', labeller=as_labeller(condition_labels)) +
  labs(x='Social Context', y='Go_Crash') 

```


#################################################################################
## CWI Social Context effects on STOP DECISIONS ##
#Do CWI teens engage in more stop decisions in social contexts? 
(YES- stop more following SE than alone or PR)#
#################################################################################
```{r}
## Condition effects on the proportion of Stop decisions
null.model <- glmer(stop ~ (1|scores.SID), data=df_fMRI_all, family='binomial')
condition.model <- glmer(stop ~ condition + (1|scores.SID), data=df_fMRI_all, family='binomial')
anova(null.model, condition.model)
#                 Df   AIC   BIC  logLik deviance  Chisq Chi Df Pr(>Chisq)    
# null.model       2 10630 10644 -5312.9    10626                           
# condition.model  4 10627 10655 -5309.6    10619 6.5727      2    0.03739 *
summary(condition.model) 
# Fixed effects:
#             Estimate Std. Error z value Pr(>|z|)    
# (Intercept)  0.30274    0.09304   3.254  0.00114 **
# condition3   0.01444    0.05661   0.255  0.79869   
# condition4   0.13517    0.05761   2.346  0.01896 *  

#CWI show increase in stops from alone to SE)


null.model <- glmer(stop ~ (1|scores.SID), data=social_df, family='binomial')
condition.model <- glmer(stop ~ condition + (1|scores.SID), data=social_df, family='binomial')
anova(null.model, condition.model)
#                 Df    AIC    BIC  logLik deviance  Chisq Chi Df Pr(>Chisq)    
# null.model       2 7023.9 7037.1 -3510.0   7019.9                           
# condition.model  3 7021.7 7041.4 -3507.8   7015.7 4.2543      1    0.03915 *

summary(condition.model)
# Fixed effects:
#             Estimate Std. Error z value Pr(>|z|)    
# (Intercept)  0.32145    0.09704   3.312 0.000925 ***
# condition4   0.11976    0.05802   2.064 0.039011 *  

#Confirmed-- sig more stops SE from peer as well for CWI teens


stop <- df_fMRI_all %>% select(scores.SID, condition, stop)


plot.stop <- stop %>% group_by(condition) %>%
  summarize(mean = mean(stop), sd = sd(stop), n = n(), se = sd/sqrt(n), ci=qt(0.975, df=n-1)*se)

ggplot(plot.stop, aes(x = condition, y = mean)) +
  geom_point() +
  geom_errorbar(aes(ymax=mean+se, ymin=mean-se), width=0.5, position=position_dodge(.2)) +
  facet_grid(.~condition, scales='free', labeller=as_labeller(condition_labels)) +
  labs(x='Social Context', y='Stop') 
```


#######################################################################################
## CWI Social Context effects on Stop decisions when there was no crossing car (BAD STOP)##
#Do CWI teens engage in more maladatpive stop decisions in social contexts? (no)#
#######################################################################################
```{r}

# Condition effects on the proportion of Stop decisions
null.model <- glmer(stop_nocar ~ (1|scores.SID), data=df_fMRI_all, family='binomial')
condition.model <- glmer(stop_nocar ~ condition + (1|scores.SID), data=df_fMRI_all, family='binomial')
anova(null.model, condition.model)
#                 Df    AIC    BIC  logLik deviance Chisq Chi Df Pr(>Chisq)   
# null.model       2 9632.4 9646.4 -4814.2   9628.4                        
# condition.model  4 9636.0 9664.0 -4814.0   9628.0 0.428      2     0.8073

summary(condition.model) 
# Fixed effects:
#             Estimate Std. Error z value Pr(>|z|)    
# (Intercept) -0.97064    0.05825 -16.664   <2e-16 ***
# condition3  -0.01106    0.06065  -0.182    0.855    
# condition4   0.02786    0.06105   0.456    0.648     

#confirmed collapsed across conditions

#within social bad stops 
null.model <- glmer(stop_nocar ~ (1|scores.SID), data=social_df, family='binomial')
condition.model <- glmer(stop_nocar ~ condition + (1|scores.SID), data=social_df, family='binomial')
anova(null.model, condition.model)
#                 Df    AIC    BIC  logLik deviance  Chisq Chi Df Pr(>Chisq)  
# null.model       2 6395.4 6408.6 -3195.7   6391.4                         
# condition.model  3 6397.0 6416.8 -3195.5   6391.0 0.3948      1     0.5298

summary(null.model) 

# Fixed effects:
#             Estimate Std. Error z value Pr(>|z|)    
# (Intercept) -0.96550    0.05187  -18.61   <2e-16 ***

#this is confirmed that doesn't change between social conditions either

stop_nocar <- df_fMRI_all %>% select(scores.SID, condition, stop_nocar)


plot.stop_nocar <- stop_nocar %>% group_by(condition) %>%
  summarize(mean = mean(stop_nocar), sd = sd(stop_nocar), n = n(), se = sd/sqrt(n), ci=qt(0.975, df=n-1)*se)

ggplot(plot.stop_nocar, aes(x = condition, y = mean)) +
  geom_point() +
  geom_errorbar(aes(ymax=mean+se, ymin=mean-se), width=0.5, position=position_dodge(.2)) +
  facet_grid(.~condition, scales='free', labeller=as_labeller(condition_labels)) +
  labs(x='Social Context', y='Stop') 

```


#####################################################################
## CWI Social Context on Game Time + plot ##
#slowest alone, faster social, no difference pos or neg
#####################################################################
```{r}
# Condition effects on the proportion of Go decisions
null.model <- lmer(time ~ (1|scores.SID), data=df_fMRI_all)
condition.model <- lmer(time ~ condition + (1|scores.SID), data=df_fMRI_all)
anova(null.model, condition.model)  
# null.model: time ~ (1 | scores.SID)
# condition.model: time ~ condition + (1 | scores.SID)
#                 Df     AIC     BIC logLik deviance  Chisq Chi Df Pr(>Chisq)    
# null.model       3 -8170.9 -8149.9 4088.5  -8176.9                             
# condition.model  5 -8452.3 -8417.2 4231.1  -8462.3 285.34      2  < 2.2e-16 ***
summary(condition.model)  
# Fixed effects:
#               Estimate Std. Error         df t value Pr(>|t|)    
# (Intercept)  2.369e+00  1.107e-02  7.363e+01  214.02   <2e-16 ***
# condition3  -4.861e-02  3.821e-03  8.109e+03  -12.72   <2e-16 ***
# condition4  -6.249e-02  3.872e-03  8.113e+03  -16.14   <2e-16 ***


social_df <- df_fMRI_all %>% filter(condition != "2")
null.model <- lmer(time ~ (1|scores.SID), data=social_df)
condition.model <- lmer(time ~ condition + (1|scores.SID), data=social_df)
anova(null.model, condition.model)  
# Models:
# null.model: time ~ (1 | scores.SID)
# condition.model: time ~ condition + (1 | scores.SID)
#                 Df     AIC     BIC logLik deviance  Chisq Chi Df Pr(>Chisq)    
# null.model       3 -6919.0 -6899.2 3462.5  -6925.0                             
# condition.model  4 -6933.8 -6907.4 3470.9  -6941.8 16.869      1  4.004e-05 ***
summary(condition.model) 
# Fixed effects:
#               Estimate Std. Error         df t value Pr(>|t|)    
# (Intercept)  2.320e+00  1.036e-02  7.128e+01 223.913  < 2e-16 ***
# condition4  -1.403e-02  3.413e-03  5.358e+03  -4.112 3.99e-05 *** 

# 

game <- df_fMRI_all %>% distinct(scores.SID, condition, time)


plot.game <- game %>% group_by(condition) %>%
  summarize(mean = mean(time), sd = sd(time), n = n(), se = sd/sqrt(n), ci=qt(0.975, df=n-1)*se)

ggplot(plot.game, aes(x = condition, y = mean)) +
  geom_point() +
  geom_errorbar(aes(ymax=mean + se, ymin=mean - se), width=0.5, position=position_dodge(.2)) +
  facet_grid(.~condition, scales='free', labeller=as_labeller(condition_labels)) +
  labs(x='Social Context', y='Game Time') 

```



####################################################################################
## DEVELOPMENTAL EFFECTS ##
####################################################################################



################################################################
## COMM Age effects on GO DECISIONS while controlling for Sex & IQ ##
(no)
################################################################
```{r}
# Linear Age effects on the proportion of Go decisions (by location)
null.model <- glmer(go ~ condition + gender + iq_z + (1|scores.SID), data=df_fMRI_all_TDS2, family='binomial')
main.model <- glmer(go ~ age_c + condition + gender + iq_z + (1|scores.SID), data=df_fMRI_all_TDS2, family='binomial')
interaction.model <- glmer(go ~ age_c * condition + gender + iq_z + (1|scores.SID), data=df_fMRI_all_TDS2, family='binomial')

anova(null.model, main.model)
# null.model: go ~ condition + gender + iq_z + (1 | scores.SID)
# main.model: go ~ age_c + condition + gender + iq_z + (1 | scores.SID)
#            Df   AIC   BIC  logLik deviance  Chisq Chi Df Pr(>Chisq)
# null.model  6 10814 10857 -5401.2    10802                         
# main.model  7 10816 10866 -5401.2    10802 0.0643      1     0.7998
anova(null.model, interaction.model)
# null.model: go ~ condition + gender + iq_z + (1 | scores.SID)
# interaction.model: go ~ age_c * condition + gender + iq_z + (1 | scores.SID)
#                   Df   AIC   BIC  logLik deviance  Chisq Chi Df Pr(>Chisq)
# null.model         6 10814 10857 -5401.2    10802                         
# interaction.model  9 10815 10878 -5398.6    10797 5.1947      3     0.1581

summary(null.model)
# Random effects:
#  Groups     Name        Variance Std.Dev.
#  scores.SID (Intercept) 0.3705   0.6087  
# Number of obs: 8400, groups:  scores.SID, 70
# 
# Fixed effects:
#             Estimate Std. Error z value Pr(>|z|)    
# (Intercept) -0.53242    0.12406  -4.292 1.77e-05 ***
# condition3   0.17151    0.05715   3.001  0.00269 ** 
# condition4   0.36170    0.05684   6.364 1.97e-10 ***
# gender      -0.13363    0.15371  -0.869  0.38465    
# iq_z        -0.02588    0.09932  -0.261  0.79441    
  
```


###########################################################
## COMM Age effects on STOP while controlling for Sex & IQ ##
(no)
###########################################################
```{r}
# Age effects on stop decisions by social context
null.model <- glmer(stop ~ condition + gender + iq_z + (1|scores.SID), data=df_fMRI_all_TDS2, family='binomial')
main.model <- glmer(stop ~ age_c + condition + gender + iq_z + (1|scores.SID), data=df_fMRI_all_TDS2, family='binomial')
interaction.model <- glmer(stop ~ age_c*condition + gender + iq_z + (1|scores.SID), data=df_fMRI_all_TDS2, family='binomial')

anova(null.model, main.model)
# null.model: stop ~ condition + gender + iq_z + (1 | scores.SID)
# main.model: stop ~ age_c + condition + gender + iq_z + (1 | scores.SID)
#            Df   AIC   BIC  logLik deviance  Chisq Chi Df Pr(>Chisq)
# null.model  6 10956 10999 -5472.2    10944                         
# main.model  7 10958 11008 -5472.2    10944 0.0068      1     0.9341
anova(null.model, interaction.model)
# null.model: stop ~ condition + gender + iq_z + (1 | scores.SID)
# interaction.model: stop ~ age_c * condition + gender + iq_z + (1 | scores.SID)
#                   Df   AIC   BIC  logLik deviance  Chisq Chi Df Pr(>Chisq)
# null.model         6 10956 10999 -5472.2    10944                         
# interaction.model  9 10957 11021 -5469.6    10939 5.1384      3     0.1619


summary(null.model)
# Random effects:
#  Groups     Name        Variance Std.Dev.
#  scores.SID (Intercept) 0.3695   0.6079  
# Number of obs: 8400, groups:  scores.SID, 70
# 
# Fixed effects:
#             Estimate Std. Error z value Pr(>|z|)    
# (Intercept)  0.33662    0.12349   2.726  0.00641 ** 
# condition3  -0.12626    0.05652  -2.234  0.02549 *  
# condition4  -0.31146    0.05632  -5.530  3.2e-08 ***
# gender       0.11145    0.15330   0.727  0.46722    
# iq_z         0.08988    0.09913   0.907  0.36453    
```


########################################################################################
## COMM Puberty effects on GO and STOP DECISIONS while controlling for Sex & IQ ##
########################################################################################
#Go--> no
```{r}

df_pds_all <- df_fMRI_all_TDS2 %>% filter(!is.na(PDS_mean_score))

# Puberty effects on the proportion of Go decisions (by social context)
null.model <- glmer(go ~ condition + gender + iq_z + (1|scores.SID), data=df_pds_all, family='binomial')
main.model <- glmer(go ~ PDS_mean_score + condition + gender + iq_z + (1|scores.SID), data=df_pds_all, family='binomial', control=glmerControl(optimizer="bobyqa"))
interaction.model <- glmer(go ~ PDS_mean_score * condition + gender + iq_z + (1|scores.SID), data=df_pds_all, family='binomial', control=glmerControl(optimizer="bobyqa"))

anova(null.model, main.model)
# null.model: go ~ condition + gender + iq_z + (1 | scores.SID)
# main.model: go ~ PDS_mean_score + condition + gender + iq_z + (1 | scores.SID)
#            Df   AIC   BIC  logLik deviance Chisq Chi Df Pr(>Chisq)
# null.model  6 10483 10525 -5235.3    10471                        
# main.model  7 10484 10533 -5235.1    10470 0.445      1     0.5047
anova(null.model, interaction.model)
# null.model: go ~ condition + gender + iq_z + (1 | scores.SID)
# interaction.model: go ~ PDS_mean_score * condition + gender + iq_z + (1 | scores.SID)
#                   Df   AIC   BIC  logLik deviance  Chisq Chi Df Pr(>Chisq)
# null.model         6 10483 10525 -5235.3    10471                         
# interaction.model  9 10484 10548 -5233.2    10466 4.0586      3     0.2552

summary(null.model)
# Random effects:
#  Groups     Name        Variance Std.Dev.
#  scores.SID (Intercept) 0.3641   0.6034  
# Number of obs: 8160, groups:  scores.SID, 68
# 
# Fixed effects:
#             Estimate Std. Error z value Pr(>|z|)    
# (Intercept) -0.57656    0.12544  -4.596 4.30e-06 ***
# condition3   0.17725    0.05811   3.051  0.00228 ** 
# condition4   0.36678    0.05776   6.350 2.15e-10 ***
# gender      -0.08053    0.15547  -0.518  0.60447    
# iq_z        -0.04812    0.09993  -0.482  0.63015   

```


#Stop--> no
```{r}

# Puberty effects on the proportion of Stop decisions (by social context)
null.model <- glmer(stop ~ condition + gender + iq_z + (1|scores.SID), data=df_pds_all, family='binomial')
main.model <- glmer(stop ~ PDS_mean_score + condition + gender + iq_z + (1|scores.SID), data=df_pds_all, family='binomial', control=glmerControl(optimizer="bobyqa"))
interaction.model <- glmer(stop ~ PDS_mean_score * condition + gender + iq_z + (1|scores.SID), data=df_pds_all, family='binomial', control=glmerControl(optimizer="bobyqa"))

anova(null.model, main.model)
# null.model: stop ~ condition + gender + iq_z + (1 | scores.SID)
# main.model: stop ~ PDS_mean_score + condition + gender + iq_z + (1 | scores.SID)
#            Df   AIC   BIC  logLik deviance  Chisq Chi Df Pr(>Chisq)
# null.model  6 10634 10676 -5311.1    10622                         
# main.model  7 10635 10684 -5310.6    10621 0.9183      1     0.3379

anova(null.model, interaction.model)
# null.model: stop ~ condition + gender + iq_z + (1 | scores.SID)
# interaction.model: stop ~ PDS_mean_score * condition + gender + iq_z + (1 | scores.SID)
#                   Df   AIC   BIC  logLik deviance  Chisq Chi Df Pr(>Chisq)
# null.model         6 10634 10676 -5311.1    10622                         
# interaction.model  9 10637 10700 -5309.4    10619 3.3817      3     0.3364


summary(null.model)
# Random effects:
#  Groups     Name        Variance Std.Dev.
#  scores.SID (Intercept) 0.3606   0.6005  
# Number of obs: 8160, groups:  scores.SID, 68
# 
# Fixed effects:
#             Estimate Std. Error z value Pr(>|z|)    
# (Intercept)  0.37777    0.12446   3.035   0.0024 ** 
# condition3  -0.12526    0.05739  -2.182   0.0291 *  
# condition4  -0.30789    0.05717  -5.386 7.21e-08 ***
# gender       0.05682    0.15456   0.368   0.7132    
# iq_z         0.11088    0.09940   1.115   0.2647  
```





################################################################
## CWI Age effects on GO DECISIONS while controlling for Sex & IQ ##
################################################################
```{r}
# Linear Age effects on the proportion of Go decisions (by location)
null.model <- glmer(go ~ condition + gender + iq_z + (1|scores.SID), data=df_fMRI_all, family='binomial')
main.model <- glmer(go ~ age_c + condition + gender + iq_z + (1|scores.SID), data=df_fMRI_all, family='binomial')
interaction.model <- glmer(go ~ age_c * condition + gender + iq_z + (1|scores.SID), data=df_fMRI_all, family='binomial')

anova(null.model, main.model)
# null.model: go ~ condition + gender + iq_z + (1 | scores.SID)
# main.model: go ~ age_c + condition + gender + iq_z + (1 | scores.SID)
#            Df   AIC   BIC  logLik deviance  Chisq Chi Df Pr(>Chisq)  
# null.model  6 10083 10125 -5035.4    10071                           
# main.model  7 10079 10128 -5032.4    10065 6.1102      1    0.01344 *
anova(null.model, interaction.model)
# null.model: go ~ condition + gender + iq_z + (1 | scores.SID)
# interaction.model: go ~ age_c * condition + gender + iq_z + (1 | scores.SID)
#                   Df   AIC   BIC  logLik deviance  Chisq Chi Df Pr(>Chisq)   
# null.model         6 10083 10125 -5035.4    10071                            
# interaction.model  9 10077 10140 -5029.6    10059 11.751      3   0.008289 **
anova(main.model, interaction.model)
# main.model: go ~ age_c + condition + gender + iq_z + (1 | scores.SID)
# interaction.model: go ~ age_c * condition + gender + iq_z + (1 | scores.SID)
#                   Df   AIC   BIC  logLik deviance  Chisq Chi Df Pr(>Chisq)  
# main.model         7 10079 10128 -5032.4    10065                           
# interaction.model  9 10077 10140 -5029.6    10059 5.6403      2     0.0596 .
summary(interaction.model)
# Random effects:
#  Groups     Name        Variance Std.Dev.
#  scores.SID (Intercept) 0.4308   0.6563  
# Number of obs: 7940, groups:  scores.SID, 67
# 
# Fixed effects:
#                  Estimate Std. Error z value Pr(>|z|)    
# (Intercept)      -0.41415    0.11684  -3.545 0.000393 ***
# age_c             0.08200    0.05422   1.512 0.130432    
# condition3        0.09232    0.05845   1.579 0.114256    
# condition4       -0.01094    0.05949  -0.184 0.854066    
# gender1          -0.34617    0.17249  -2.007 0.044762 *  
# iq_z              0.04957    0.09758   0.508 0.611445    
# age_c:condition3  0.08161    0.03469   2.352 0.018654 *  
# age_c:condition4  0.05113    0.03507   1.458 0.144904    
  
```


#############################################
## CWI FIGURE  Go Decision by Age ##
#############################################
```{r}
#Part A: Go decisions plotted against Age
df_fMRI_all$pred_go <- predict(interaction.model, newdata=df_fMRI_all, re.form=NA, type='response')

fig_4a <- ggplot(data=df_fMRI_all, aes(x=s2_age, y=pred_go, color=condition)) +
  geom_line(aes(group=condition), size=1) +
  labs(x='Age', y='Predicted probability of Go decisions', color='Condition') +
  theme(text = element_text(size=16)) +
  scale_colour_discrete(labels=condition_labels)
ggsave('fig_4a.png', fig_4a)

pGo <- df_fMRI_all %>% group_by(scores.SID, condition) %>% summarize(pGo = mean(go))
pGo_by_age <- merge(pGo, demo, by = 'scores.SID')

ggplot(pGo_by_age, aes(x = s2_age, y = pGo, color=condition), stat_smooth(method = loess)) +
  geom_point() +
  geom_line(aes(group=condition), size=1) +
  #geom_errorbar(aes(ymax=mean + ci, ymin=mean - ci), width=0.5, position=position_dodge(.2)) +
  #facet_grid(.~condition, scales='free', labeller=as_labeller(condition_labels)) +
  labs(x='Age (mean-centered)', y='Proportion of Go decisions', color='Social Context')
```


###########################################################
## CWI Age effects on STOP while controlling for Sex & IQ ##
###########################################################
```{r}
# Age effects on stop decisions by social context
null.model <- glmer(stop ~ condition + gender + iq_z + (1|scores.SID), data=df_fMRI_all, family='binomial')
main.model <- glmer(stop ~ age_c + condition + gender + iq_z + (1|scores.SID), data=df_fMRI_all, family='binomial')
interaction.model <- glmer(stop ~ age_c*condition + gender + iq_z + (1|scores.SID), data=df_fMRI_all, family='binomial')

anova(null.model, main.model)
# null.model: stop ~ condition + gender + iq_z + (1 | scores.SID)
# main.model: stop ~ age_c + condition + gender + iq_z + (1 | scores.SID)
#            Df   AIC   BIC  logLik deviance Chisq Chi Df Pr(>Chisq)  
# null.model  6 10420 10462 -5204.2    10408                          
# main.model  7 10419 10468 -5202.7    10405 2.905      1    0.08831 .
anova(null.model, interaction.model)
# null.model: stop ~ condition + gender + iq_z + (1 | scores.SID)
# interaction.model: stop ~ age_c * condition + gender + iq_z + (1 | scores.SID)
#                   Df   AIC   BIC  logLik deviance  Chisq Chi Df Pr(>Chisq)    
# null.model         6 10420 10462 -5204.2    10408                             
# interaction.model  9 10408 10471 -5195.0    10390 18.371      3  0.0003688 ***
anova(main.model, interaction.model)
# main.model: stop ~ age_c + condition + gender + iq_z + (1 | scores.SID)
# interaction.model: stop ~ age_c * condition + gender + iq_z + (1 | scores.SID)
#                   Df   AIC   BIC  logLik deviance  Chisq Chi Df Pr(>Chisq)    
# main.model         7 10419 10468 -5202.7    10405                             
# interaction.model  9 10408 10471 -5195.0    10390 15.466      2  0.0004382 ***

summary(interaction.model)
# Random effects:
#  Groups     Name        Variance Std.Dev.
#  scores.SID (Intercept) 0.3587   0.599   
# Number of obs: 7940, groups:  scores.SID, 67
# 
# Fixed effects:
#                   Estimate Std. Error z value Pr(>|z|)    
# (Intercept)       0.172907   0.107871   1.603  0.10896    
# age_c            -0.003758   0.049990  -0.075  0.94007    
# condition3        0.018859   0.057192   0.330  0.74159    
# condition4        0.135156   0.058155   2.324  0.02012 *  
# gender1           0.212777   0.157843   1.348  0.17765    
# iq_z             -0.034810   0.089482  -0.389  0.69726    
# age_c:condition3 -0.126301   0.033962  -3.719  0.00020 ***
# age_c:condition4 -0.100865   0.034296  -2.941  0.00327 **    
```


########################################################################################
## CWI Puberty effects on GO and STOP DECISIONS while controlling for Sex & IQ ##
########################################################################################
#Go--> no
```{r}

df_pds_all <- df_fMRI_all %>% filter(!is.na(PDS_mean_score))

# Puberty effects on the proportion of Go decisions (by social context)
null.model <- glmer(go ~ condition + gender + iq_z + (1|scores.SID), data=df_pds_all, family='binomial')
main.model <- glmer(go ~ PDS_mean_score + condition + gender + iq_z + (1|scores.SID), data=df_pds_all, family='binomial', control=glmerControl(optimizer="bobyqa"))
interaction.model <- glmer(go ~ PDS_mean_score * condition + gender + iq_z + (1|scores.SID), data=df_pds_all, family='binomial', control=glmerControl(optimizer="bobyqa"))

anova(null.model, main.model)
#            Df   AIC   BIC  logLik deviance Chisq Chi Df Pr(>Chisq)
# null.model  6 8056.8 8097.2 -4022.4   8044.8                         
# main.model  7 8056.8 8103.9 -4021.4   8042.8 2.0619      1      0.151
anova(main.model, interaction.model)
#                   Df    AIC    BIC  logLik deviance  Chisq Chi Df Pr(>Chisq)
# main.model         7 8056.8 8103.9 -4021.4   8042.8                         
# interaction.model  9 8057.2 8117.8 -4019.6   8039.2 3.5662      2     0.1681


summary(null.model)
# Fixed effects:
#             Estimate Std. Error z value Pr(>|z|)    
# (Intercept) -0.35621    0.12262  -2.905  0.00367 **
# condition3   0.05524    0.06515   0.848  0.39655   
# condition4  -0.01144    0.06601  -0.173  0.86238   
# gender1     -0.16248    0.18389  -0.884  0.37693   
# iq_z         0.12709    0.10543   1.206  0.22802  

```


#Stop-->yes for peer inclusion
```{r}

# Puberty effects on the proportion of Stop decisions (by social context)
null.model <- glmer(stop ~ condition + gender + iq_z + (1|scores.SID), data=df_pds_all, family='binomial')
main.model <- glmer(stop ~ PDS_mean_score + condition + gender + iq_z + (1|scores.SID), data=df_pds_all, family='binomial', control=glmerControl(optimizer="bobyqa"))
interaction.model <- glmer(stop ~ PDS_mean_score * condition + gender + iq_z + (1|scores.SID), data=df_pds_all, family='binomial', control=glmerControl(optimizer="bobyqa"))

anova(null.model, main.model)
# null.model: stop ~ condition + gender + iq_z + (1 | scores.SID)
# main.model: stop ~ PDS_mean_score + condition + gender + iq_z + (1 | scores.SID)
#            Df    AIC    BIC  logLik deviance  Chisq Chi Df Pr(>Chisq)
# null.model  6 8244.2 8284.6 -4116.1   8232.2                         
# main.model  7 8245.9 8293.0 -4116.0   8231.9 0.2837      1     0.5943

anova(null.model, interaction.model)
# Models:
# null.model: stop ~ condition + gender + iq_z + (1 | scores.SID)
# interaction.model: stop ~ PDS_mean_score * condition + gender + iq_z + (1 | scores.SID)
#                   Df    AIC    BIC  logLik deviance  Chisq Chi Df Pr(>Chisq)   
# null.model         6 8244.2 8284.6 -4116.1   8232.2                            
# interaction.model  9 8236.2 8296.7 -4109.1   8218.2 14.069      3   0.002812 **

anova(main.model, interaction.model)
# Models:
# main.model: stop ~ PDS_mean_score + condition + gender + iq_z + (1 | scores.SID)
# interaction.model: stop ~ PDS_mean_score * condition + gender + iq_z + (1 | scores.SID)
#                   Df    AIC    BIC  logLik deviance  Chisq Chi Df Pr(>Chisq)   
# main.model         7 8245.9 8293.0 -4116.0   8231.9                            
# interaction.model  9 8236.2 8296.7 -4109.1   8218.2 13.786      2   0.001015 **
summary(interaction.model)
# Random effects:
#  Groups     Name        Variance Std.Dev.
#  scores.SID (Intercept) 0.3162   0.5624  
# Number of obs: 6180, groups:  scores.SID, 52
# 
# Fixed effects:
#                           Estimate Std. Error z value Pr(>|z|)    
# (Intercept)               -0.25143    0.35534  -0.708 0.479205    
# PDS_mean_score             0.12398    0.13240   0.936 0.349071    
# condition3                 0.77456    0.25240   3.069 0.002150 ** 
# condition4                 0.97616    0.25574   3.817 0.000135 ***
# gender1                    0.13069    0.18020   0.725 0.468300    
# iq_z                      -0.09209    0.09686  -0.951 0.341738    
# PDS_mean_score:condition3 -0.26159    0.08931  -2.929 0.003401 ** 
# PDS_mean_score:condition4 -0.30921    0.09012  -3.431 0.000601 ***
```

#############################################
## FIGURE CWI Stop Decision by Puberty ##
#############################################
```{r}
#Part A: Go decisions plotted against Age
df_pds_all$pred_pub <- predict(interaction.model, newdata=df_pds_all, re.form=NA, type='response')

fig_5a <- ggplot(data=df_pds_all, aes(x=PDS_mean_score, y=pred_pub, color=condition)) +
  geom_line(aes(group=condition), size=1) +
  labs(x='Puberty', y='Predicted probability of Stop decisions', color='Condition') +
  theme(text = element_text(size=16)) +
  scale_colour_discrete(labels=condition_labels)
ggsave('fig_5a.png', fig_5a)


```


#######################################
# Group comparisons -TASK BEHAVIOR
#######################################
#Go
```{r}
# condition effects on the proportion of Go decisions

null.model <- glmer(go ~ (1|scores.SID), data=allTDSfMRI, family='binomial')
condition.model <- glmer(go ~ condition + (1|scores.SID), data=allTDSfMRI, family='binomial')
interaction.model <- glmer(go ~ Group*condition + (1|scores.SID), data= allTDSfMRI, family='binomial', control=glmerControl(optimizer="bobyqa"))
anova(null.model, condition.model)
#                 Df   AIC   BIC logLik deviance  Chisq Chi Df Pr(>Chisq)    
# null.model       2 21122 21138 -10559    21118                             
# condition.model  4 21105 21136 -10548    21097 21.365      2  2.294e-05 ***

anova(condition.model, interaction.model)

#                   Df   AIC   BIC logLik deviance  Chisq Chi Df Pr(>Chisq)    
# condition.model    4 21105 21136 -10548    21097                             
# interaction.model  7 21086 21140 -10536    21072 24.602      3   1.87e-05 ***

summary(interaction.model)
# Fixed effects:
#                  Estimate Std. Error z value Pr(>|z|)    
# (Intercept)      -0.57910    0.20907  -2.770  0.00561 ** 
# Group            -0.02004    0.13184  -0.152  0.87919    
# condition3        0.01529    0.12890   0.119  0.90560    
# condition4       -0.38863    0.13072  -2.973  0.00295 ** 
# Group:condition3  0.07838    0.08129   0.964  0.33496    
# Group:condition4  0.37574    0.08185   4.591 4.42e-06 ***

##interpreting the interaction
#change relevel to 2(alone), 3(peer inclusion), or 4(peer exclusion) to change your reference group for interpretation. 

allTDSfMRI$condition <- relevel(allTDSfMRI$condition, '2')
interaction.model <- glmer(go ~ Group/condition + (1|scores.SID), data= allTDSfMRI, family='binomial', control=glmerControl(optimizer="bobyqa"))

summary(interaction.model)
# Random effects:
#  Groups     Name        Variance Std.Dev.
#  scores.SID (Intercept) 0.4869   0.6978  
# Number of obs: 16580, groups:  scores.SID, 139
# Fixed effects:
#                   Estimate Std. Error z value Pr(>|z|)    
# (Intercept)       -0.25633    0.09239  -2.774 0.005530 ** 
# Group1            -0.35570    0.13208  -2.693 0.007082 ** 
# Group0:condition3 -0.19080    0.05639  -3.384 0.000715 ***
# Group1:condition3  0.10655    0.05865   1.817 0.069253 .  
# Group0:condition2 -0.36285    0.05691  -6.376 1.82e-10 ***
# Group1:condition2  0.01289    0.05888   0.219 0.826720  

```

#Go Crashes
```{r}
# Condition effects on the proportion of Go decisions that resulted in Crashes
null.model <- glmer(go_cr ~ (1|scores.SID), data=allTDSfMRI, family='binomial')
condition.model <- glmer(go_cr ~ condition + (1|scores.SID), data=allTDSfMRI, family='binomial')
interaction.model <- glmer(go_cr ~ Group*condition + (1|scores.SID), data= allTDSfMRI, family='binomial', control=glmerControl(optimizer="bobyqa"))
anova(null.model, condition.model)         
#                 Df   AIC   BIC  logLik deviance  Chisq Chi Df Pr(>Chisq)
# null.model       2 16232 16247 -8114.0    16228                         
# condition.model  4 16233 16264 -8112.5    16225 2.8337      2     0.2425
anova(null.model, interaction.model)  
# Models:
# null.model: go_cr ~ (1 | scores.SID)
# interaction.model: go_cr ~ Group * condition + (1 | scores.SID)
#                   Df   AIC   BIC  logLik deviance  Chisq Chi Df Pr(>Chisq)  
# null.model         2 16232 16247 -8114.0    16228                           
# interaction.model  7 16228 16282 -8107.2    16214 13.614      5    0.01826 *
anova(condition.model, interaction.model)         
#                   Df   AIC   BIC  logLik deviance Chisq Chi Df Pr(>Chisq)  
# condition.model    4 16233 16264 -8112.5    16225                          
# interaction.model  7 16228 16282 -8107.2    16214 10.78      3    0.01297 *

summary(interaction.model) 
# Fixed effects:
#                      Estimate Std. Error z value Pr(>|z|)    
# (Intercept)          -1.50219    0.07732 -19.427  < 2e-16 ***
# GroupTDS2            -0.01655    0.10877  -0.152  0.87908    
# condition3            0.03085    0.06865   0.449  0.65314    
# condition4           -0.06668    0.07037  -0.948  0.34337    
# GroupTDS2:condition3  0.03720    0.09683   0.384  0.70087    
# GroupTDS2:condition4  0.28064    0.09718   2.888  0.00388 ** 

##interpreting the interaction
#change relevel to 2(alone), 3(peer inclusion), or 4(peer exclusion) to change your reference group for interpretation. 

allTDSfMRI$condition <- relevel(allTDSfMRI$condition, '4')
interaction.model <- glmer(go_cr ~ Group/condition + (1|scores.SID), data= allTDSfMRI, family='binomial', control=glmerControl(optimizer="bobyqa"))

summary(interaction.model)
# Random effects:
#  Groups     Name        Variance Std.Dev.
#  scores.SID (Intercept) 0.242    0.4919  
# Number of obs: 16580, groups:  scores.SID, 139
# 
# Fixed effects:
#                   Estimate Std. Error z value Pr(>|z|)    
# (Intercept)       -1.45068    0.07621 -19.036   <2e-16 ***
# Group1            -0.02065    0.10816  -0.191   0.8486    
# Group0:condition2 -0.06805    0.06830  -0.996   0.3190    
# Group1:condition2 -0.03085    0.06867  -0.449   0.6532    
# Group0:condition4  0.14591    0.06634   2.199   0.0279 *  
# Group1:condition4 -0.09753    0.07009  -1.391   0.1641   


# Random effects:
#  Groups     Name        Variance Std.Dev.
#  scores.SID (Intercept) 0.242    0.4919  
# Number of obs: 16580, groups:  scores.SID, 139
# 
# Fixed effects:
#                   Estimate Std. Error z value Pr(>|z|)    
# (Intercept)       -1.30478    0.07499 -17.400  < 2e-16 ***
# Group1            -0.26408    0.10849  -2.434  0.01492 *  
# Group0:condition3 -0.14591    0.06633  -2.200  0.02781 *  
# Group1:condition3  0.09752    0.07008   1.392  0.16405    
# Group0:condition2 -0.21396    0.06701  -3.193  0.00141 ** 
# Group1:condition2  0.06667    0.07038   0.947  0.34345 
#comm sample sig more crashses from alone to peer exclusion and peer exclusion to peer inclusion. No sign diference betwen alone to peer.

```

#Stop
```{r}
## Condition effects on the proportion of Stop decisions
null.model <- glmer(stop ~ (1|scores.SID), data=allTDSfMRI, family='binomial')
condition.model <- glmer(stop ~ condition + (1|scores.SID), data=allTDSfMRI, family='binomial')
interaction.model <- glmer(stop ~ Group*condition + (1|scores.SID), data= allTDSfMRI, family='binomial', control=glmerControl(optimizer="bobyqa"))
anova(condition.model, interaction.model)
#                   Df   AIC   BIC logLik deviance  Chisq Chi Df Pr(>Chisq)    
# condition.model    4 21606 21637 -10799    21598                             
# interaction.model  7 21580 21634 -10783    21566 32.358      3  4.399e-07 ***

anova(null.model, condition.model)
#                 Df   AIC   BIC logLik deviance  Chisq Chi Df Pr(>Chisq)  
# null.model       2 21608 21623 -10802    21604                           
# condition.model  4 21606 21637 -10799    21598 5.5233      2    0.06319 .
anova(null.model, interaction.model)
# Models:
# null.model: stop ~ (1 | scores.SID)
# interaction.model: stop ~ Group * condition + (1 | scores.SID)
#                   Df   AIC   BIC logLik deviance  Chisq Chi Df Pr(>Chisq)    
# null.model         2 21608 21623 -10802    21604                             
# interaction.model  7 21580 21634 -10783    21566 37.881      5  3.986e-07 ***
summary(interaction.model) 
# Fixed effects:
#                  Estimate Std. Error z value Pr(>|z|)    
# (Intercept)       0.15979    0.19723   0.810    0.418    
# Group             0.14089    0.12451   1.132    0.258    
# condition3        0.15529    0.12639   1.229    0.219    
# condition4        0.58188    0.12809   4.543 5.55e-06 ***
# Group:condition3 -0.14087    0.07994  -1.762    0.078 .  
# Group:condition4 -0.44692    0.08051  -5.551 2.84e-08 ***

allTDSfMRI$condition <- relevel(allTDSfMRI$condition, '4')
interaction.model <- glmer(stop~ Group/condition + (1|scores.SID), data= allTDSfMRI, family='binomial', control=glmerControl(optimizer="bobyqa"))

summary(interaction.model)
# Random effects:
#  Groups     Name        Variance Std.Dev.
#  scores.SID (Intercept) 0.427    0.6535  
# Number of obs: 16580, groups:  scores.SID, 139
# 
# Fixed effects:
#                     Estimate Std. Error z value Pr(>|z|)    
# (Intercept)        3.151e-01  8.768e-02   3.594 0.000325 ***
# Group1            -4.498e-05  1.245e-01   0.000 0.999712    
# Group0:condition4 -1.855e-01  5.607e-02  -3.308 0.000938 ***
# Group1:condition4  1.205e-01  5.757e-02   2.094 0.036274 *  
# Group0:condition2  1.265e-01  5.655e-02   2.236 0.025348 *  
# Group1:condition2 -1.442e-02  5.655e-02  -0.255 0.798795 

# Fixed effects:
#                   Estimate Std. Error z value Pr(>|z|)    
# (Intercept)        0.12960    0.08753   1.481 0.138713    
# Group1             0.30603    0.12490   2.450 0.014276 *  
# Group0:condition3  0.18551    0.05607   3.309 0.000938 ***
# Group1:condition3 -0.12055    0.05757  -2.094 0.036275 *  
# Group0:condition2  0.31197    0.05635   5.536  3.1e-08 ***
# Group1:condition2 -0.13496    0.05755  -2.345 0.019032 * 

```

#Stop No Car
```{r}
# Condition effects on the proportion of Stop decisions that were bad
null.model <- glmer(stop_nocar ~ (1|scores.SID), data=allTDSfMRI, family='binomial')
condition.model <- glmer(stop_nocar ~ condition + (1|scores.SID), data=allTDSfMRI, family='binomial')
interaction.model <- glmer(stop_nocar ~ Group*condition + (1|scores.SID), data= allTDSfMRI, family='binomial', control=glmerControl(optimizer="bobyqa"))

anova(condition.model, interaction.model)
#                   Df   AIC   BIC  logLik deviance Chisq Chi Df Pr(>Chisq)  
# condition.model    4 19498 19529 -9745.1    19490                          
# interaction.model  7 19496 19550 -9741.1    19482 7.963      3    0.04678 *
anova(null.model, condition.model)
#                 Df   AIC   BIC  logLik deviance  Chisq Chi Df Pr(>Chisq)  
# null.model       2 19499 19514 -9747.5    19495                           
# condition.model  4 19498 19529 -9745.1    19490 4.8962      2    0.08646 .
anova(null.model, interaction.model)
# Models:
# null.model: stop_nocar ~ (1 | scores.SID)
# interaction.model: stop_nocar ~ Group * condition + (1 | scores.SID)
#                   Df   AIC   BIC  logLik deviance  Chisq Chi Df Pr(>Chisq)  
# null.model         2 19499 19514 -9747.5    19495                           
# interaction.model  7 19496 19550 -9741.1    19482 12.859      5    0.02473 *
summary(interaction.model) 
# Fixed effects:
#                  Estimate Std. Error z value Pr(>|z|)    
# (Intercept)      -1.06957    0.12797  -8.358  < 2e-16 ***
# Group             0.09954    0.08048   1.237  0.21612    
# condition3        0.08065    0.13497   0.598  0.55014    
# condition4        0.26822    0.13604   1.972  0.04865 *  
# Group:condition3 -0.09173    0.08489  -1.081  0.27989    
# Group:condition4 -0.24023    0.08571  -2.803  0.00507 ** 

allTDSfMRI$condition <- relevel(allTDSfMRI$condition, '4')
interaction.model <- glmer(stop_nocar ~ Group/condition + (1|scores.SID), data= allTDSfMRI, family='binomial', control=glmerControl(optimizer="bobyqa"))

summary(interaction.model)
# Fixed effects:
#                    Estimate Std. Error z value Pr(>|z|)    
# (Intercept)       -0.973288   0.057095 -17.047   <2e-16 ***
# Group1            -0.007802   0.081052  -0.096   0.9233    
# Group0:condition4 -0.109426   0.060850  -1.798   0.0721 .  
# Group1:condition4  0.039049   0.061101   0.639   0.5228    
# Group0:condition2  0.102810   0.059491   1.728   0.0840 .  
# Group1:condition2  0.011054   0.060631   0.182   0.8553 

# Random effects:
#  Groups     Name        Variance Std.Dev.
#  scores.SID (Intercept) 0.101    0.3178  
# Number of obs: 16580, groups:  scores.SID, 139
# 
# Fixed effects:
#                   Estimate Std. Error z value Pr(>|z|)    
# (Intercept)       -1.08271    0.05790 -18.699  < 2e-16 ***
# Group1             0.14067    0.08193   1.717 0.086011 .  
# Group0:condition3  0.10943    0.06085   1.798 0.072137 .  
# Group1:condition3 -0.03904    0.06110  -0.639 0.522872    
# Group0:condition2  0.21224    0.06025   3.523 0.000427 ***
# Group1:condition2 -0.02799    0.06103  -0.459 0.646504  

```

#Game Time
```{r}
#game time differences between groups
null.model <- lmer(time ~ (1|scores.SID), data=allTDSfMRI)
condition.model <- lmer(time ~ condition + (1|scores.SID), data=allTDSfMRI)
interaction.model <- lmer(time ~ Group*condition + (1|scores.SID), data= allTDSfMRI)

anova(null.model, condition.model)
# condition.model: time ~ condition + (1 | scores.SID)
#                 Df    AIC    BIC logLik deviance Chisq Chi Df Pr(>Chisq)    
# null.model       3 -19427 -19404 9716.6   -19433                            
# condition.model  5 -19874 -19835 9941.8   -19884 450.5      2  < 2.2e-16 ***

anova(condition.model, interaction.model)
# condition.model: time ~ condition + (1 | scores.SID)
# interaction.model: time ~ Group * condition + (1 | scores.SID)
#                   Df    AIC    BIC logLik deviance  Chisq Chi Df Pr(>Chisq)    
# condition.model    5 -19874 -19835 9941.8   -19884                             
# interaction.model  8 -19896 -19834 9956.0   -19912 28.318      3  3.115e-06 ***

summary(interaction.model)
# Fixed effects:
#                        Estimate Std. Error         df t value Pr(>|t|)    
# (Intercept)           2.369e+00  9.507e-03  1.502e+02 249.144  < 2e-16 ***
# GroupTDS2            -3.909e-02  1.340e-02  1.502e+02  -2.918  0.00407 ** 
# condition3           -4.861e-02  3.518e-03  1.644e+04 -13.817  < 2e-16 ***
# condition4           -6.247e-02  3.565e-03  1.645e+04 -17.522  < 2e-16 ***
# GroupTDS2:condition3  1.623e-02  4.958e-03  1.644e+04   3.273  0.00107 ** 
# GroupTDS2:condition4  2.418e-02  4.991e-03  1.644e+04   4.844 1.28e-06 ***

#interpreting sig interaction
allTDSfMRI$condition <- relevel(allTDSfMRI$condition, '4')
interaction.model <- lmer(time ~ Group/condition + (1|scores.SID), data= allTDSfMRI)
summary(interaction.model)
# Random effects:
#  Groups     Name        Variance Std.Dev.
#  scores.SID (Intercept) 0.00581  0.07622 
#  Residual               0.01708  0.13070 
# Number of obs: 16580, groups:  scores.SID, 139
# 
# Fixed effects:
#                    Estimate Std. Error        df t value Pr(>|t|)    
# (Intercept)       2.291e+00  9.439e-03 1.502e+02 242.746  < 2e-16 ***
# Group1            1.491e-02  1.341e-02 1.508e+02   1.112 0.267917    
# Group0:condition3 5.902e-03  3.493e-03 1.644e+04   1.690 0.091130 .  
# Group1:condition3 1.385e-02  3.565e-03 1.645e+04   3.886 0.000102 ***
# Group0:condition2 3.829e-02  3.493e-03 1.644e+04  10.961  < 2e-16 ***
# Group1:condition2 6.247e-02  3.565e-03 1.645e+04  17.522  < 2e-16 ***

# Fixed effects:
#                     Estimate Std. Error         df t value Pr(>|t|)    
# (Intercept)        2.297e+00  9.439e-03  1.502e+02 243.371  < 2e-16 ***
# Group1             2.286e-02  1.340e-02  1.502e+02   1.707 0.089976 .  
# Group0:condition4 -5.902e-03  3.493e-03  1.644e+04  -1.690 0.091130 .  
# Group1:condition4 -1.385e-02  3.565e-03  1.645e+04  -3.886 0.000102 ***
# Group0:condition2  3.239e-02  3.493e-03  1.644e+04   9.272  < 2e-16 ***
# Group1:condition2  4.861e-02  3.518e-03  1.644e+04  13.817  < 2e-16 ***

#main effect of group on game time, such that COMM group signifcantly lower game time across runs.
#for CWI group, peer exclusion sig different game time than alone or peer inclusion. 
#for COMM group, alone to both social were signficantly different, but not between social conditions.

```

###########################
Simple Slope effects by Group
###########################
#GO by condition--group difference only sig during peer exclusion 
```{r}
# condition effects on the proportion of Go decisions
allTDSfMRI_alone <- allTDSfMRI %>% filter(condition==2)
null.model <- glmer(go ~ (1|scores.SID), data=allTDSfMRI_alone, family='binomial')
condition.model <- glmer(go ~ Group + (1|scores.SID), data=allTDSfMRI_alone, family='binomial')

anova(null.model, condition.model)
# null.model: go ~ (1 | scores.SID)
# condition.model: go ~ Group + (1 | scores.SID)
#                 Df    AIC    BIC  logLik deviance  Chisq Chi Df Pr(>Chisq)
# null.model       2 6965.3 6978.6 -3480.7   6961.3                         
# condition.model  3 6967.2 6987.1 -3480.6   6961.2 0.0995      1     0.7524


allTDSfMRI_PInclusoin <- allTDSfMRI %>% filter(condition==3)
null.model <- glmer(go ~ (1|scores.SID), data=allTDSfMRI_PInclusoin, family='binomial')
condition.model <- glmer(go ~ Group + (1|scores.SID), data=allTDSfMRI_PInclusoin, family='binomial')

anova(null.model, condition.model)
# null.model: go ~ (1 | scores.SID)
# condition.model: go ~ Group + (1 | scores.SID)
#                 Df    AIC    BIC  logLik deviance  Chisq Chi Df Pr(>Chisq)
# null.model       2 7232.7 7246.0 -3614.4   7228.7                         
# condition.model  3 7234.6 7254.5 -3614.3   7228.6 0.0913      1     0.7625


allTDSfMRI_Pexclusoin <- allTDSfMRI %>% filter(condition==4)
null.model <- glmer(go ~ (1|scores.SID), data=allTDSfMRI_Pexclusoin, family='binomial')
condition.model <- glmer(go ~ Group + (1|scores.SID), data=allTDSfMRI_Pexclusoin, family='binomial')

anova(null.model, condition.model)
# condition.model: go ~ Group + (1 | scores.SID)
#                 Df    AIC    BIC  logLik deviance  Chisq Chi Df Pr(>Chisq)   
# null.model       2 7043.7 7056.9 -3519.9   7039.7                            
# condition.model  3 7038.8 7058.6 -3516.4   7032.8 6.9075      1   0.008583 **
summary(condition.model)
# Random effects:
#  Groups     Name        Variance Std.Dev.
#  scores.SID (Intercept) 0.5277   0.7264  
# Number of obs: 5460, groups:  scores.SID, 137
# 
# Fixed effects:
#             Estimate Std. Error z value Pr(>|z|)   
# (Intercept) -0.25343    0.09567  -2.649  0.00807 **
# Group1      -0.36500    0.13774  -2.650  0.00805 **

```

#GO CRASH by condition--group difference only sig during peer exclusion 
```{r}
# condition effects on the proportion of Go decisions
allTDSfMRI_alone <- allTDSfMRI %>% filter(condition==2)
null.model <- glmer(go_cr ~ (1|scores.SID), data=allTDSfMRI_alone, family='binomial')
condition.model <- glmer(go_cr ~ Group + (1|scores.SID), data=allTDSfMRI_alone, family='binomial')

anova(null.model, condition.model)
# null.model: go_cr ~ (1 | scores.SID)
# condition.model: go_cr ~ Group + (1 | scores.SID)
#                 Df    AIC    BIC  logLik deviance  Chisq Chi Df Pr(>Chisq)
# null.model       2 5362.8 5376.0 -2679.4   5358.8                         
# condition.model  3 5364.7 5384.6 -2679.4   5358.7 0.0536      1     0.8169


allTDSfMRI_PInclusoin <- allTDSfMRI %>% filter(condition==3)
null.model <- glmer(go_cr ~ (1|scores.SID), data=allTDSfMRI_PInclusoin, family='binomial')
condition.model <- glmer(go_cr ~ Group + (1|scores.SID), data=allTDSfMRI_PInclusoin, family='binomial')

anova(null.model, condition.model)
# null.model: go_cr ~ (1 | scores.SID)
# condition.model: go_cr ~ Group + (1 | scores.SID)
#                 Df    AIC    BIC  logLik deviance  Chisq Chi Df Pr(>Chisq)
# null.model       2 5524.5 5537.8 -2760.2   5520.5                         
# condition.model  3 5526.5 5546.4 -2760.2   5520.5 0.0249      1     0.8747


allTDSfMRI_Pexclusoin <- allTDSfMRI %>% filter(condition==4)
null.model <- glmer(go_cr ~ (1|scores.SID), data=allTDSfMRI_Pexclusoin, family='binomial')
condition.model <- glmer(go_cr ~ Group + (1|scores.SID), data=allTDSfMRI_Pexclusoin, family='binomial')

anova(null.model, condition.model)
# null.model: go_cr ~ (1 | scores.SID)
# condition.model: go_cr ~ Group + (1 | scores.SID)
#                 Df    AIC    BIC  logLik deviance  Chisq Chi Df Pr(>Chisq)  
# null.model       2 5472.9 5486.1 -2734.4   5468.9                           
# condition.model  3 5469.1 5488.9 -2731.5   5463.1 5.8153      1    0.01589 *
summary(condition.model)
# Random effects:
#  Groups     Name        Variance Std.Dev.
#  scores.SID (Intercept) 0.22     0.469   
# Number of obs: 5460, groups:  scores.SID, 137
# 
# Fixed effects:
#             Estimate Std. Error z value Pr(>|z|)    
# (Intercept) -1.30028    0.07335 -17.726   <2e-16 ***
# Group1      -0.25825    0.10619  -2.432    0.015 *  

```

#STOP by condition--group difference only sig during peer exclusion 
```{r}
# condition effects on the proportion of Go decisions
allTDSfMRI_alone <- allTDSfMRI %>% filter(condition==2)
null.model <- glmer(stop ~ (1|scores.SID), data=allTDSfMRI_alone, family='binomial')
condition.model <- glmer(stop ~ Group + (1|scores.SID), data=allTDSfMRI_alone, family='binomial')

anova(null.model, condition.model)
# null.model: stop ~ (1 | scores.SID)
# condition.model: stop ~ Group + (1 | scores.SID)
#                 Df    AIC    BIC  logLik deviance  Chisq Chi Df Pr(>Chisq)
# null.model       2 7186.1 7199.3 -3591.0   7182.1                         
# condition.model  3 7186.7 7206.6 -3590.4   7180.7 1.3493      1     0.2454


allTDSfMRI_PInclusoin <- allTDSfMRI %>% filter(condition==3)
null.model <- glmer(stop ~ (1|scores.SID), data=allTDSfMRI_PInclusoin, family='binomial')
condition.model <- glmer(stop ~ Group + (1|scores.SID), data=allTDSfMRI_PInclusoin, family='binomial')

anova(null.model, condition.model)
# null.model: stop ~ (1 | scores.SID)
# condition.model: stop ~ Group + (1 | scores.SID)
#                 Df    AIC    BIC  logLik deviance  Chisq Chi Df Pr(>Chisq)
# null.model       2 7360.8 7374.1 -3678.4   7356.8                         
# condition.model  3 7362.8 7382.7 -3678.4   7356.8 0.0111      1     0.9161


allTDSfMRI_Pexclusoin <- allTDSfMRI %>% filter(condition==4)
null.model <- glmer(stop ~ (1|scores.SID), data=allTDSfMRI_Pexclusoin, family='binomial')
condition.model <- glmer(stop ~ Group + (1|scores.SID), data=allTDSfMRI_Pexclusoin, family='binomial')

anova(null.model, condition.model)
# null.model: stop ~ (1 | scores.SID)
# condition.model: stop ~ Group + (1 | scores.SID)
#                 Df    AIC    BIC  logLik deviance  Chisq Chi Df Pr(>Chisq)  
# null.model       2 7131.8 7145.0 -3563.9   7127.8                           
# condition.model  3 7128.3 7148.1 -3561.1   7122.3 5.5037      1    0.01898 *
summary(condition.model)
# Random effects:
#  Groups     Name        Variance Std.Dev.
#  scores.SID (Intercept) 0.5357   0.7319  
# Number of obs: 5460, groups:  scores.SID, 137
# 
# Fixed effects:
#             Estimate Std. Error z value Pr(>|z|)  
# (Intercept)   0.1277     0.0962   1.327   0.1844  
# Group1        0.3263     0.1383   2.359   0.0183 *

```

#BAD STOP by condition--no group diff
```{r}
# condition effects on the proportion of Go decisions
allTDSfMRI_alone <- allTDSfMRI %>% filter(condition==2)
null.model <- glmer(stop_nocar ~ (1|scores.SID), data=allTDSfMRI_alone, family='binomial')
condition.model <- glmer(stop_nocar ~ Group + (1|scores.SID), data=allTDSfMRI_alone, family='binomial')

anova(null.model, condition.model)
# null.model: stop_nocar ~ (1 | scores.SID)
# condition.model: stop_nocar ~ Group + (1 | scores.SID)
#                 Df    AIC    BIC  logLik deviance Chisq Chi Df Pr(>Chisq)
# null.model       2 6674.6 6687.9 -3335.3   6670.6                        
# condition.model  3 6674.9 6694.8 -3334.5   6668.9 1.698      1     0.1925


allTDSfMRI_PInclusoin <- allTDSfMRI %>% filter(condition==3)
null.model <- glmer(stop_nocar ~ (1|scores.SID), data=allTDSfMRI_PInclusoin, family='binomial')
condition.model <- glmer(stop_nocar ~ Group + (1|scores.SID), data=allTDSfMRI_PInclusoin, family='binomial')

anova(null.model, condition.model)
# null.model: stop_nocar ~ (1 | scores.SID)
# condition.model: stop_nocar ~ Group + (1 | scores.SID)
#                 Df    AIC    BIC  logLik deviance  Chisq Chi Df Pr(>Chisq)
# null.model       2 6560.4 6573.6 -3278.2   6556.4                         
# condition.model  3 6562.4 6582.2 -3278.2   6556.4 0.0097      1     0.9214


allTDSfMRI_Pexclusoin <- allTDSfMRI %>% filter(condition==4)
null.model <- glmer(stop_nocar ~ (1|scores.SID), data=allTDSfMRI_Pexclusoin, family='binomial')
condition.model <- glmer(stop_nocar ~ Group + (1|scores.SID), data=allTDSfMRI_Pexclusoin, family='binomial')

anova(null.model, condition.model)
# null.model: stop_nocar ~ (1 | scores.SID)
# condition.model: stop_nocar ~ Group + (1 | scores.SID)
#                 Df    AIC    BIC  logLik deviance  Chisq Chi Df Pr(>Chisq)  
# null.model       2 6363.0 6376.2 -3179.5   6359.0                           
# condition.model  3 6361.7 6381.5 -3177.8   6355.7 3.3032      1    0.06915 .

```

#TIME by condition--no group diff
```{r}
# condition effects on the proportion of Go decisions
allTDSfMRI_alone <- allTDSfMRI %>% filter(condition==2)
null.model <- lmer(time ~ (1|scores.SID), data=allTDSfMRI_alone)
condition.model <- lmer(time ~ Group + (1|scores.SID), data=allTDSfMRI_alone)

anova(null.model, condition.model)
# null.model: time ~ (1 | scores.SID)
# condition.model: time ~ Group + (1 | scores.SID)
#                 Df     AIC     BIC logLik deviance  Chisq Chi Df Pr(>Chisq)  
# null.model       3 -8145.4 -8125.5 4075.7  -8151.4                           
# condition.model  4 -8146.6 -8120.1 4077.3  -8154.6 3.2364      1    0.07202 .

allTDSfMRI_PInclusoin <- allTDSfMRI %>% filter(condition==3)
null.model <- lmer(time ~ (1|scores.SID), data=allTDSfMRI_PInclusoin)
condition.model <- lmer(time ~ Group + (1|scores.SID), data=allTDSfMRI_PInclusoin)

anova(null.model, condition.model)
# null.model: time ~ (1 | scores.SID)
# condition.model: time ~ Group + (1 | scores.SID)
#                 Df     AIC     BIC logLik deviance  Chisq Chi Df Pr(>Chisq)
# null.model       3 -9341.2 -9321.3 4673.6  -9347.2                         
# condition.model  4 -9341.1 -9314.6 4674.6  -9349.1 1.9392      1     0.1638


allTDSfMRI_Pexclusoin <- allTDSfMRI %>% filter(condition==4)
null.model <- lmer(time ~ (1|scores.SID), data=allTDSfMRI_Pexclusoin)
condition.model <- lmer(time ~ Group + (1|scores.SID), data=allTDSfMRI_Pexclusoin)

anova(null.model, condition.model)
# null.model: time ~ (1 | scores.SID)
# condition.model: time ~ Group + (1 | scores.SID)
#                 Df     AIC     BIC logLik deviance  Chisq Chi Df Pr(>Chisq)
# null.model       3 -9420.8 -9401.0 4713.4  -9426.8                         
# condition.model  4 -9419.8 -9393.4 4713.9  -9427.8 1.0027      1     0.3166

```


#######################
###GROUP TASK FIGURE###
#######################
#go
```{r}
short_allTDSfMRI <- allTDSfMRI %>%
  group_by(scores.SID, Group, condition) %>%
  summarise_at(vars(go, stop, go_cr, stop_nocar, time), funs(mean, sd, std.error), na.rm=TRUE) 

short_allTDSfMRI$condition <- relevel(short_allTDSfMRI$condition, '2')

gd <- short_allTDSfMRI %>% 
        group_by(Group, condition) %>% 
        summarise(
          go_mean = mean(go_mean),
          stop_mean = mean(stop_mean),
          time_mean = mean(time_mean),
          go_std.error = mean(go_std.error)
        ) 

Fig_Group_Go <- ggplot(short_allTDSfMRI, aes(x= condition, y=go_mean, color =factor(Group, labels=c("Comm", "CWI")))) +
  geom_line(aes(group = scores.SID), alpha = .3) +
  geom_line(data = gd, aes(group = Group), alpha = .8, size = 2) +
  theme_bw() +
  labs(
    title = "Changes in Go Decisions by Group",
    x = "Social Context",
    y = "Percent Go Decisions",
    color = "Group") 

Fig_Group_Go +
  scale_x_discrete(breaks=c("2", "3", "4"),
                      labels=c("Alone", "Peer Inclusion", "Peer Exclusion")) 
   
```

#stop
```{r}

Fig_Group_Stop <- ggplot(short_allTDSfMRI, aes(x= condition, y=stop_mean, color =factor(Group, labels=c("Comm", "CWI")))) +
  geom_line(aes(group = scores.SID), alpha = .3) +
  geom_line(data = gd, aes(group = Group), alpha = .8, size = 2) +
  theme_bw() +
  labs(
    title = "Changes in Stop Decisions by Group",
    x = "Social Context",
    y = "Percent Stop Decisions",
    color = "Group") 

Fig_Group_Stop +
  scale_x_discrete(breaks=c("2", "3", "4"),
                      labels=c("Alone", "Peer Inclusion", "Peer Exclusion")) 
   
```

#game time
```{r}

Fig_Group_Time <- ggplot(short_allTDSfMRI, aes(x= condition, y=time_mean, color =factor(Group, labels=c("Comm", "CWI")))) +
  geom_line(aes(group = scores.SID), alpha = .3) +
  geom_line(data = gd, aes(group = Group), alpha = .8, size = 1.5) +
  theme_bw() +
  labs(
    title = "Changes in Game Time Decisions by Group",
    x = "Social Context",
    y = "Game Time",
    color = "Group") 

Fig_Group_Time +
  scale_x_discrete(breaks=c("2", "3", "4"),
                      labels=c("Alone", "Peer Inclusion", "Peer Exclusion")) 
   
```


####################################################################################
Supplemental Button press penalties 
####################################################################################
##COMM
```{r}

null.model <- glmer(penalty ~ (1|scores.SID), data=df_fMRI_all_TDS2, family='binomial')
run.model <- glmer(penalty ~ run_index + (1|scores.SID), data=df_fMRI_all_TDS2, family='binomial')
anova(null.model, run.model)

#            Df    AIC    BIC  logLik deviance  Chisq Chi Df Pr(>Chisq)
# null.model  2 2250.5 2264.6 -1123.2   2246.5                         
# run.model   7 2254.3 2303.6 -1120.2   2240.3 6.2028      5      0.287

summary(null.model)
# Fixed effects:
#             Estimate Std. Error z value Pr(>|z|)    
# (Intercept)  -3.7596     0.1327  -28.34   <2e-16 ***

null.model <- glmer(penalty ~ (1|scores.SID), data=df_fMRI_all_TDS2, family='binomial')
condition.model <- glmer(penalty ~ condition + (1|scores.SID), data=df_fMRI_all_TDS2, family='binomial')

anova(null.model, condition.model)

#                 Df    AIC    BIC  logLik deviance  Chisq Chi Df Pr(>Chisq)  
# null.model       2 2250.5 2264.6 -1123.2   2246.5                           
# condition.model  4 2248.7 2276.9 -1120.4   2240.7 5.7572      2    0.05621 .

summary(null.model)

# Fixed effects:
#             Estimate Std. Error z value Pr(>|z|)    
# (Intercept)  -3.7596     0.1327  -28.34   <2e-16 ***


social_TDS2<-df_TDS2 %>% filter(condition != "2")

null.model <- glmer(penalty ~ (1|scores.SID), data=social_TDS2, family='binomial')
condition.model <- glmer(penalty ~ condition + (1|scores.SID), data=social_TDS2, family='binomial')

anova(null.model, condition.model)  
#                 Df    AIC    BIC  logLik deviance  Chisq Chi Df Pr(>Chisq)    
# null.model       2 2842.3 2856.4 -1419.2   2838.3                             
# condition.model  4 2757.5 2785.6 -1374.8   2749.5 88.832      2  < 2.2e-16 ***

summary(condition.model)

# Fixed effects:
#             Estimate Std. Error z value Pr(>|z|)    
# (Intercept)  -2.8490     0.1368 -20.820  < 2e-16 ***
# condition3   -1.0327     0.1347  -7.669 1.73e-14 ***
# condition4   -1.0596     0.1358  -7.802 6.11e-15 ***

```


##CWI
```{r}
# condition effects on the proportion of penalties

null.model <- glmer(penalty ~ (1|scores.SID), data=df_all, family='binomial')
condition.model <- glmer(penalty ~ condition + (1|scores.SID), data=df_all, family='binomial')
anova(null.model, condition.model)
#                 Df    AIC    BIC  logLik deviance Chisq Chi Df Pr(>Chisq)    
# null.model       2 4688.1 4702.6 -2342.0   4684.1                            
# condition.model  5 4563.6 4600.0 -2276.8   4553.6 130.5      3  < 2.2e-16 ***

summary(condition.model)
# Fixed effects:
#             Estimate Std. Error z value Pr(>|z|)    
# (Intercept)  -2.3838     0.1163 -20.493  < 2e-16 ***
# condition2   -0.5599     0.1031  -5.430 5.62e-08 ***
# condition3   -1.0692     0.1184  -9.029  < 2e-16 ***
# condition4   -1.1798     0.1243  -9.490  < 2e-16 ***

###################

null.model <- glmer(penalty ~ (1|scores.SID), data=social_df, family='binomial')
condition.model <- glmer(penalty ~ condition + (1|scores.SID), data=social_df, family='binomial')
anova(null.model, condition.model)  
#                 Df    AIC    BIC  logLik deviance  Chisq Chi Df Pr(>Chisq)
# null.model       2 1697.9 1711.1 -846.97   1693.9                         
# condition.model  3 1699.4 1719.2 -846.72   1693.4 0.5028      1     0.4783

summary(null.model) 
# Fixed effects:
#             Estimate Std. Error z value Pr(>|z|)    
# (Intercept)  -3.4562     0.1205  -28.68   <2e-16 ***


```


##COMM v CWI
```{r}
# condition effects on the proportion of penalties

null.model <- glmer(penalty ~ (1|scores.SID), data=allTDSfMRI, family='binomial')
condition.model <- glmer(penalty ~ condition + (1|scores.SID), data=allTDSfMRI, family='binomial')
interaction.model <- glmer(penalty ~ Group*condition + (1|scores.SID), data= allTDSfMRI, family='binomial', control=glmerControl(optimizer="bobyqa"))
anova(condition.model, interaction.model)

#                   Df    AIC    BIC  logLik deviance  Chisq Chi Df Pr(>Chisq)  
# condition.model    4 5190.0 5220.8 -2591.0   5182.0                           
# interaction.model  7 5186.2 5240.2 -2586.1   5172.2 9.7721      3    0.02061 *

anova(null.model, condition.model)
#                 Df    AIC    BIC  logLik deviance  Chisq Chi Df Pr(>Chisq)    
# null.model       2 5216.7 5232.2 -2606.4   5212.7                             
# condition.model  4 5190.0 5220.8 -2591.0   5182.0 30.762      2   2.09e-07 ***

summary(interaction.model)
# Fixed effects:
#                  Estimate Std. Error z value Pr(>|z|)    
# (Intercept)       -2.3532     0.2865  -8.215  < 2e-16 ***
# Group             -0.5892     0.1875  -3.143  0.00167 ** 
# condition3        -0.7180     0.2901  -2.475  0.01333 *  
# condition4        -0.9178     0.3005  -3.055  0.00225 ** 
# Group:condition3   0.2088     0.1941   1.075  0.28220    
# Group:condition4   0.2953     0.1987   1.486  0.13722


social_df_TDSall <- allTDSfMRI %>% filter(condition != "2")

null.model <- glmer(penalty ~ (1|scores.SID), data=social_df_TDSall, family='binomial')
condition.model <- glmer(penalty ~ condition + (1|scores.SID), data=social_df_TDSall, family='binomial')
interaction.model <- glmer(penalty ~ Group*condition + (1|scores.SID), data= social_df_TDSall, family='binomial', control=glmerControl(optimizer="bobyqa"))
anova(condition.model, interaction.model)  
#                   Df    AIC    BIC  logLik deviance  Chisq Chi Df Pr(>Chisq)
# condition.model    3 3067.0 3088.9 -1530.5   3061.0                         
# interaction.model  5 3066.6 3103.1 -1528.3   3056.6 4.4749      2     0.1067

anova(null.model, condition.model)  
#                 Df    AIC    BIC  logLik deviance  Chisq Chi Df Pr(>Chisq)
# null.model       2 3065.4 3080.1 -1530.7   3061.4                         
# condition.model  3 3067.0 3088.9 -1530.5   3061.0 0.4146      1     0.5196

summary(null.model) 
# Fixed effects:
#             Estimate Std. Error z value Pr(>|z|)    
# (Intercept)  -3.7184     0.1055  -35.23   <2e-16 ***



```


##Figure Penalties by Group by Condition
```{r}
short_allTDSfMRI <- allTDSfMRI %>%
  group_by(scores.SID, Group, condition) %>%
  summarise_at(vars(go, stop, go_cr, stop_nocar, time, penalty), funs(mean, sd, std.error), na.rm=TRUE) 

short_allTDSfMRI$condition <- relevel(short_allTDSfMRI$condition, '2')

gd_penality <- short_allTDSfMRI %>% 
        group_by(Group, condition) %>% 
        summarise(
          penalty_mean = mean(penalty_mean)
        ) 

Fig_Group_Penalty <- ggplot(short_allTDSfMRI, aes(x= condition, y=penalty_mean, color =factor(Group, labels=c("Comm", "CWI")))) +
  geom_line(aes(group = scores.SID), alpha = .3) +
  geom_line(data = gd_penality, aes(group = Group), alpha = .8, size = 2) +
  theme_bw() +
  labs(
    title = "Changes in Penalties Decisions by Group",
    x = "Social Context",
    y = "Percent Penalty",
    color = "Group") 

Fig_Group_Penalty +
  scale_x_discrete(breaks=c("2", "3", "4"),
                      labels=c("Alone", "Peer Inclusion", "Peer Exclusion")) 
   
```



##############################################################################################
DEVELOPMENTAL GROUP DIFFERENCES
##############################################################################################


########################################################################
## GROUP Age effects on GO DECISIONS while controlling for Sex & IQ ##
########################################################################
```{r}

allTDSfMRI$condition <- relevel(allTDSfMRI$condition, '2')
# Linear Age effects on the proportion of Go decisions (by location)
null.model <- glmer(go ~ condition*Group + gender + iq_z + (1|scores.SID), data=allTDSfMRI, family='binomial', control=glmerControl(optimizer="bobyqa"))
main.model <- glmer(go ~  condition*Group + age_c + gender + iq_z + (1|scores.SID), data=allTDSfMRI, family='binomial', control=glmerControl(optimizer="bobyqa"))
group.model <- glmer(go ~ age_c* condition * Group + gender + iq_z + (1|scores.SID), data=allTDSfMRI, family='binomial', control=glmerControl(optimizer="bobyqa"))

anova(null.model, main.model)
# null.model: go ~ condition * Group + gender + iq_z + (1 | scores.SID)
# main.model: go ~ condition * Group + age_c + gender + iq_z + (1 | scores.SID)
#            Df   AIC   BIC logLik deviance  Chisq Chi Df Pr(>Chisq)  
# null.model  9 20893 20962 -10437    20875                           
# main.model 10 20891 20968 -10435    20871 3.9856      1    0.04589 *
anova(null.model, group.model)
# null.model: go ~ condition * Group + gender + iq_z + (1 | scores.SID)
# group.model: go ~ age_c * condition * Group + gender + iq_z + (1 | scores.SID)
#             Df   AIC   BIC logLik deviance  Chisq Chi Df Pr(>Chisq)   
# null.model   9 20893 20962 -10437    20875                            
# group.model 15 20888 21003 -10429    20858 16.936      6    0.00952 **
anova(main.model, group.model)
# main.model: go ~ condition * Group + age_c + gender + iq_z + (1 | scores.SID)
# group.model: go ~ age_c * condition * Group + gender + iq_z + (1 | scores.SID)
#             Df   AIC   BIC logLik deviance  Chisq Chi Df Pr(>Chisq)  
# main.model  10 20891 20968 -10435    20871                           
# group.model 15 20888 21003 -10429    20858 12.951      5    0.02384 *
summary(group.model)
# Random effects:
#  Groups     Name        Variance Std.Dev.
#  scores.SID (Intercept) 0.4009   0.6332  
# Number of obs: 16340, groups:  scores.SID, 137
# 
# Fixed effects:
#                         Estimate Std. Error z value Pr(>|z|)    
# (Intercept)             -0.50296    0.11003  -4.571 4.85e-06 ***
# age_c                    0.05536    0.05660   0.978  0.32796    
# condition3               0.17518    0.05725   3.060  0.00222 ** 
# condition4               0.36412    0.05693   6.396 1.59e-10 ***
# Group1                   0.04311    0.12855   0.335  0.73735    
# gender1                 -0.23690    0.11527  -2.055  0.03986 *  
# iq_z                     0.01692    0.06958   0.243  0.80792    
# age_c:condition3        -0.08415    0.03732  -2.255  0.02414 *  
# age_c:condition4        -0.03569    0.03699  -0.965  0.33470    
# age_c:Group1             0.02043    0.07691   0.266  0.79050    
# condition3:Group1       -0.08294    0.08179  -1.014  0.31059    
# condition4:Group1       -0.37509    0.08231  -4.557 5.19e-06 ***
# age_c:condition3:Group1  0.16567    0.05094   3.252  0.00115 ** 
# age_c:condition4:Group1  0.08674    0.05096   1.702  0.08871 .  

#interpreting interaction 
allTDSfMRI$condition <- relevel(allTDSfMRI$condition, '2')
group.model <- glmer(go ~ age_c/condition/Group + gender + iq_z + (1|scores.SID), data=allTDSfMRI, family='binomial', control=glmerControl(optimizer="bobyqa"))
summary(group.model)
# Random effects:
#  Groups     Name        Variance Std.Dev.
#  scores.SID (Intercept) 0.4011   0.6333  
# Number of obs: 16340, groups:  scores.SID, 137
# 
# Fixed effects:
#                         Estimate Std. Error z value Pr(>|z|)    
# (Intercept)             -0.38420    0.07991  -4.808 1.52e-06 ***
# age_c                    0.02360    0.05637   0.419   0.6754    
# gender1                 -0.22804    0.11491  -1.985   0.0472 *  
# iq_z                     0.03614    0.06651   0.543   0.5869    
# age_c:condition2         0.02805    0.03684   0.761   0.4464    
# age_c:condition3        -0.05162    0.03697  -1.396   0.1626    
# age_c:condition4:Group1  0.10184    0.07682   1.326   0.1850    
# age_c:condition2:Group1  0.02278    0.07668   0.297   0.7664    
# age_c:condition3:Group1  0.18674    0.07678   2.432   0.0150 * 

```


#################################################################
## GROUP Age effects on CRASHES while controlling for Sex & IQ ##
#################################################################
```{r}

# Age effects on the proportion of Go decisions that resulted in Crashes (by location)
null.model <- glmer(go_cr ~ condition*Group + gender + iq_z + (1|scores.SID), data=allTDSfMRI, family='binomial', control=glmerControl(optimizer="bobyqa"))
main.model <- glmer(go_cr ~ condition*Group + age_c + gender + iq_z + (1|scores.SID), data=allTDSfMRI, family='binomial', control=glmerControl(optimizer="bobyqa"))
group.model <- glmer(go_cr ~ age_c*condition*Group + gender + iq_z + (1|scores.SID), data=allTDSfMRI, family='binomial', control=glmerControl(optimizer="bobyqa"))

anova(null.model, main.model)
# null.model: go_cr ~ condition * Group + gender + iq_z + (1 | scores.SID)
# main.model: go_cr ~ condition * Group + age_c + gender + iq_z + (1 | scores.SID)
#            Df   AIC   BIC  logLik deviance  Chisq Chi Df Pr(>Chisq)
# null.model  9 16076 16145 -8028.8    16058                         
# main.model 10 16075 16152 -8027.5    16055 2.5365      1     0.1112

anova(null.model, group.model)
# null.model: go_cr ~ condition * Group + gender + iq_z + (1 | scores.SID)
# group.model: go_cr ~ age_c * condition * Group + gender + iq_z + (1 | scores.SID)
#             Df   AIC   BIC  logLik deviance  Chisq Chi Df Pr(>Chisq)
# null.model   9 16076 16145 -8028.8    16058                         
# group.model 15 16081 16196 -8025.3    16051 6.8675      6     0.3333
summary(null.model)
# Random effects:
#  Groups     Name        Variance Std.Dev.
#  scores.SID (Intercept) 0.21     0.4583  
# Number of obs: 16340, groups:  scores.SID, 137
# 
# Fixed effects:
#                   Estimate Std. Error z value Pr(>|z|)    
# (Intercept)       -1.45632    0.09080 -16.039  < 2e-16 ***
# condition4         0.21371    0.06699   3.190  0.00142 ** 
# condition3         0.06798    0.06826   0.996  0.31932    
# Group1             0.03217    0.10890   0.295  0.76768    
# gender1           -0.13473    0.08891  -1.515  0.12968    
# iq_z               0.02464    0.05434   0.453  0.65020    
# condition4:Group1 -0.26568    0.09763  -2.721  0.00650 ** 
# condition3:Group1 -0.03166    0.09732  -0.325  0.74494   
```


##########################################################################
## GROUP Puberty effects on GO DECISIONS while controlling for Sex & IQ ##
##########################################################################
```{r}
df_pds_allTDS <- allTDSfMRI %>% filter(!is.na(PDS_mean_score))

df_pds_allTDS$condition <- relevel(df_pds_allTDS$condition, '2')
# Puberty effects on the proportion of Go decisions (by social context)
null.model <- glmer(go ~ condition*Group + gender +  (1|scores.SID), data=df_pds_allTDS, family='binomial', control=glmerControl(optimizer="bobyqa"))
main.model <- glmer(go ~ condition*Group + PDS_mean_score + gender +  (1|scores.SID), data=df_pds_allTDS, family='binomial', control=glmerControl(optimizer="bobyqa"))
group.model <- glmer(go ~ PDS_mean_score*condition*Group + gender + (1|scores.SID), data=df_pds_allTDS, family='binomial', control=glmerControl(optimizer="bobyqa"))

anova(null.model, main.model)
# null.model: go ~ condition * Group + gender + (1 | scores.SID)
# main.model: go ~ condition * Group + PDS_mean_score + gender + (1 | scores.SID)
#            Df   AIC   BIC  logLik deviance  Chisq Chi Df Pr(>Chisq)
# null.model  8 18562 18623 -9273.2    18546                         
# main.model  9 18564 18632 -9273.1    18546 0.0717      1     0.7889

anova(null.model, group.model)
# null.model: go ~ condition * Group + gender + (1 | scores.SID)
# group.model: go ~ PDS_mean_score * condition * Group + gender + (1 | scores.SID)
#             Df   AIC   BIC  logLik deviance  Chisq Chi Df Pr(>Chisq)
# null.model   8 18562 18623 -9273.2    18546                         
# group.model 14 18566 18672 -9268.9    18538 8.4881      6     0.2045

summary(null.model)

# Random effects:
#  Groups     Name        Variance Std.Dev.
#  scores.SID (Intercept) 0.4527   0.6728  
# Number of obs: 14460, groups:  scores.SID, 121
# 
# Fixed effects:
#                   Estimate Std. Error z value Pr(>|z|)    
# (Intercept)       -0.59969    0.11550  -5.192 2.08e-07 ***
# condition4         0.36776    0.05782   6.360 2.01e-10 ***
# condition3         0.17772    0.05817   3.055  0.00225 ** 
# Group1             0.14271    0.13971   1.021  0.30704    
# gender1           -0.08569    0.12913  -0.664  0.50696    
# condition4:Group1 -0.37904    0.08770  -4.322 1.55e-05 ***
# condition3:Group1 -0.12258    0.08729  -1.404  0.16024  
```

#####################################################################
## GROUP Puberty effects on CRASHES while controlling for Sex & IQ ##
#####################################################################
```{r}
# Puberty effects on the proportion of Go decisions that resulted in Crashes (by social context)
null.model <- glmer(go_cr ~ condition*Group + gender + iq_z + (1|scores.SID), data=df_pds_allTDS, family='binomial', control=glmerControl(optimizer="bobyqa"))
main.model <- glmer(go_cr ~ PDS_mean_score + condition*Group + gender + iq_z + (1|scores.SID), data=df_pds_allTDS, family='binomial', control=glmerControl(optimizer="bobyqa"))
group.model <- glmer(go_cr ~ PDS_mean_score * condition * Group + gender + iq_z + (1|scores.SID), data=df_pds_allTDS, family='binomial', control=glmerControl(optimizer="bobyqa"))

anova(null.model, main.model)
# null.model: go_cr ~ condition * Group + gender + iq_z + (1 | scores.SID)
# main.model: go_cr ~ PDS_mean_score + condition * Group + gender + iq_z + 
# main.model:     (1 | scores.SID)
#            Df   AIC   BIC  logLik deviance  Chisq Chi Df Pr(>Chisq)
# null.model  9 14261 14329 -7121.3    14243                         
# main.model 10 14263 14338 -7121.3    14243 0.1355      1     0.7128
anova(null.model, group.model)
# null.model: go_cr ~ condition * Group + gender + iq_z + (1 | scores.SID)
# group.model: go_cr ~ PDS_mean_score * condition * Group + gender + iq_z + 
# group.model:     (1 | scores.SID)
#             Df   AIC   BIC  logLik deviance  Chisq Chi Df Pr(>Chisq)
# null.model   9 14261 14329 -7121.3    14243                         
# group.model 15 14270 14384 -7120.0    14240 2.6475      6     0.8516

```




#####################################################
ROIs SETUP--> don't rerun, use output
#####################################################
```{r}
setwd("~/Desktop/extracted_parameters/ANAT")
file_list <- list.files()
# file_list <- file_list[file_list != "func"]
file_list
for (file in file_list) {

  # if the merged dataset doesn't exist, create it
  if (!exists("dataset_nacc")) {
    dataset_nacc <- read.table(file, header = FALSE, sep = "\t")
  }

  # if the merged dataset does exist, append to it
  if (exists("dataset_nacc")) {
    temp_dataset <- read.table(file, header = FALSE, sep = "\t")
    dataset_nacc <- rbind(dataset_nacc, temp_dataset)
    rm(temp_dataset)
  }
}

dataset_clean_TDS1TDS2_NaccROI <- dataset_nacc %>%
  separate(col = V1, into = c("ID", "con_num", "ROI_name", "ROI_mean", "ROI_SD"), sep = " ")

dataset_clean_TDS1TDS2_NaccROI <- na.omit(dataset_clean_TDS1TDS2_NaccROI)


#D_A=con1
#DG_A=con2
#DS_A=con3
#D_P=con11
#DG_P=con12
#DS_P=con13
#D_S=con21
#DG_S=con22
#DS_S=con23
#filter to just have decision cons
Decisions_TDS1TDS2_NaccROI <- dataset_clean_TDS1TDS2_NaccROI %>%
  filter(con_num == "con_0001.nii" | con_num == "con_0002.nii" | 
        con_num == "con_0003.nii" | con_num == "con_0011.nii" | con_num == "con_0012.nii" | 
        con_num == "con_0013.nii" | con_num == "con_0021.nii" | con_num == "con_0022.nii" | con_num == "con_0023.nii")

Decisions_TDS1TDS2_NaccROI <- as_tibble(Decisions_TDS1TDS2_NaccROI)
#remove duplicates
Decisions_TDS1TDS2_NaccROI_clean <- unique(Decisions_TDS1TDS2_NaccROI)


setwd("~/Desktop/extracted_parameters/FUNC/")
file_list_func <- list.files()
file_list_func
for (file in file_list_func) {

  # if the merged dataset doesn't exist, create it
  if (!exists("dataset_func")) {
    dataset_func <- read.table(file, header = FALSE, sep = "\t")
  }

  # if the merged dataset does exist, append to it
  if (exists("dataset_func")) {
    temp_dataset <- read.table(file, header = FALSE, sep = "\t")
    dataset_func <- rbind(dataset_func, temp_dataset)
    rm(temp_dataset)
  }
}

dataset_clean_TDS1TDS2_funcROI <- dataset_func %>%
  separate(col = V1, into = c("ID", "con_num", "ROI_name", "ROI_mean", "ROI_SD"), sep = " ")


dataset_clean_TDS1TDS2_funcROI <- na.omit(dataset_clean_TDS1TDS2_funcROI)


#D_A=con1
#DG_A=con2
#DS_A=con3
#D_P=con11
#DG_P=con12
#DS_P=con13
#D_S=con21
#DG_S=con22
#DS_S=con23
#filter to just have decision cons
Decisions_TDS1TDS2_funcROI <- dataset_clean_TDS1TDS2_funcROI %>%
  filter(con_num == "con_0001.nii" | con_num == "con_0002.nii" | 
           con_num == "con_0003.nii" | con_num == "con_0011.nii" | con_num == "con_0012.nii" | 
           con_num == "con_0013.nii" | con_num == "con_0021.nii" |  con_num == "con_0022.nii" | con_num == "con_0023.nii")

Decisions_TDS1TDS2_funcROI <- as_tibble(Decisions_TDS1TDS2_funcROI)
#remove duplicates
Decisions_TDS1TDS2_funcROI_clean <- unique(Decisions_TDS1TDS2_funcROI)


#####

all_rois <- rbind(Decisions_TDS1TDS2_NaccROI_clean, Decisions_TDS1TDS2_funcROI_clean, by = "ID")
#removes last odd row of "ID"
all_rois <- all_rois[1:(nrow(all_rois)-1),]

all_rois <- as_tibble(all_rois)
all_rois$ROI_mean <- as.numeric(all_rois$ROI_mean)
all_rois$ROI_SD <- as.numeric(all_rois$ROI_SD)
all_rois_group <- all_rois %>% 
  mutate( Group = ifelse(ID < 300, "0", "1"))

all_rois_group  <- mutate(all_rois_group, Decision  = derivedFactor(
  "Decision" = con_num %in% c("con_0001.nii", "con_0011.nii", "con_0021.nii"),
  "Decision_Go" = con_num %in% c("con_0002.nii", "con_0012.nii", "con_0022.nii"),
  "Decision_Stop" = con_num %in% c("con_0003.nii", "con_0013.nii", "con_0023.nii"),
  .default = NA
))
write.csv(all_rois_group, "all_rois_group.csv")

```

#read in made file
```{r}
all_rois_group <- fread("all_rois_group.csv")

```


#####################################################
###Graphing ROIS
#####################################################

#dACC --CONTEXTxGROUPxBEHAV
```{r}

dACC_contextXGroupXPerGo <-all_rois_group %>%
  filter(ROI_name=="dACC_contextXGroupXPerGo_mask_0003", Decision != "Decision") %>%
  group_by(Group, con_num, Decision, context) %>%
  summarise_at(vars(ROI_mean), funs(mean, std.error), na.rm=TRUE) 

  
#looking difference stop and go
  diff_dACC_contextXGroupXPerGo <- dACC_contextXGroupXPerGo[,-c(2,6)] %>%
    unite(Decision_context, context, Decision) %>%
    spread(Decision_context, mean) 
  
  dACC_diff_go_stop <- diff_dACC_contextXGroupXPerGo %>%
    group_by(Group) %>%
    mutate(Alonediff = Alone_Decision_Go- Alone_Decision_Stop, Peerdiff =Peer_Decision_Go- Peer_Decision_Stop, Excldiff = Exclusion_Decision_Go-Exclusion_Decision_Stop)
  
  dACC_diff_go_stop_wide <- dACC_diff_go_stop %>%
    gather(key = "Decision", value = "mean_dACC", Alone_Decision_Go:Excldiff)
  
  dACC_diff_go_stop_wide_1 <- dACC_diff_go_stop_wide %>%
    filter(Decision == "Alonediff"| Decision == "Peerdiff"| Decision == "Excldiff") 
  
  # x <- c("Alone", "Alone", "Peer", "Peer", "Exclusion", "Exclusion")
  x <- c("con_0002.nii", "con_0002.nii", "con_0012.nii", "con_0012.nii", "con_0022.nii", "con_0022.nii")
  dACC_diff_go_stop_wide_1$context <- x

  
#plot by group
  ggplot(dACC_contextXGroupXPerGo, aes(fill=Group, y=mean, x=con_num)) + 
  geom_bar(position="dodge", stat="identity") +
  geom_errorbar(aes(ymin=mean-std.error, ymax=mean+std.error), width=.2,
                 position=position_dodge(.9)) +
  scale_x_discrete(breaks=c("con_0002.nii", "con_0003.nii", "con_0012.nii", "con_0013.nii",  "con_0022.nii", "con_0023.nii"),
                   labels=c("DG_Alone", "DS_Alone", "DG_Inclusion", "DS_Inclusion", "DG_Exclusion", "DS_Exclusion")) +
  geom_point(data = dACC_diff_go_stop_wide_1, aes(x=context, y=mean_dACC), show.legend = TRUE) +
  facet_grid(.~Group, scales='free') +
  labs(x= "Social Context", y = "mean Beta dACC ContextXGroupxPercentGo")
  scale_fill_brewer(palette="Paired") + theme_minimal()
  
```


#NacC --CONTEXTxGROUPxBEHAV
```{r}

NacC_contextXGroupXPerGo <-all_rois_group %>%
  filter(ROI_name=="VS_contextXGroupXPerGo_mask_0005", Decision != "Decision") %>%
  group_by(Group, con_num, Decision, context) %>%
  summarise_at(vars(ROI_mean), funs(mean, std.error), na.rm=TRUE) 

  
#looking difference stop and go
  diff_NacC_contextXGroupXPerGo <- NacC_contextXGroupXPerGo[,-c(2,6)] %>%
    unite(Decision_context, context, Decision) %>%
    spread(Decision_context, mean) 
  
  NacC_diff_go_stop <- diff_NacC_contextXGroupXPerGo %>%
    group_by(Group) %>%
    mutate(Alonediff = Alone_Decision_Go- Alone_Decision_Stop, Peerdiff =Peer_Decision_Go- Peer_Decision_Stop, Excldiff = Exclusion_Decision_Go-Exclusion_Decision_Stop)
  
  NacC_diff_go_stop_wide <- NacC_diff_go_stop %>%
    gather(key = "Decision", value = "mean_NacC", Alone_Decision_Go:Excldiff)
  
  NacC_diff_go_stop_wide_1 <- NacC_diff_go_stop_wide %>%
    filter(Decision == "Alonediff"| Decision == "Peerdiff"| Decision == "Excldiff") 
  
  # x <- c("Alone", "Alone", "Peer", "Peer", "Exclusion", "Exclusion")
  x <- c("con_0002.nii", "con_0002.nii", "con_0012.nii", "con_0012.nii", "con_0022.nii", "con_0022.nii")
  NacC_diff_go_stop_wide_1$context <- x

  
#plot by group
  ggplot(NacC_contextXGroupXPerGo, aes(fill=Group, y=mean, x=con_num)) + 
  geom_bar(position="dodge", stat="identity") +
  geom_errorbar(aes(ymin=mean-std.error, ymax=mean+std.error), width=.2,
                 position=position_dodge(.9)) +
  scale_x_discrete(breaks=c("con_0002.nii", "con_0003.nii", "con_0012.nii", "con_0013.nii",  "con_0022.nii", "con_0023.nii"),
                   labels=c("DG_Alone", "DS_Alone", "DG_Inclusion", "DS_Inclusion", "DG_Exclusion", "DS_Exclusion")) +
  geom_point(data = NacC_diff_go_stop_wide_1, aes(x=context, y=mean_NacC), show.legend = TRUE) +
  facet_grid(.~Group, scales='free') +
  labs(x= "Social Context", y = "mean Beta NacC ContextXGroupxPercentGo")
  scale_fill_brewer(palette="Paired") + theme_minimal()
  
```

#r pars opercu --CONTEXTxGROUPxBEHAV
```{r}

ParOperc_contextXGroupXPerGo <-all_rois_group %>%
  filter(ROI_name=="r_pars_opercu_contextXGroupXPerGo_mask_0010", Decision != "Decision") %>%
  group_by(Group, con_num, Decision, context) %>%
  summarise_at(vars(ROI_mean), funs(mean, std.error), na.rm=TRUE) 

  
#looking difference stop and go
  diff_ParOperc_contextXGroupXPerGo <- ParOperc_contextXGroupXPerGo[,-c(2,6)] %>%
    unite(Decision_context, context, Decision) %>%
    spread(Decision_context, mean) 
  
  ParOperc_diff_go_stop <- diff_ParOperc_contextXGroupXPerGo %>%
    group_by(Group) %>%
    mutate(Alonediff = Alone_Decision_Go- Alone_Decision_Stop, Peerdiff =Peer_Decision_Go- Peer_Decision_Stop, Excldiff = Exclusion_Decision_Go-Exclusion_Decision_Stop)
  
  ParOperc_diff_go_stop_wide <- ParOperc_diff_go_stop %>%
    gather(key = "Decision", value = "mean_ParOperc", Alone_Decision_Go:Excldiff)
  
  ParOperc_diff_go_stop_wide_1 <- ParOperc_diff_go_stop_wide %>%
    filter(Decision == "Alonediff"| Decision == "Peerdiff"| Decision == "Excldiff") 
  
   # x <- c("Alone", "Alone", "Peer", "Peer", "Exclusion", "Exclusion")
  x <- c("con_0002.nii", "con_0002.nii", "con_0012.nii", "con_0012.nii", "con_0022.nii", "con_0022.nii")
  
  ParOperc_diff_go_stop_wide_1$context <- x
  
#plot by group
ggplot(ParOperc_contextXGroupXPerGo, aes(fill=Group, y=mean, x=con_num)) + 
  geom_bar(position="dodge", stat="identity") +
  geom_errorbar(aes(ymin=mean-std.error, ymax=mean+std.error), width=.2,
                 position=position_dodge(.9)) +
  scale_x_discrete(breaks=c("con_0002.nii", "con_0003.nii", "con_0012.nii", "con_0013.nii",  "con_0022.nii", "con_0023.nii"),
                   labels=c("DG_Alone", "DS_Alone", "DG_Inclusion", "DS_Inclusion", "DG_Exclusion", "DS_Exclusion")) +
  geom_point(data = ParOperc_diff_go_stop_wide_1, aes(x=context, y=mean_ParOperc), show.legend = TRUE) +
  facet_grid(.~Group, scales='free') +
  labs(x= "Social Context", y = "mean Beta ParOperc ContextXGroupxPercentGo")
  scale_fill_brewer(palette="Paired") + theme_minimal()
  

```

#r postcentral gyrus --CONTEXTxGROUPxBEHAV
```{r}

postcentral_contextXGroupXPerGo <-all_rois_group %>%
  filter(ROI_name=="r_postcentral_gyrus_contextXGroupXPerGo_mask_0013", Decision != "Decision") %>%
  group_by(Group, con_num, Decision, context) %>%
  summarise_at(vars(ROI_mean), funs(mean, std.error), na.rm=TRUE) 

  
#looking difference stop and go
  diff_postcentral_contextXGroupXPerGo <- postcentral_contextXGroupXPerGo[,-c(2,6)] %>%
    unite(Decision_context, context, Decision) %>%
    spread(Decision_context, mean) 
  
  postcentral_diff_go_stop <- diff_postcentral_contextXGroupXPerGo %>%
    group_by(Group) %>%
    mutate(Alonediff = Alone_Decision_Go- Alone_Decision_Stop, Peerdiff =Peer_Decision_Go- Peer_Decision_Stop, Excldiff = Exclusion_Decision_Go-Exclusion_Decision_Stop)
  
  postcentral_diff_go_stop_wide <- postcentral_diff_go_stop %>%
    gather(key = "Decision", value = "mean_postcentral", Alone_Decision_Go:Excldiff)
  
  postcentral_diff_go_stop_wide_1 <- postcentral_diff_go_stop_wide %>%
    filter(Decision == "Alonediff"| Decision == "Peerdiff"| Decision == "Excldiff") 
  
   # x <- c("Alone", "Alone", "Peer", "Peer", "Exclusion", "Exclusion")
  x <- c("con_0002.nii", "con_0002.nii", "con_0012.nii", "con_0012.nii", "con_0022.nii", "con_0022.nii")
  
  postcentral_diff_go_stop_wide_1$context <- x
  

#plot per group
ggplot(postcentral_contextXGroupXPerGo, aes(fill=Group, y=mean, x=con_num)) + 
  geom_bar(position="dodge", stat="identity") +
  geom_errorbar(aes(ymin=mean-std.error, ymax=mean+std.error), width=.2,
                 position=position_dodge(.9)) +
  scale_x_discrete(breaks=c("con_0002.nii", "con_0003.nii", "con_0012.nii", "con_0013.nii",  "con_0022.nii", "con_0023.nii"),
                   labels=c("DG_Alone", "DS_Alone", "DG_Inclusion", "DS_Inclusion", "DG_Exclusion", "DS_Exclusion")) +
  geom_point(data = postcentral_diff_go_stop_wide_1, aes(x=context, y=mean_postcentral), show.legend = TRUE) +
  facet_grid(.~Group, scales='free') +
  labs(x= "Social Context", y = "mean Beta postcentral ContextXGroupxPercentGo")
  scale_fill_brewer(palette="Paired") + theme_minimal()
  
  
```


#l anterior insula --COMM DECSIONxBEHAV
```{r}

Lant_insula_contextXGroupXPerGo <-all_rois_group %>%
  filter(ROI_name=="l_anterior_insula_TDS2_DecxPerGo_mask_0003", Decision != "Decision") %>%
  group_by(Group, con_num, Decision, context) %>%
  summarise_at(vars(ROI_mean), funs(mean, std.error), na.rm=TRUE) 

  
#looking difference stop and go
  diff_Lant_insula_contextXGroupXPerGo <- Lant_insula_contextXGroupXPerGo[,-c(2,6)] %>%
    unite(Decision_context, context, Decision) %>%
    spread(Decision_context, mean) 
  
  Lant_insula_diff_go_stop <- diff_Lant_insula_contextXGroupXPerGo %>%
    group_by(Group) %>%
    mutate(Alonediff = Alone_Decision_Go- Alone_Decision_Stop, Peerdiff =Peer_Decision_Go- Peer_Decision_Stop, Excldiff = Exclusion_Decision_Go-Exclusion_Decision_Stop)
  
  Lant_insula_diff_go_stop_wide <- Lant_insula_diff_go_stop %>%
    gather(key = "Decision", value = "mean_Lant_insula", Alone_Decision_Go:Excldiff)
  
  Lant_insula_diff_go_stop_wide_1 <- Lant_insula_diff_go_stop_wide %>%
    filter(Decision == "Alonediff"| Decision == "Peerdiff"| Decision == "Excldiff") 
  
  # x <- c("Alone", "Alone", "Peer", "Peer", "Exclusion", "Exclusion")
  x <- c("con_0002.nii", "con_0002.nii", "con_0012.nii", "con_0012.nii", "con_0022.nii", "con_0022.nii")
  
  Lant_insula_diff_go_stop_wide_1$context <- x
  

#plot by group
ggplot(Lant_insula_contextXGroupXPerGo, aes(fill=Group, y=mean, x=con_num)) + 
  geom_bar(position="dodge", stat="identity") +
  geom_errorbar(aes(ymin=mean-std.error, ymax=mean+std.error), width=.2,
                 position=position_dodge(.9)) +
  scale_x_discrete(breaks=c("con_0002.nii", "con_0003.nii", "con_0012.nii", "con_0013.nii",  "con_0022.nii", "con_0023.nii"),
                   labels=c("DG_Alone", "DS_Alone", "DG_Inclusion", "DS_Inclusion", "DG_Exclusion", "DS_Exclusion")) +
  geom_point(data = Lant_insula_diff_go_stop_wide_1, aes(x=context, y=mean_Lant_insula), show.legend = TRUE) +
  facet_grid(.~Group, scales='free') +
  labs(x= "Social Context", y = "mean Beta Lant_insula COMM DecXPercentGo")
  scale_fill_brewer(palette="Paired") + theme_minimal()
  

```

#R anterior insula --COMM DECSIONxBEHAV
```{r}

Rant_insula_contextXGroupXPerGo <-all_rois_group %>%
  filter(ROI_name=="r_anterior_insula_TDS2_DecxPerGo_mask_0002", Decision != "Decision") %>%
  group_by(Group, con_num, Decision, context) %>%
  summarise_at(vars(ROI_mean), funs(mean, std.error), na.rm=TRUE) 

  
#looking difference stop and go
  diff_Rant_insula_contextXGroupXPerGo <- Rant_insula_contextXGroupXPerGo[,-c(2,6)] %>%
    unite(Decision_context, context, Decision) %>%
    spread(Decision_context, mean) 
  
  Rant_insula_diff_go_stop <- diff_Rant_insula_contextXGroupXPerGo %>%
    group_by(Group) %>%
    mutate(Alonediff = Alone_Decision_Go- Alone_Decision_Stop, Peerdiff =Peer_Decision_Go- Peer_Decision_Stop, Excldiff = Exclusion_Decision_Go-Exclusion_Decision_Stop)
  
  Rant_insula_diff_go_stop_wide <- Rant_insula_diff_go_stop %>%
    gather(key = "Decision", value = "mean_Rant_insula", Alone_Decision_Go:Excldiff)
  
  Rant_insula_diff_go_stop_wide_1 <- Rant_insula_diff_go_stop_wide %>%
    filter(Decision == "Alonediff"| Decision == "Peerdiff"| Decision == "Excldiff") 
  
  # x <- c("Alone", "Alone", "Peer", "Peer", "Exclusion", "Exclusion")
  x <- c("con_0002.nii", "con_0002.nii", "con_0012.nii", "con_0012.nii", "con_0022.nii", "con_0022.nii")
  
  Rant_insula_diff_go_stop_wide_1$context <- x
  

#plot by group
ggplot(Rant_insula_contextXGroupXPerGo, aes(fill=Group, y=mean, x=con_num)) + 
  geom_bar(position="dodge", stat="identity") +
  geom_errorbar(aes(ymin=mean-std.error, ymax=mean+std.error), width=.2,
                 position=position_dodge(.9)) +
  scale_x_discrete(breaks=c("con_0002.nii", "con_0003.nii", "con_0012.nii", "con_0013.nii",  "con_0022.nii", "con_0023.nii"),
                   labels=c("DG_Alone", "DS_Alone", "DG_Inclusion", "DS_Inclusion", "DG_Exclusion", "DS_Exclusion")) +
  geom_point(data = Rant_insula_diff_go_stop_wide_1, aes(x=context, y=mean_Rant_insula), show.legend = TRUE) +
  facet_grid(.~Group, scales='free') +
  labs(x= "Social Context", y = "mean Beta Rant_insula COMM DecXPercentGo")
  scale_fill_brewer(palette="Paired") + theme_minimal()


```


#r STG --GROUPxEXCLUSION specific 
```{r}

rSTG_contextXGroupXPerGo <-all_rois_group %>%
  filter(ROI_name=="r_STG_D_SEspecifcXGroup_mask_0002", Decision != "Decision") %>%
  group_by(Group, con_num, Decision, context) %>%
  summarise_at(vars(ROI_mean), funs(mean, std.error), na.rm=TRUE) 

  
#looking difference stop and go
  diff_rSTG_contextXGroupXPerGo <- rSTG_contextXGroupXPerGo[,-c(2,6)] %>%
    unite(Decision_context, context, Decision) %>%
    spread(Decision_context, mean) 
  
  rSTG_diff_go_stop <- diff_rSTG_contextXGroupXPerGo %>%
    group_by(Group) %>%
    mutate(Alonediff = Alone_Decision_Go- Alone_Decision_Stop, Peerdiff =Peer_Decision_Go- Peer_Decision_Stop, Excldiff = Exclusion_Decision_Go-Exclusion_Decision_Stop)
  
  rSTG_diff_go_stop_wide <- rSTG_diff_go_stop %>%
    gather(key = "Decision", value = "mean_rSTG", Alone_Decision_Go:Excldiff)
  
  rSTG_diff_go_stop_wide_1 <- rSTG_diff_go_stop_wide %>%
    filter(Decision == "Alonediff"| Decision == "Peerdiff"| Decision == "Excldiff") 
  
  # x <- c("Alone", "Alone", "Peer", "Peer", "Exclusion", "Exclusion")
  x <- c("con_0002.nii", "con_0002.nii", "con_0012.nii", "con_0012.nii", "con_0022.nii", "con_0022.nii")
  
  rSTG_diff_go_stop_wide_1$context <- x
  

#plot by group
ggplot(rSTG_contextXGroupXPerGo, aes(fill=Group, y=mean, x=con_num)) + 
  geom_bar(position="dodge", stat="identity") +
  geom_errorbar(aes(ymin=mean-std.error, ymax=mean+std.error), width=.2,
                 position=position_dodge(.9)) +
  scale_x_discrete(breaks=c("con_0002.nii", "con_0003.nii", "con_0012.nii", "con_0013.nii",  "con_0022.nii", "con_0023.nii"),
                   labels=c("DG_Alone", "DS_Alone", "DG_Inclusion", "DS_Inclusion", "DG_Exclusion", "DS_Exclusion")) +
  geom_point(data = rSTG_diff_go_stop_wide_1, aes(x=context, y=mean_rSTG), show.legend = TRUE) +
  facet_grid(.~Group, scales='free') +
  labs(x= "Social Context", y = "mean Beta rSTG GROUPxEXCLUSION specific")
  scale_fill_brewer(palette="Paired") + theme_minimal()
  #plot by context
  ggplot(rSTG_contextXGroupXPerGo, aes(fill=Group, y=mean, x=con_num)) + 
  geom_bar(position="dodge", stat="identity") +
  geom_errorbar(aes(ymin=mean-std.error, ymax=mean+std.error), width=.2,
                 position=position_dodge(.9)) +
  scale_x_discrete(breaks=c("con_0002.nii", "con_0003.nii", "con_0012.nii", "con_0013.nii",  "con_0022.nii", "con_0023.nii"),
                   labels=c("DG_Alone", "DS_Alone", "DG_Inclusion", "DS_Inclusion", "DG_Exclusion", "DS_Exclusion")) +
  geom_point(data = rSTG_diff_go_stop_wide_1, aes(x=context, y=mean_rSTG_diff, colour=Group), show.legend = TRUE) +
  facet_grid(.~context, scales='free') +
  labs(x= "Social Context", y = "mean Beta rSTG GROUPxEXCLUSION specific")
  scale_fill_brewer(palette="Paired") + theme_minimal()

  #plot by decision
    ggplot(rSTG_contextXGroupXPerGo, aes(fill=Group, y=mean, x=con_num)) + 
  geom_bar(position="dodge", stat="identity") +
  geom_errorbar(aes(ymin=mean-std.error, ymax=mean+std.error), width=.2,
                 position=position_dodge(.9)) +
  scale_x_discrete(breaks=c("con_0002.nii", "con_0003.nii", "con_0012.nii", "con_0013.nii",  "con_0022.nii", "con_0023.nii"),
                   labels=c("DG_Alone", "DS_Alone", "DG_Inclusion", "DS_Inclusion", "DG_Exclusion", "DS_Exclusion")) +
  geom_point(data = rSTG_diff_go_stop_wide_1, aes(x=context, y=mean_rSTG_diff, colour=Group), show.legend = TRUE) +
  facet_grid(.~Decision, scales='free') +
  labs(x= "Social Context", y = "mean Beta rSTG GROUPxEXCLUSION specific")
  scale_fill_brewer(palette="Paired") + theme_minimal()
```


#lpSTS TPJ-- GROUPxEXCLUSION specific 
```{r}

pSTS_contextXGroupXPerGo <-all_rois_group %>%
  filter(ROI_name=="l_pSTS_TPJ_D_SEspecifcXGroup_mask_0001", Decision != "Decision") %>%
  group_by(Group, con_num, Decision, context) %>%
  summarise_at(vars(ROI_mean), funs(mean, std.error), na.rm=TRUE) 

  
#looking difference stop and go
  diff_pSTS_contextXGroupXPerGo <- pSTS_contextXGroupXPerGo[,-c(2,6)] %>%
    unite(Decision_context, context, Decision) %>%
    spread(Decision_context, mean) 
  
  pSTS_diff_go_stop <- diff_pSTS_contextXGroupXPerGo %>%
    group_by(Group) %>%
    mutate(Alonediff = Alone_Decision_Go- Alone_Decision_Stop, Peerdiff =Peer_Decision_Go- Peer_Decision_Stop, Excldiff = Exclusion_Decision_Go-Exclusion_Decision_Stop)
  
  pSTS_diff_go_stop_wide <- pSTS_diff_go_stop %>%
    gather(key = "Decision", value = "mean_pSTS", Alone_Decision_Go:Excldiff)
  
  pSTS_diff_go_stop_wide_1 <- pSTS_diff_go_stop_wide %>%
    filter(Decision == "Alonediff"| Decision == "Peerdiff"| Decision == "Excldiff") 
  
  # x <- c("Alone", "Alone", "Peer", "Peer", "Exclusion", "Exclusion")
  x <- c("con_0002.nii", "con_0002.nii", "con_0012.nii", "con_0012.nii", "con_0022.nii", "con_0022.nii")
  
  pSTS_diff_go_stop_wide_1$context <- x
  

#plot by group
ggplot(pSTS_contextXGroupXPerGo, aes(fill=Group, y=mean, x=con_num)) + 
  geom_bar(position="dodge", stat="identity") +
  geom_errorbar(aes(ymin=mean-std.error, ymax=mean+std.error), width=.2,
                 position=position_dodge(.9)) +
  scale_x_discrete(breaks=c("con_0002.nii", "con_0003.nii", "con_0012.nii", "con_0013.nii",  "con_0022.nii", "con_0023.nii"),
                   labels=c("DG_Alone", "DS_Alone", "DG_Inclusion", "DS_Inclusion", "DG_Exclusion", "DS_Exclusion")) +
  geom_point(data = pSTS_diff_go_stop_wide_1, aes(x=context, y=mean_pSTS), show.legend = TRUE) +
  facet_grid(.~Group, scales='free') +
  labs(x= "Social Context", y = "mean Beta pSTS GROUPxEXCLUSION specific")
  scale_fill_brewer(palette="Paired") + theme_minimal()


```


##if we do RWR with ROI template##
```{r}
#see link Nacc with rwr
null.model <- glmer(RPI_part2_rpi_mean_score ~ Nacc + (1|SID), data=df_RWR_fMRI)
main.model <- glmer(RPI_part2_rpi_mean_score ~ Nacc + condition + (1|SID), data=df_RWR_fMRI)
interaction.model <- glmer(RPI_part2_rpi_mean_score ~ Nacc*condition + (1|SID), data=df_RWR_fMRI)
anova(null.model, main.model)
anova(null.model, interaction.model)
summary(null.model)

null.model <- glmer(NTS_total_score_score ~ Nacc + (1|SID), data=df_RWR_fMRI)
main.model <- glmer(NTS_total_score_score ~ Nacc + condition + (1|SID), data=df_RWR_fMRI)
interaction.model <- glmer(NTS_total_score_score ~ Nacc*condition + (1|SID), data=df_RWR_fMRI)
anova(null.model, main.model)
anova(null.model, interaction.model)
summary(null.model)
```

####################################################################################################
SUPPLEMENTAL 
####################################################################################################



####################################################################################
## CWI GENDER EFFECTS ##
####################################################################################
```{r}
null.model <- glmer(stop ~ condition  + (1|scores.SID), data=df_fMRI_all, family='binomial')
main.model <- glmer(stop ~ condition*gender +  (1|scores.SID), data=df_fMRI_all, family='binomial', control=glmerControl(optimizer="bobyqa"))


anova(null.model, main.model)
# null.model: stop ~ condition + (1 | scores.SID)
# main.model: stop ~ condition * gender + (1 | scores.SID)
#            Df   AIC   BIC  logLik deviance  Chisq Chi Df Pr(>Chisq)  
# null.model  4 10627 10655 -5309.6    10619                           
# main.model  7 10625 10674 -5305.3    10611 8.6389      3     0.0345 *


summary(main.model)
# Random effects:
#  Groups     Name        Variance Std.Dev.
#  scores.SID (Intercept) 0.4817   0.694   
# Number of obs: 8180, groups:  scores.SID, 69
# 
# Fixed effects:
#                     Estimate Std. Error z value Pr(>|z|)  
# (Intercept)         0.295985   0.121981   2.426   0.0152 *
# condition4          0.013972   0.075475   0.185   0.8531  
# condition3          0.016635   0.074407   0.224   0.8231  
# gender1             0.016216   0.187988   0.086   0.9313  
# condition4:gender1  0.290627   0.116978   2.484   0.0130 *
# condition3:gender1 -0.005231   0.114585  -0.046   0.9636 
```

#############################################
## FIGURE CWI Crashs Decision by Gender ##
#############################################
```{r}
# Part B: Crashes
crashes <- df_fMRI_all %>% distinct(scores.SID, gender_flip, condition, crash_count)


plot.crashes <- crashes %>% group_by(gender_flip, condition) %>%
  summarize(mean = mean(crash_count), sd = sd(crash_count), n = n(), se = sd/sqrt(n), ci=qt(0.975, df=n-1)*se)

#sex differences in crashes
ggplot(plot.crashes, aes(x = condition, y = mean, color=gender_flip)) +
  geom_point(position=position_dodge(.1), size=3) +
  geom_line(aes(group=gender_flip), size=1) +
  # geom_errorbar(aes(ymax=mean + ci, ymin=mean - ci), width=0.5, position=position_dodge(.2)) +
  # facet_grid(.~condition, scales='free', labeller=as_labeller(condition_labels)) +
  labs(x='Condition', y='Crashes', color='Sex') +
  scale_y_continuous(breaks = c(3, 4, 5))

```

#############################################
## FIGURE CWI Stop Decision by Gender ##
#############################################
```{r}
# Part C: Stops
stops <- df_fMRI_all %>% distinct(scores.SID, gender_flip, condition, stop)


plot.stops <- stops %>% group_by(gender_flip, condition) %>%
  summarize(mean = mean(stop), sd = sd(stop), n = n(), se = sd/sqrt(n), ci=qt(0.975, df=n-1)*se)

#gender differences in stop decisions
ggplot(plot.stops, aes(x = condition, y = mean, color=gender_flip)) +
  geom_point(position=position_dodge(.1), size=3) +
  geom_line(aes(group=gender_flip), size=1) +
  # geom_errorbar(aes(ymax=mean + ci, ymin=mean - ci), width=0.5, position=position_dodge(.2)) +
  # facet_grid(.~condition, scales='free', labeller=as_labeller(condition_labels)) +
  labs(x='Social Context', y='Stop', color='Sex') +
  scale_y_continuous(breaks = c(3, 4, 5))
```


#############################################################################################
## COMM Supplemental Tables   ##
#Within COMM, no difference in age X sex or iq X sex. 
#There was an expected difference in puberty by sex, such that females has a significantly higher pubertal #score.
#############################################################################################
```{r}

TDS2_age_by_sex<-demo_data_TDS2 %>% filter(!is.na(s2_age)) %>% group_by(gender)%>%
  summarize(mean = mean(s2_age, na.rm=T), sd = sd(s2_age, na.rm=T), 
            min = min(s2_age, na.rm=T), max = max(s2_age, na.rm=T),
            n = n(), se = sd/sqrt(n), ci=qt(0.975, df=n-1)*se) 
t.test(demo_data_TDS2$s2_age~demo_data_TDS2$gender) 

# t = -0.43967, df = 67.653, p-value = 0.6616
# alternative hypothesis: true difference in means is not equal to 0
# 95 percent confidence interval:
#  -0.8864616  0.5663797
# sample estimates:
# mean in group 0 mean in group 1 
#        14.05212        14.21216 

TDS2_iq_by_sex<-demo_data_TDS2 %>% filter(!is.na(s2_iq)) %>% group_by(gender) %>%
  summarize(mean = mean(s2_iq, na.rm=T), sd = sd(s2_iq, na.rm=T), 
            min = min(s2_iq, na.rm=T), max = max(s2_iq, na.rm=T),
            n = n(), se = sd/sqrt(n), ci=qt(0.975, df=n-1)*se)
t.test(demo_data_TDS2$s2_iq~demo_data_TDS2$gender) 

# t = -0.74177, df = 67.989, p-value = 0.4608
# alternative hypothesis: true difference in means is not equal to 0
# 95 percent confidence interval:
#  -7.609971  3.485483
# sample estimates:
# mean in group 0 mean in group 1 
#        106.4242        108.4865 

TDS2_pds_by_sex<-demo_TDS2 %>% filter(!is.na(PDS_mean_score)) %>% group_by(gender) %>%
  summarize(mean = mean(PDS_mean_score, na.rm=T), sd = sd(PDS_mean_score, na.rm=T),
            min = min(PDS_mean_score, na.rm=T), max = max(PDS_mean_score, na.rm=T),
            n = n(), se = sd/sqrt(n), ci=qt(0.975, df=n-1)*se)
t.test(demo_TDS2$PDS_mean_score~demo_TDS2$gender) 

# t = -4.6755, df = 65.396, p-value = 1.514e-05
# alternative hypothesis: true difference in means is not equal to 0
# 95 percent confidence interval:
#  -0.9991348 -0.4010977
# sample estimates:
# mean in group 0 mean in group 1 
#        2.454839        3.154955 
```


########################################
## COMM SUPPLEMENTARY FIGURE ##
plots of age by gender & puberty by age
########################################
```{r}
# Part A: Gender by age distribution
fig_s1a_TDS2 <- ggplot(demo_TDS2, aes(x = age_rnd, fill = gender_flip)) +
  geom_bar(position = 'dodge') +
  #facet_grid(.~tds_group, scales='free', labeller=as_labeller(group_labels)) +
  labs(x='Age', y='Number of participants', fill='Sex') +
  coord_cartesian(x=c(10.5,17.5)) + theme(text = element_text(size=16)) +
  scale_y_continuous(breaks = c(0, 2, 4, 6, 8, 10)) + scale_x_continuous(breaks = 11:17) 
ggsave('fig_s1a.png', fig_s1a)

# Part B: Gender by pubertal stage distribution
fig_s1b_TDS2 <- ggplot(demo_TDS2, aes(x = PDS_stage, fill = gender_flip)) +
  geom_bar(position = 'dodge') +
  #facet_grid(.~tds_group, scales='free', labeller=as_labeller(group_labels)) +
  labs(x='Mean PDS score', y='Number of participants', fill='Sex') +
  theme(text = element_text(size=16)) +
  scale_y_continuous(breaks = c(0, 4, 8, 12, 16, 20, 24, 28)) + scale_x_continuous(breaks = c(1, 2, 3, 4))
ggsave('fig_s1b.png', fig_s1b)
```



#############################################################################################
## CWI Supplemental Tables   ##
#Within CWI, no difference in age x sex or iq by sex. 
#There was an expected difference in puberty by sex, such that females has a significantly higher pubertal #score.
#############################################################################################

```{r}

TDS1_age_by_sex<-demo_filtered_context %>% filter(!is.na(s2_age)) %>% group_by(gender)%>%
  summarize(mean = mean(s2_age, na.rm=T), sd = sd(s2_age, na.rm=T), 
            min = min(s2_age, na.rm=T), max = max(s2_age, na.rm=T),
            n = n(), se = sd/sqrt(n), ci=qt(0.975, df=n-1)*se) 
t.test(demo_filtered_context$s2_age~demo_filtered_context$gender) 

# t = -1.3229, df = 53.951, p-value = 0.1915
# alternative hypothesis: true difference in means is not equal to 0
# 95 percent confidence interval:
#  -1.4034873  0.2876425
# sample estimates:
# mean in group 0 mean in group 1 
#        13.86725        14.42517 

TDS1_iq_by_sex<-demo_filtered_context %>% filter(!is.na(s2_iq)) %>% group_by(gender) %>%
  summarize(mean = mean(s2_iq, na.rm=T), sd = sd(s2_iq, na.rm=T), 
            min = min(s2_iq, na.rm=T), max = max(s2_iq, na.rm=T),
            n = n(), se = sd/sqrt(n), ci=qt(0.975, df=n-1)*se)
t.test(demo_filtered_context$s2_iq~demo_filtered_context$gender) 

# t = -0.27452, df = 49.725, p-value = 0.7848
# alternative hypothesis: true difference in means is not equal to 0
# 95 percent confidence interval:
#  -7.683712  5.836162
# sample estimates:
# mean in group 0 mean in group 1 
#        99.42105       100.34483 

TDS1_pds_by_sex<-demo_filtered_context %>% filter(!is.na(PDS_mean_score)) %>% group_by(gender) %>%
  summarize(mean = mean(PDS_mean_score, na.rm=T), sd = sd(PDS_mean_score, na.rm=T),
            min = min(PDS_mean_score, na.rm=T), max = max(PDS_mean_score, na.rm=T),
            n = n(), se = sd/sqrt(n), ci=qt(0.975, df=n-1)*se)
t.test(demo_filtered_context$PDS_mean_score~demo_filtered_context$gender) 

# t = -2.5333, df = 40.516, p-value = 0.01527
# alternative hypothesis: true difference in means is not equal to 0
# 95 percent confidence interval:
#  -0.8992840 -0.1013113
# sample estimates:
# mean in group 0 mean in group 1 
#        2.518750        3.019048 

```



#########################################
## TDS1 SUPPLEMENTARY FIGURES ##
plots of age by gender & puberty by age
#########################################

```{r}
# Part A: Gender by age distribution
fig_s1a <- ggplot(demo_filtered_context, aes(x = age_rnd, fill = gender_flip)) +
  geom_bar(position = 'dodge') +
  #facet_grid(.~tds_group, scales='free', labeller=as_labeller(group_labels)) +
  labs(x='Age', y='Number of participants', fill='Sex') +
  coord_cartesian(x=c(10.5,17.5)) + theme(text = element_text(size=16)) +
  scale_y_continuous(breaks = c(0, 2, 4, 6, 8, 10)) + scale_x_continuous(breaks = 11:17) 
ggsave('fig_s1a.png', fig_s1a)

# Part B: Gender by pubertal stage distribution
fig_s1b <- ggplot(demo_filtered_context, aes(x = PDS_stage, fill = gender_flip)) +
  geom_bar(position = 'dodge') +
  #facet_grid(.~tds_group, scales='free', labeller=as_labeller(group_labels)) +
  labs(x='Mean PDS score', y='Number of participants', fill='Sex') +
  theme(text = element_text(size=16)) +
  scale_y_continuous(breaks = c(0, 4, 8, 12, 16, 20, 24, 28)) + scale_x_continuous(breaks = c(1, 2, 3, 4))
ggsave('fig_s1b.png', fig_s1b)
```



##############################################
# SETUP GROUP TASK CORRELATIONS RISK WITH RWB
##############################################
```{r}

# qualtrics data
RPI_TDS2 <- read.csv(paste(qualtrics_folder,'scoring_script_output/tds2-wave1-RPI_part2.csv', sep='') ) %>% filter(!scores.SID > 300)
NTS_TDS2 <- read.csv(paste(qualtrics_folder,'scoring_script_output/tds2-wave1-NTS.csv' , sep='')) %>% filter(!scores.SID > 300)                            
ACES_TDS2 <- read.csv(paste(qualtrics_folder,'scoring_script_output/tds2-wave1-ACE.csv' , sep=''))   %>% filter(!scores.SID > 300)                            


# merge qualtrics data
qualtrics_merge1_TDS2<- left_join(RPI_TDS2, NTS_TDS2, by = 'scores.SID') %>% select(scores.SID, scores.rpi_mean, scores.total_score)

qualtrics_data_TDS2ace<- ACES_TDS2 %>% 
  select(scores.SID, scores.ace_total)

RWR_qualtrics_data_TDS2<-left_join(qualtrics_merge1_TDS2, qualtrics_data_TDS2ace, by = 'scores.SID')



no_session2 = c(118, 123, 147, 148, 149, 153, 154, 166, 180)
behaviorals = c(103, 107, 112, 138, 143, 176, 191)
pilot_cyberball = c(101, 102, 104, 105, 106, 108, 110, 111)
motion_dropout = c(189, 158, 139)

RWR_filtered_TDS2 <- RWR_qualtrics_data_TDS2 %>% filter(scores.SID < 300) %>% 
  filter(!scores.SID %in% no_session2) %>% 
  filter(!scores.SID %in% behaviorals)%>%
  filter(!scores.SID %in% pilot_cyberball)%>%
  filter(!scores.SID %in% motion_dropout)

# write.csv(RWR_qualtrics_data_TDS2, "RWR_qualtrics_data_TDS2.csv")


df_RWR_fMRI_TDS2 <- left_join(df_fMRI_all_TDS2, RWR_filtered_TDS2, by= "scores.SID")
# write.csv(df_RWR_fMRI_TDS2, "df_RWR_fMRI_TDS2.csv")

#check ranges of variables first
view(dfSummary(df_RWR_fMRI_TDS2))

describe(RWR_filtered_TDS2)
```

####################################################################################
# COMM TASK CORRELATIONS RISK WITH RWB
##
#######################################################################################


##NTS with go task + plot --> no
```{r}
#are risk decisions in the scanner correlated with sensitivity peers?

#dataset for NTS
df_RWR_fMRI_NTS <- df_RWR_fMRI_TDS2 %>% select(scores.total_score, condition, stop, go, scores.SID) 
df_RWR_fMRI_NTS <- na.omit(df_RWR_fMRI_NTS)

null.model <- glmer(go ~  condition + (1|scores.SID), data=df_RWR_fMRI_NTS, family = "binomial", control=glmerControl(optimizer="bobyqa"))
main.model <- glmer(go ~ scores.total_score + condition + (1|scores.SID), data=df_RWR_fMRI_NTS, family = "binomial", control=glmerControl(optimizer="bobyqa"))
interaction.model <- glmer(go ~ scores.total_score*condition + (1|scores.SID), data=df_RWR_fMRI_NTS, family = "binomial", control=glmerControl(optimizer="bobyqa"))
anova(null.model, main.model)
# null.model: go ~ condition + (1 | scores.SID)
# main.model: go ~ scores.total_score + condition + (1 | scores.SID)
#            Df   AIC   BIC  logLik deviance  Chisq Chi Df Pr(>Chisq)
# null.model  4 10677 10705 -5334.7    10669                         
# main.model  5 10678 10713 -5334.1    10668 1.2121      1     0.2709

anova(null.model, interaction.model)
# null.model: go ~ condition + (1 | scores.SID)
# interaction.model: go ~ scores.total_score * condition + (1 | scores.SID)
#                   Df   AIC   BIC  logLik deviance  Chisq Chi Df Pr(>Chisq)  
# null.model         4 10677 10705 -5334.7    10669                           
# interaction.model  7 10676 10725 -5330.9    10662 7.5335      3     0.0567 .


summary(interaction.model)
# Random effects:
#  Groups     Name        Variance Std.Dev.
#  scores.SID (Intercept) 0.366    0.605   
# Number of obs: 8280, groups:  scores.SID, 69
# 
# Fixed effects:
#                                Estimate Std. Error z value Pr(>|z|)  
# (Intercept)                   -0.039636   0.382898  -0.104   0.9176  
# scores.total_score            -0.172791   0.115615  -1.495   0.1350  
# condition3                     0.174934   0.261689   0.668   0.5038  
# condition4                    -0.188452   0.259485  -0.726   0.4677  
# scores.total_score:condition3 -0.004943   0.078917  -0.063   0.9501  
# scores.total_score:condition4  0.166944   0.078160   2.136   0.0327 *


nts_go <- df_RWR_fMRI_NTS %>% distinct(scores.SID, condition, scores.total_score, stop, go)


plot.nts_go <- nts_go %>% group_by(condition) %>%
  summarize(meanGo = mean(go), meanNTS = mean(scores.total_score), sd = sd(go), n = n(), se = sd/sqrt(n), ci=qt(0.975, df=n-1)*se)

ggplot(plot.nts_go, aes(x = meanGo , y = meanNTS, group=condition, color=condition)) +
 geom_point(aes(group =condition)) +
  labs(x='Percent Go ', y='NTS') +
   # facet_grid(.~condition, scales='free', labeller=as_labeller(condition_labels)) +
  theme(text = element_text(size=16)) +
  scale_colour_discrete(labels=condition_labels)

```


##RPI with GO task --> no
```{r}

#dataset for RPI
df_RWR_fMRI_RPI <- df_RWR_fMRI_TDS2 %>% select(scores.rpi_mean, condition, stop, go, scores.SID) 
df_RWR_fMRI_RPI <- na.omit(df_RWR_fMRI_RPI)

null.model <- glmer(go ~  condition + (1|scores.SID), data=df_RWR_fMRI_RPI, family = "binomial", control=glmerControl(optimizer="bobyqa"))
main.model <- glmer(go ~ scores.rpi_mean + condition + (1|scores.SID), data=df_RWR_fMRI_RPI, family = "binomial", control=glmerControl(optimizer="bobyqa"))
interaction.model <- glmer(go ~ scores.rpi_mean*condition + (1|scores.SID), data=df_RWR_fMRI_RPI, family = "binomial", control=glmerControl(optimizer="bobyqa"))
anova(null.model, main.model)
# null.model: go ~ condition + (1 | scores.SID)
# main.model: go ~ scores.rpi_mean + condition + (1 | scores.SID)
#            Df   AIC   BIC  logLik deviance  Chisq Chi Df Pr(>Chisq)
# null.model  4 10811 10839 -5401.6    10803                         
# main.model  5 10812 10848 -5401.2    10802 0.8349      1     0.3609
anova(null.model, interaction.model)
# null.model: go ~ condition + (1 | scores.SID)
# interaction.model: go ~ scores.rpi_mean * condition + (1 | scores.SID)
#                   Df   AIC   BIC  logLik deviance  Chisq Chi Df Pr(>Chisq)
# null.model         4 10811 10839 -5401.6    10803                         
# interaction.model  7 10814 10863 -5399.9    10800 3.5026      3     0.3204
summary(interaction.model)
summary(null.model)
# Random effects:
#  Groups     Name        Variance Std.Dev.
#  scores.SID (Intercept) 0.3761   0.6133  
# Number of obs: 8400, groups:  scores.SID, 70
# 
# Fixed effects:
#             Estimate Std. Error z value Pr(>|z|)    
# (Intercept) -0.61621    0.08401  -7.335 2.22e-13 ***
# condition3   0.17151    0.05715   3.001  0.00269 ** 
# condition4   0.36169    0.05683   6.364 1.97e-10 **

```


#####################################################################
## CWI SETUP Social Context effects on GO DECISIONS W/ RW RISK BEHAVIOR##
#####################################################################
```{r}
# qualtrics data
RPI_TDS1 <- read.csv(paste(qualtrics_folder,'scoring_script_output/tds1-wave1-RPI_part2.csv', sep='') ) %>% filter(!scores.SID < 300)
NTS_TDS1 <- read.csv(paste(qualtrics_folder,'scoring_script_output/tds1-wave1-NTS.csv' , sep='')) %>% filter(!scores.SID < 300)                            
ACES_TDS1 <- read.csv(paste(qualtrics_folder,'scoring_script_output/tds1-wave1-ACE.csv' , sep=''))   %>% filter(!scores.SID < 300)                            


# write.csv(RPI_TDS1, "RPI_TDS1.csv")
# write.csv(NTS_TDS1, "NTS_TDS1.csv")
# write.csv(ACES_TDS1, "ACES_TDS1.csv")
# 
# write.csv(RPI_TDS2, "RPI_TDS2.csv")
# write.csv(NTS_TDS2, "NTS_TDS2.csv")
# write.csv(ACES_TDS2, "ACES_TDS2.csv")

# merge qualtrics data
qualtrics_merge1_TDS1<-left_join(RPI_TDS1, NTS_TDS1, by = 'scores.SID') %>% select(scores.SID, scores.rpi_mean, scores.total_score)

qualtrics_data_TDS1ace<- ACES_TDS1 %>% 
  select(scores.SID, scores.ace_total)

RWR_qualtrics_data_TDS1<-left_join(qualtrics_merge1_TDS1, qualtrics_data_TDS1ace, by = 'scores.SID')

no_session2 = c(311, 338, 358)
behaviorals = c(305, 318, 319)
ylg_failed = c(339, 345)
# write.csv(RWR_qualtrics_data_TDS1, "RWR_qualtrics_data_TDS1.csv")

RWR_filtered_TDS1 <- RWR_qualtrics_data_TDS1 %>% filter(scores.SID > 300) %>% 
  filter(!scores.SID %in% no_session2) %>% 
  filter(!scores.SID %in% behaviorals)%>%
  filter(!scores.SID %in% ylg_failed)


view(dfSummary(RWR_filtered_TDS1))

df_RWR_fMRI_TDS1 <- left_join(df_fMRI_all, RWR_filtered_TDS1, by= "scores.SID")
# write.csv(df_RWR_fMRI_TDS1, file = 'df_RWR_fMRI_TDS1.csv')


```


#######################################################################################
# CWI TASK CORRELATIONS RISK WITH RWB
#-- this is post hoc- but given most interesting behaviors are occurring for stops, 
#not gos- let's see how this associates with our RWR behaviors.-- #
#######################################################################################


##RPI with STOP task --> no (above null)
```{r}

#dataset for RPI
df_RWR_fMRI_RPI <- df_RWR_fMRI_TDS1 %>% select(scores.rpi_mean, condition, stop, go, scores.SID) 
df_RWR_fMRI_RPI <- na.omit(df_RWR_fMRI_RPI)


null.model <- glmer(stop ~  condition + (1|scores.SID), data=df_RWR_fMRI_RPI, family = "binomial", control=glmerControl(optimizer="bobyqa"))
main.model <- glmer(stop ~ scores.rpi_mean + condition + (1|scores.SID), data=df_RWR_fMRI_RPI,  family = "binomial", control=glmerControl(optimizer="bobyqa"))
interaction.model <- glmer(stop ~ scores.rpi_mean*condition + (1|scores.SID), data=df_RWR_fMRI_RPI,  family = "binomial", control=glmerControl(optimizer="bobyqa"))

anova(null.model, main.model)
# null.model: stop ~ condition + (1 | scores.SID)
# main.model: stop ~ scores.rpi_mean + condition + (1 | scores.SID)
#            Df   AIC   BIC  logLik deviance  Chisq Chi Df Pr(>Chisq)
# null.model  4 10627 10655 -5309.6    10619                         
# main.model  5 10629 10664 -5309.3    10619 0.5672      1     0.4514
anova(null.model, interaction.model)
# Models:
# null.model: stop ~ condition + (1 | scores.SID)
# interaction.model: stop ~ scores.rpi_mean * condition + (1 | scores.SID)
#                   Df   AIC   BIC  logLik deviance  Chisq Chi Df Pr(>Chisq)  
# null.model         4 10627 10655 -5309.6    10619                           
# interaction.model  7 10626 10676 -5306.2    10612 6.8177      3    0.07794 .
summary(null.model)
# Number of obs: 8180, groups:  scores.SID, 69
# 
# Fixed effects:
#             Estimate Std. Error z value Pr(>|z|)   
# (Intercept)  0.30274    0.09302   3.255  0.00114 **
# condition3   0.01444    0.05660   0.255  0.79868   
# condition4   0.13517    0.05760   2.347  0.01894 * 

summary(interaction.model)
# Number of obs: 8180, groups:  scores.SID, 69
# 
# Fixed effects:
#                            Estimate Std. Error z value Pr(>|z|)  
# (Intercept)                -0.32925    0.47151  -0.698   0.4850  
# scores.rpi_mean             0.22114    0.16180   1.367   0.1717  
# condition3                  0.70387    0.28706   2.452   0.0142 *
# condition4                  0.35363    0.29027   1.218   0.2231  
# scores.rpi_mean:condition3 -0.24129    0.09849  -2.450   0.0143 *
# scores.rpi_mean:condition4 -0.07665    0.09940  -0.771   0.4406  

```

##NTS --> no
```{r}

#dataset for NTS
df_RWR_fMRI_NTS <- df_RWR_fMRI_TDS1 %>% select(scores.total_score, condition, stop, go, scores.SID) 
df_RWR_fMRI_NTS <- na.omit(df_RWR_fMRI_NTS)


null.model <- glmer(go ~  condition + (1|scores.SID), data=df_RWR_fMRI_NTS, family = "binomial", control=glmerControl(optimizer="bobyqa"))
main.model <- glmer(go ~ scores.total_score + condition + (1|scores.SID), data=df_RWR_fMRI_NTS, family = "binomial", control=glmerControl(optimizer="bobyqa"))
interaction.model <- glmer(go ~ scores.total_score*condition + (1|scores.SID), data=df_RWR_fMRI_NTS, family = "binomial", control=glmerControl(optimizer="bobyqa"))
anova(null.model, main.model)
# null.model: go ~ condition + (1 | scores.SID)
# main.model: go ~ scores.total_score + condition + (1 | scores.SID)
#            Df   AIC   BIC  logLik deviance  Chisq Chi Df Pr(>Chisq)
# null.model  4 10274 10302 -5132.8    10266                         
# main.model  5 10275 10310 -5132.7    10265 0.2996      1     0.5841
anova(null.model, interaction.model)
# null.model: go ~ condition + (1 | scores.SID)
# interaction.model: go ~ scores.total_score * condition + (1 | scores.SID)
#                   Df   AIC   BIC  logLik deviance  Chisq Chi Df Pr(>Chisq)
# null.model         4 10274 10302 -5132.8    10266                         
# interaction.model  7 10277 10326 -5131.7    10263 2.2436      3     0.5234

summary(interaction.model)
```

##ACES --> no
```{r}
#are risk decisions in the scanner correlated with sensitivity peers?

#dataset for NTS
df_RWR_fMRI_ACES <- df_RWR_fMRI_TDS1 %>% select(scores.ace_total, condition, stop, go, scores.SID) 
df_RWR_fMRI_ACES <- na.omit(df_RWR_fMRI_ACES)

null.model <- glmer(stop ~  condition + (1|scores.SID), data=df_RWR_fMRI_ACES, family = "binomial", control=glmerControl(optimizer="bobyqa"))
main.model <- glmer(stop ~ scores.ace_total + condition + (1|scores.SID), data=df_RWR_fMRI_ACES, family = "binomial", control=glmerControl(optimizer="bobyqa"))
interaction.model <- glmer(stop ~ scores.ace_total*condition + (1|scores.SID), data=df_RWR_fMRI_ACES, family = "binomial", control=glmerControl(optimizer="bobyqa"))
anova(null.model, main.model)
# null.model: go ~ condition + (1 | scores.SID)
# main.model: go ~ scores.ace_total + condition + (1 | scores.SID)
#            Df   AIC   BIC  logLik deviance  Chisq Chi Df Pr(>Chisq)
# null.model  4 10274 10302 -5132.8    10266                         
# main.model  5 10275 10310 -5132.7    10265 0.2823      1     0.5952

anova(null.model, interaction.model)
# null.model: go ~ condition + (1 | scores.SID)
# interaction.model: go ~ scores.ace_total * condition + (1 | scores.SID)
#                   Df   AIC   BIC  logLik deviance  Chisq Chi Df Pr(>Chisq)
# null.model         4 10274 10302 -5132.8    10266                         
# interaction.model  7 10279 10328 -5132.3    10265 1.0239      3     0.7955


```


#group join
```{r}
# Remove columns that are not congruent between TDS 1 and TDS 2
df_RWR_fMRI_TDS1$group = NULL

df_RWR_fMRI_TDS_ALL <- rbind(df_RWR_fMRI_TDS1, df_RWR_fMRI_TDS2)

#need group to binary, not character
df_RWR_fMRI_TDS_ALL_bi <- df_RWR_fMRI_TDS_ALL %>% mutate(Group = ifelse(Group == "TDS1", 1, 0))
str(df_RWR_fMRI_TDS_ALL_bi$Group)
df_RWR_fMRI_TDS_ALL_bi$Group <- as.factor(allTDSfMRI_bi$Group)
df_RWR_fMRI_TDS_ALL <- df_RWR_fMRI_TDS_ALL_bi

```

#group differences in questionnaires
```{r}
t.test(scores.total_score ~Group, data =df_RWR_fMRI_TDS_ALL)
# t = -13.636, df = 16325, p-value < 2.2e-16
# alternative hypothesis: true difference in means is not equal to 0
# 95 percent confidence interval:
#  -0.1667010 -0.1247986
# sample estimates:
# mean in group TDS1 mean in group TDS2 
#           3.086464           3.232213 

t.test(scores.ace_total ~Group, data =df_RWR_fMRI_TDS_ALL)
# t = 68.536, df = 13165, p-value < 2.2e-16
# alternative hypothesis: true difference in means is not equal to 0
# 95 percent confidence interval:
#  0.2090710 0.2213819
# sample estimates:
# mean in group TDS1 mean in group TDS2 
#          0.3571312          0.1419048 

t.test(scores.rpi_mean ~Group, data =df_RWR_fMRI_TDS_ALL)
# t = -18.547, df = 15822, p-value < 2.2e-16
# alternative hypothesis: true difference in means is not equal to 0
# 95 percent confidence interval:
#  -0.1671118 -0.1351655
# sample estimates:
# mean in group TDS1 mean in group TDS2 
#           2.864099           3.015238 
```

